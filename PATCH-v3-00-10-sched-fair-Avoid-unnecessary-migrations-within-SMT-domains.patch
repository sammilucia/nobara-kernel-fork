From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 6C1DFC636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:50:51 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229928AbjBGEut (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:50:49 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53272 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229515AbjBGEur (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:47 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C90E3D3
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:45 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745445; x=1707281445;
  h=from:to:cc:subject:date:message-id;
  bh=7GgVi6GPMAG8QUql3A3GPf6CEBkQu2TkL/xf7cGOBbc=;
  b=XWhu1K9W7toK7evthc3s9YCiRyU9PzdlnrxK9aIedxnDKBgHkZmsNBdo
   PvcKvjAGIUofKm7uLx6BsQutbm+ilBwFvocAWnEAH/Ljt6JlGO/3YSRcH
   qaDbb/7m/Ig2iBKYtFJJtLJO85yrvJfuSeMT9ho98AKBSwi8gl8T6Xypy
   fcjl3nlVpgAvCInkwLv9v84uaWQVOryZwVIzMgGFnAC85y1hV+l3wcwI2
   OakzkD/RW8ezvYqHD/n7WMDUhd2YhClizC3CjHCtYTL6/XFAW9RAk38NG
   1RqHx4Uba8lr8m8h9PGajtgKC5poFww09cKlABAwWKAGlYz3tEynkMicM
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415623967"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415623967"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:45 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653775"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653775"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:45 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Subject: [PATCH v3 00/10] sched/fair: Avoid unnecessary migrations within SMT domains
Date:   Mon,  6 Feb 2023 20:58:28 -0800
Message-Id: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hi,

This is v3 of this series. Previous versions can be found here [1] and
here [2]. To avoid duplication, I do not include the cover letter of the
original submission. You can read it in [1].

Changes since v2:

Vincent correctly indicated that I was abusing asym_packing to force load
balances unrelated to CPU priority. The underlying issue is that the
scheduler cannot not handle load balances between SMT and non-SMT cores
correctly. I added several prework patches to fix it... and I removed the
abuse of asym_packing.

Dietmar helped me to realize that there is a better way to check the idle
state of SMT cores. Now I give the task to the scheduler instead of
architecture-specific overrides. I unconditionally obey CPU priorities
at the SMT level. This keeps Power7 happy. At upper levels (i.e., when
balancing load between cores) the scheduler also considers the idle state
of the core in addition to CPU priority. This satisfies x86.

Ionela spotted a violation of the scheduler topology sanity checks. We did
not find a check that suits both Power7 and x86. For now, I removed the
NEEDS_CHILD flag of SD_ASYM_PACKING.

Hopefully, these patches are in sufficiently good shape to be merged.

Thank you for your feedback and I look forward to getting more of it!

New patches 2, 3, 4, 5, 6, 7, 8
Updated patches: 1
Unchanged patches: 9, 10

BR,
Ricardo

[1]. https://lore.kernel.org/lkml/20220825225529.26465-1-ricardo.neri-calderon@linux.intel.com/
[2]. https://lore.kernel.org/lkml/20221122203532.15013-1-ricardo.neri-calderon@linux.intel.com/


Ricardo Neri (10):
  sched/fair: Generalize asym_packing logic for SMT cores
  sched/fair: Move is_core_idle() out of CONFIG_NUMA
  sched/fair: Only do asym_packing load balancing from fully idle SMT
    cores
  sched/fair: Let low-priority cores help high-priority busy SMT cores
  sched/fair: Keep a fully_busy SMT sched group as busiest
  sched/fair: Use the prefer_sibling flag of the current sched domain
  sched/fair: Do not even the number of busy CPUs via asym_packing
  sched/topology: Remove SHARED_CHILD from ASYM_PACKING
  x86/sched: Remove SD_ASYM_PACKING from the SMT domain flags
  x86/sched/itmt: Give all SMT siblings of a core the same priority

 arch/x86/kernel/itmt.c         |  23 +----
 arch/x86/kernel/smpboot.c      |   2 +-
 include/linux/sched/sd_flags.h |   5 +-
 kernel/sched/fair.c            | 175 +++++++++++++++++----------------
 4 files changed, 99 insertions(+), 106 deletions(-)

-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0B8F7C636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:50:56 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229969AbjBGEuy (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:50:54 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53278 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229670AbjBGEus (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:48 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C793E4224
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:46 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745446; x=1707281446;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=NHwRQom2Hnt0ENynqej3UWEaK2X2qGGXakLIKRH9HWo=;
  b=YHminuoJPXwQ006sZy5NSdn0kTaGQqHBJjCzInTDnixDyFOXIY4jurnE
   Y4hNRN7xYCRpigLCpuNTWbpyrFnggAf5nXVsHzpKvs9O4RV3kIeSoCmL7
   tK9RHlD9zhUpvSFj5WuvWahdlK1VIW2zTPqBEZN9c8o/SnLWOdoxZ1mPq
   US4O5kxrtcgDUKcr+NgSPMiuMEtCMtyW5z8hIAS5DZ+PEzhVdZF7ABuNT
   6liUYq3SoDosbkQfHTIfEXcFa5EZK4tp6CJIwtDQp2TR1dHqrGPXdJ/If
   KfEWQ0dx2KhOm73KrgkNXtLmtGp3rbloa1RG4Gep/oLjYJpT0d54xrR+R
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415623976"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415623976"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:45 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653779"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653779"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:45 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 01/10] sched/fair: Generalize asym_packing logic for SMT cores
Date:   Mon,  6 Feb 2023 20:58:29 -0800
Message-Id: <20230207045838.11243-2-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

When doing asym_packing load balancing between cores, all we care is that
the destination core is fully idle (including SMT siblings, if any) and
that the busiest candidate scheduling group has exactly one busy CPU. It is
irrelevant whether the candidate busiest core is non-SMT, SMT2, SMT4, SMT8,
etc.

Do not handle the candidate busiest non-SMT vs SMT cases separately. Simply
do the two checks described above. Let find_busiest_group() handle bigger
imbalances in the number of idle CPUs.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Reviewed-by: Len Brown <len.brown@intel.com>
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Updated documentation of the function to reflect the new behavior.
   (Dietmar)

Changes since v1:
 * Reworded commit message and inline comments for clarity.
 * Stated that this changeset does not impact SMT4 or SMT8.
---
 kernel/sched/fair.c | 41 ++++++++++++++---------------------------
 1 file changed, 14 insertions(+), 27 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index 7c46485d65d7..df46e06c9a3e 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -9254,13 +9254,11 @@ group_type group_classify(unsigned int imbalance_pct,
  * the SMT siblings of @sg are busy. If only one CPU in @sg is busy, pull tasks
  * only if @dst_cpu has higher priority.
  *
- * If both @dst_cpu and @sg have SMT siblings, and @sg has exactly one more
- * busy CPU than @sds::local, let @dst_cpu pull tasks if it has higher priority.
- * Bigger imbalances in the number of busy CPUs will be dealt with in
- * update_sd_pick_busiest().
- *
- * If @sg does not have SMT siblings, only pull tasks if all of the SMT siblings
- * of @dst_cpu are idle and @sg has lower priority.
+ * If @dst_cpu has SMT siblings, check if there are no running tasks in
+ * @sds::local. In such case, decide based on the priority of @sg. Do it only
+ * if @sg has exactly one busy CPU (i.e., one more than @sds::local). Bigger
+ * imbalances in the number of busy CPUs will be dealt with in
+ * find_busiest_group().
  *
  * Return: true if @dst_cpu can pull tasks, false otherwise.
  */
@@ -9269,12 +9267,10 @@ static bool asym_smt_can_pull_tasks(int dst_cpu, struct sd_lb_stats *sds,
 				    struct sched_group *sg)
 {
 #ifdef CONFIG_SCHED_SMT
-	bool local_is_smt, sg_is_smt;
+	bool local_is_smt;
 	int sg_busy_cpus;
 
 	local_is_smt = sds->local->flags & SD_SHARE_CPUCAPACITY;
-	sg_is_smt = sg->flags & SD_SHARE_CPUCAPACITY;
-
 	sg_busy_cpus = sgs->group_weight - sgs->idle_cpus;
 
 	if (!local_is_smt) {
@@ -9295,25 +9291,16 @@ static bool asym_smt_can_pull_tasks(int dst_cpu, struct sd_lb_stats *sds,
 		return sched_asym_prefer(dst_cpu, sg->asym_prefer_cpu);
 	}
 
-	/* @dst_cpu has SMT siblings. */
-
-	if (sg_is_smt) {
-		int local_busy_cpus = sds->local->group_weight -
-				      sds->local_stat.idle_cpus;
-		int busy_cpus_delta = sg_busy_cpus - local_busy_cpus;
-
-		if (busy_cpus_delta == 1)
-			return sched_asym_prefer(dst_cpu, sg->asym_prefer_cpu);
-
-		return false;
-	}
-
 	/*
-	 * @sg does not have SMT siblings. Ensure that @sds::local does not end
-	 * up with more than one busy SMT sibling and only pull tasks if there
-	 * are not busy CPUs (i.e., no CPU has running tasks).
+	 * @dst_cpu has SMT siblings. Do asym_packing load balancing only if
+	 * all its siblings are idle (moving tasks between physical cores in
+	 * which some SMT siblings are busy results in the same throughput).
+	 *
+	 * If the difference in the number of busy CPUs is two or more, let
+	 * find_busiest_group() take care of it. We only care if @sg has
+	 * exactly one busy CPU. This covers SMT and non-SMT sched groups.
 	 */
-	if (!sds->local_stat.sum_nr_running)
+	if (sg_busy_cpus == 1 && !sds->local_stat.sum_nr_running)
 		return sched_asym_prefer(dst_cpu, sg->asym_prefer_cpu);
 
 	return false;
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8C905C636CD
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:00 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229954AbjBGEu6 (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:50:58 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53280 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229625AbjBGEus (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:48 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4697E4236
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745447; x=1707281447;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=fFIXmz2jRoZi+M1l2J6uT/aihpD4LyOEaKM5OhhEq7Y=;
  b=m+QHtUxyPZrmE6PrVxYqy+114rJq8NQRahcbGxK1WkKLm6C3qj4XncPd
   CfQeKVLWC+z/pB2xZDJtWnQty11GBvC50D5dvgIMQKFrR/HCPBJvaAG97
   rPVSTgWrTP5h+3nO1zRxUgBUg3sZp5feiJrgSy9b9yB1pU2ouMs+ush6m
   eGaPmsbxz1r4xmP9obo10xQjvwNl7pp9AQjjx6Lm+ODJZOcNvGlHphXyJ
   Q7RE4XyY5mSbEImWSOEG1kgTuWgAAq08FqjVp2dS9MB9zwrj71Lqlp69B
   VoFeokdbEMsYUdd3Y1YsfNzTVb6AXDbh8N3aFBTWZDnLnp+S1dLG9mnVs
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415623986"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415623986"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:46 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653782"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653782"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:45 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 02/10] sched/fair: Move is_core_idle() out of CONFIG_NUMA
Date:   Mon,  6 Feb 2023 20:58:30 -0800
Message-Id: <20230207045838.11243-3-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

asym_packing needs this function to determine whether an SMT core is a
suitable destination for load balancing.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Introduced this patch.

Changes since v1:
 * N/A
---
 kernel/sched/fair.c | 34 +++++++++++++++++-----------------
 1 file changed, 17 insertions(+), 17 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index df46e06c9a3e..767bec7789ac 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -1064,6 +1064,23 @@ update_stats_curr_start(struct cfs_rq *cfs_rq, struct sched_entity *se)
  * Scheduling class queueing methods:
  */
 
+static inline bool is_core_idle(int cpu)
+{
+#ifdef CONFIG_SCHED_SMT
+	int sibling;
+
+	for_each_cpu(sibling, cpu_smt_mask(cpu)) {
+		if (cpu == sibling)
+			continue;
+
+		if (!idle_cpu(sibling))
+			return false;
+	}
+#endif
+
+	return true;
+}
+
 #ifdef CONFIG_NUMA
 #define NUMA_IMBALANCE_MIN 2
 
@@ -1700,23 +1717,6 @@ struct numa_stats {
 	int idle_cpu;
 };
 
-static inline bool is_core_idle(int cpu)
-{
-#ifdef CONFIG_SCHED_SMT
-	int sibling;
-
-	for_each_cpu(sibling, cpu_smt_mask(cpu)) {
-		if (cpu == sibling)
-			continue;
-
-		if (!idle_cpu(sibling))
-			return false;
-	}
-#endif
-
-	return true;
-}
-
 struct task_numa_env {
 	struct task_struct *p;
 
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 36D98C636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:04 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229865AbjBGEvC (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:02 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53296 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229832AbjBGEus (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:48 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 10DF044BC
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:48 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745448; x=1707281448;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=BhYkRtUf49Glw2ZU0a3Pjs3bki0DXfT9COx0nHL/qCw=;
  b=YDiE51cFVqLf62JsGMdpJchxCPazPEa9taxciml+UxNWEVPIcA387Y9j
   UH7SiGW7dUPaLVD4FNTHSz7wcEV4HQwAntBYK/vvsXcTfcy7znMlRqdLz
   /bAXyt6wxsLMuFoGXXt0Hd8y+XpOHfgUZwgMw8XevWJUGC1QJvjjZ6v0M
   0cxLIt21/6FKXhOnMrRjd5cGUsO1mCc85vjjv9F8uAGWpYckXHI07tglT
   S4OsdxcvJusnDo/fPLWUiPgOhSq9LvSTujYic9YdZw+WbZ0+4p4A59SYW
   vew3fVbz6tnRXI2Jzn8UDs3pePGt/g+fz9HmBQpit6AuaRNix0yWWlsQ9
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415624005"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415624005"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:46 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653789"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653789"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:46 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 04/10] sched/fair: Let low-priority cores help high-priority busy SMT cores
Date:   Mon,  6 Feb 2023 20:58:32 -0800
Message-Id: <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Using asym_packing priorities within an SMT core is straightforward. Just
follow the priorities that hardware indicates.

When balancing load from an SMT core, also consider the idle of its
siblings. Priorities do not reflect that an SMT core divides its throughput
among all its busy siblings. They only makes sense when exactly one sibling
is busy.

Indicate that active balance is needed if the destination CPU has lower
priority than the source CPU but the latter has busy SMT siblings.

Make find_busiest_queue() not skip higher-priority SMT cores with more than
busy sibling.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Suggested-by: Valentin Schneider <vschneid@redhat.com>
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Introduced this patch.

Changes since v1:
 * N/A
---
 kernel/sched/fair.c | 31 ++++++++++++++++++++++++++-----
 1 file changed, 26 insertions(+), 5 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index 80c86462c6f6..c9d0ddfd11f2 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -10436,11 +10436,20 @@ static struct rq *find_busiest_queue(struct lb_env *env,
 		    nr_running == 1)
 			continue;
 
-		/* Make sure we only pull tasks from a CPU of lower priority */
+		/*
+		 * Make sure we only pull tasks from a CPU of lower priority
+		 * when balancing between SMT siblings.
+		 *
+		 * If balancing between cores, let lower priority CPUs help
+		 * SMT cores with more than one busy sibling.
+		 */
 		if ((env->sd->flags & SD_ASYM_PACKING) &&
 		    sched_asym_prefer(i, env->dst_cpu) &&
-		    nr_running == 1)
-			continue;
+		    nr_running == 1) {
+			if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
+			    (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
+				continue;
+		}
 
 		switch (env->migration_type) {
 		case migrate_load:
@@ -10530,8 +10539,20 @@ asym_active_balance(struct lb_env *env)
 	 * lower priority CPUs in order to pack all tasks in the
 	 * highest priority CPUs.
 	 */
-	return env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING) &&
-	       sched_asym_prefer(env->dst_cpu, env->src_cpu);
+	if (env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING)) {
+		/* Always obey priorities between SMT siblings. */
+		if (env->sd->flags & SD_SHARE_CPUCAPACITY)
+			return sched_asym_prefer(env->dst_cpu, env->src_cpu);
+
+		/*
+		 * A lower priority CPU can help an SMT core with more than one
+		 * busy sibling.
+		 */
+		return sched_asym_prefer(env->dst_cpu, env->src_cpu) ||
+		       !is_core_idle(env->src_cpu);
+	}
+
+	return false;
 }
 
 static inline bool
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 41F28C636CD
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:08 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229614AbjBGEvF (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:05 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53294 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229828AbjBGEus (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:48 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0204FD3
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745447; x=1707281447;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=W6TuYGPZ71rk8F3QYL8M9R3AwD+pJaLK+sDkNMpMUBo=;
  b=YHYjq52ZX3LEnC+1eAoCUQfYaa7KZQeKg31l1h2r1WsbCvUzmyu8FQgO
   jm5KM5ASexmN+yucnn2vwZ1lonHeU/QnE8RVj+P2VI1iOVDxaF53ZkQWZ
   CXTqo/EuYreSuFxtEF8kCkBGdZNjlwzdudl3Ia8E/dxYBMi0keigkB5mJ
   h47mU/F8HG1yXLadpay4x+LqPF16LoXZ4rQALcLDD4Wf5klRA8+kqpDdl
   A06SFIOTK3spdfkvS6oLB/gzIhlYtBILT8CH3vWxnkGnU5znDmPwwmt1L
   6LiIv5Kr9yPgVqyT1KNwwATi6rsEN4itUNY9dGx+NjELaq1UW/upOgpYM
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415623995"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415623995"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:46 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653786"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653786"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:46 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 03/10] sched/fair: Only do asym_packing load balancing from fully idle SMT cores
Date:   Mon,  6 Feb 2023 20:58:31 -0800
Message-Id: <20230207045838.11243-4-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

When balancing load between cores, all the SMT siblings of the destination
CPU, if any, must be idle. Otherwise, pulling new tasks degrades the
throughput of the busy SMT siblings. The overall throughput of the system
remains the same.

When balancing load within an SMT core this consideration is not relevant
relevant. Follow the priorities that hardware indicates.

Using is_core_idle() renders checking !sds->local_stat.sum_nr_running
redundant. Remove it.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Suggested-by: Valentin Schneider <vschneid@redhat.com>
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Introduced this patch.

Changes since v1:
 * N/A
---
 kernel/sched/fair.c | 34 +++++++++++++++++++++++++---------
 1 file changed, 25 insertions(+), 9 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index 767bec7789ac..80c86462c6f6 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -9250,12 +9250,14 @@ group_type group_classify(unsigned int imbalance_pct,
  * Check the state of the SMT siblings of both @sds::local and @sg and decide
  * if @dst_cpu can pull tasks.
  *
+ * This function must be called only if all the SMT siblings of @dst_cpu are
+ * idle, if any.
+ *
  * If @dst_cpu does not have SMT siblings, it can pull tasks if two or more of
  * the SMT siblings of @sg are busy. If only one CPU in @sg is busy, pull tasks
  * only if @dst_cpu has higher priority.
  *
- * If @dst_cpu has SMT siblings, check if there are no running tasks in
- * @sds::local. In such case, decide based on the priority of @sg. Do it only
+ * If @dst_cpu has SMT siblings, decide based on the priority of @sg. Do it only
  * if @sg has exactly one busy CPU (i.e., one more than @sds::local). Bigger
  * imbalances in the number of busy CPUs will be dealt with in
  * find_busiest_group().
@@ -9292,15 +9294,13 @@ static bool asym_smt_can_pull_tasks(int dst_cpu, struct sd_lb_stats *sds,
 	}
 
 	/*
-	 * @dst_cpu has SMT siblings. Do asym_packing load balancing only if
-	 * all its siblings are idle (moving tasks between physical cores in
-	 * which some SMT siblings are busy results in the same throughput).
+	 * @dst_cpu has SMT siblings and are also idle.
 	 *
 	 * If the difference in the number of busy CPUs is two or more, let
 	 * find_busiest_group() take care of it. We only care if @sg has
 	 * exactly one busy CPU. This covers SMT and non-SMT sched groups.
 	 */
-	if (sg_busy_cpus == 1 && !sds->local_stat.sum_nr_running)
+	if (sg_busy_cpus == 1)
 		return sched_asym_prefer(dst_cpu, sg->asym_prefer_cpu);
 
 	return false;
@@ -9314,7 +9314,14 @@ static inline bool
 sched_asym(struct lb_env *env, struct sd_lb_stats *sds,  struct sg_lb_stats *sgs,
 	   struct sched_group *group)
 {
-	/* Only do SMT checks if either local or candidate have SMT siblings */
+	/*
+	 * If the destination CPU has SMT siblings, env->idle != CPU_NOT_IDLE
+	 * is not sufficient. We need to make sure the whole core is idle.
+	 */
+	if (sds->local->flags & SD_SHARE_CPUCAPACITY && !is_core_idle(env->dst_cpu))
+		return false;
+
+	/* Only do SMT checks if either local or candidate have SMT siblings. */
 	if ((sds->local->flags & SD_SHARE_CPUCAPACITY) ||
 	    (group->flags & SD_SHARE_CPUCAPACITY))
 		return asym_smt_can_pull_tasks(env->dst_cpu, sds, sgs, group);
@@ -11261,8 +11268,17 @@ static void nohz_balancer_kick(struct rq *rq)
 		 */
 		for_each_cpu_and(i, sched_domain_span(sd), nohz.idle_cpus_mask) {
 			if (sched_asym_prefer(i, cpu)) {
-				flags = NOHZ_STATS_KICK | NOHZ_BALANCE_KICK;
-				goto unlock;
+				/*
+				 * Always do ASYM_PACKING balance in the SMT
+				 * domain. In upper domains, the core must be
+				 * fully idle.
+				 */
+				if (sd->flags & SD_SHARE_CPUCAPACITY ||
+				    (!(sd->flags & SD_SHARE_CPUCAPACITY) &&
+				     is_core_idle(i))) {
+					flags = NOHZ_STATS_KICK | NOHZ_BALANCE_KICK;
+					goto unlock;
+				}
 			}
 		}
 	}
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 958F2C636CD
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:12 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229992AbjBGEvK (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:10 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53302 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229924AbjBGEut (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:49 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 14E344ECC
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:48 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745448; x=1707281448;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=ulLn873Z56iFQvxm4YOPwOFsRDQ7WudOQQX77xthURc=;
  b=SzkE43STwpMyQxRVXh1tqpIqgXttsqg5ePJ5eHfmPIEUGXPrrKS4B6fJ
   7aQALzxucFatxuMoEd9qzkLhSOKpFVn83NMhDa4C7VrydQoHLMG3Pma4d
   kik/WQkjKVXSYYmBYdk9TtfuRnXd5w8BRNlSlcml6KQItel0s8YZAbB/J
   dJbt8dgzFh/i9LrG+g0LlT09oxmCQcTyHOTrXkdJUkSWtCUfRjF1qiuKs
   vdyKT3yDTCQBqF+rCeoqLJiJKT9AVjJoqqQQWe+bPwfOuedn/ftc9FQ8v
   LBe3R4fkrT0nIacAadNbrimb5ZYe6hdtGs+G6hJT+REbElVRsNFsdx1Hg
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415624014"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415624014"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:47 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653792"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653792"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:46 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 05/10] sched/fair: Keep a fully_busy SMT sched group as busiest
Date:   Mon,  6 Feb 2023 20:58:33 -0800
Message-Id: <20230207045838.11243-6-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

When comparing two fully_busy scheduling groups, keep the current busiest
group if it represents an SMT core. Tasks in such scheduling group share
CPU resources and need more help than tasks in a non-SMT fully_busy group.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Introduced this patch.

Changes since v1:
 * N/A
---
 kernel/sched/fair.c | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index c9d0ddfd11f2..df7bcbf634a8 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -9514,10 +9514,22 @@ static bool update_sd_pick_busiest(struct lb_env *env,
 		 * contention when accessing shared HW resources.
 		 *
 		 * XXX for now avg_load is not computed and always 0 so we
-		 * select the 1st one.
+		 * select the 1st one, except if @sg is composed of SMT
+		 * siblings.
 		 */
-		if (sgs->avg_load <= busiest->avg_load)
+
+		if (sgs->avg_load < busiest->avg_load)
 			return false;
+
+		if (sgs->avg_load == busiest->avg_load) {
+			/*
+			 * SMT sched groups need more help than non-SMT groups.
+			 * If @sg happens to also be SMT, either choice is good.
+			 */
+			if (sds->busiest->flags & SD_SHARE_CPUCAPACITY)
+				return false;
+		}
+
 		break;
 
 	case group_has_spare:
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DF556C636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:16 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229615AbjBGEvP (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:15 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53308 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229939AbjBGEut (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:49 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id DC3EE4224
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:48 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745448; x=1707281448;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=YXCyBdAQ0Q8XIVxjs4jHd98vK+N1vGYP5jLh9y5xDlw=;
  b=SsRNjdSSrN7/Pechmo0lvFWLJlMbcut3thdz6lEyVulzntW2fqLGpEoe
   MMkA8ZZaZm7UY5JjrC3MgQurO7pLd8nchhy2nvRcdbeSRX/+H1zyNOROI
   m/oeS9/hUPgDoB9lr/ygETgGQkP908ws2naKl6ZxTqurrtVUMfBWe2i46
   lJDNrkgebccArGTGSv199qzuQe86DMEIoH/6b2XuSIyNOMG52aCZyEVsS
   dlytJghiMrliO3eIkbWhw8XncPTJIacKdqsAwW+HPED8dmWR3pNrPhpAk
   pKm7+WaPb14KjKcFqrvnpWvLkyO+qIZkhId8cBKdNNsNBkaRWonDW2VnD
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415624023"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415624023"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:47 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653796"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653796"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:47 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the current sched domain
Date:   Mon,  6 Feb 2023 20:58:34 -0800
Message-Id: <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

SD_PREFER_SIBLING is set from the SMT scheduling domain up to the first
non-NUMA domain (the exception is systems with SD_ASYM_CPUCAPACITY).

Above the SMT sched domain, all domains have a child. The SD_PREFER_
SIBLING is honored always regardless of the scheduling domain at which the
load balance takes place.

There are cases, however, in which the busiest CPU's sched domain has
child but the destination CPU's does not. Consider, for instance a non-SMT
core (or an SMT core with only one online sibling) doing load balance with
an SMT core at the MC level. SD_PREFER_SIBLING will not be honored. We are
left with a fully busy SMT core and an idle non-SMT core.

Avoid inconsistent behavior. Use the prefer_sibling behavior at the current
scheduling domain, not its child.

The NUMA sched domain does not have the SD_PREFER_SIBLING flag. Thus, we
will not spread load among NUMA sched groups, as desired.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Suggested-by: Valentin Schneider <vschneid@redhat.com>
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Introduced this patch.

Changes since v1:
 * N/A
---
 kernel/sched/fair.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index df7bcbf634a8..a37ad59f20ea 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -10004,7 +10004,6 @@ static void update_idle_cpu_scan(struct lb_env *env,
 
 static inline void update_sd_lb_stats(struct lb_env *env, struct sd_lb_stats *sds)
 {
-	struct sched_domain *child = env->sd->child;
 	struct sched_group *sg = env->sd->groups;
 	struct sg_lb_stats *local = &sds->local_stat;
 	struct sg_lb_stats tmp_sgs;
@@ -10045,9 +10044,11 @@ static inline void update_sd_lb_stats(struct lb_env *env, struct sd_lb_stats *sd
 		sg = sg->next;
 	} while (sg != env->sd->groups);
 
-	/* Tag domain that child domain prefers tasks go to siblings first */
-	sds->prefer_sibling = child && child->flags & SD_PREFER_SIBLING;
-
+	/*
+	 * Tag domain that @env::sd prefers to spread excess tasks among
+	 * sibling sched groups.
+	 */
+	sds->prefer_sibling = env->sd->flags & SD_PREFER_SIBLING;
 
 	if (env->sd->flags & SD_NUMA)
 		env->fbq_type = fbq_classify_group(&sds->busiest_stat);
@@ -10346,7 +10347,6 @@ static struct sched_group *find_busiest_group(struct lb_env *env)
 			goto out_balanced;
 	}
 
-	/* Try to move all excess tasks to child's sibling domain */
 	if (sds.prefer_sibling && local->group_type == group_has_spare &&
 	    busiest->sum_nr_running > local->sum_nr_running + 1)
 		goto force_balance;
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1920FC636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:22 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229739AbjBGEvU (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:20 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53332 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229647AbjBGEuu (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:50 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B873B44BC
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:49 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745449; x=1707281449;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=gCAF3pOvYu6INyXHaG52RuEfLVgO2TXZcOSdaT+lLxQ=;
  b=i7xL4ERpfSQxN0FM17Jn4FDvGddQB0cbWybKTC36I9Bxopqo6Djxlth1
   rY/kArRBYkugTUHFt0ZgTANUhRgfFR7lMrAiIXZy2QKtyh/fQrW5tKWYO
   4+mW7EZeeZyF1d0nl6dZUglbWppevqgTjl60OA21QqTHLtDgz6i0p3kiw
   9gCpI93vZwLOV24ixa1tuSmMX/Nsgi6uGiG42mGPKhwSc0vkrdVRa21f1
   JqTOR+T2U9uyGrkw1/R42gQtNSSLGLXo+zjtTwI4I36TxbRt3GkvRsb3g
   H7kVvmabjF/sZeE+Y5QLO5r+V4cAEnp263NaMZ7/uPH109n0GG2mJhLfi
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415624041"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415624041"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:48 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653802"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653802"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:48 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 08/10] sched/topology: Remove SHARED_CHILD from ASYM_PACKING
Date:   Mon,  6 Feb 2023 20:58:36 -0800
Message-Id: <20230207045838.11243-9-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Only x86 and Power7 use ASYM_PACKING. They use it differently.

Power7 has cores of equal priority, but the SMT siblings of a core have
different priorities. Parent scheduling domains do not need (nor have) the
ASYM_PACKING flag. SHARED_CHILD is not needed. Using SHARED_PARENT would
cause the topology debug code to complain.

X86 has cores of different priority, but all the SMT siblings of the core
have equal priority. It needs ASYM_PACKING at the MC level, but not at the
SMT level (it also needs it at upper levels if they have scheduling groups
of different priority). Removing ASYM_PACKING from the SMT domain causes
the topology debug code to complain.

Remove SHARED_CHILD for now. We still need a topology check that satisfies
both architectures.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Suggested-by: Valentin Schneider <vschneid@redhat.com>
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Introduced this patch.

Changes since v1:
 * N/A
---
 include/linux/sched/sd_flags.h | 5 +----
 1 file changed, 1 insertion(+), 4 deletions(-)

diff --git a/include/linux/sched/sd_flags.h b/include/linux/sched/sd_flags.h
index 57bde66d95f7..800238854ba5 100644
--- a/include/linux/sched/sd_flags.h
+++ b/include/linux/sched/sd_flags.h
@@ -132,12 +132,9 @@ SD_FLAG(SD_SERIALIZE, SDF_SHARED_PARENT | SDF_NEEDS_GROUPS)
 /*
  * Place busy tasks earlier in the domain
  *
- * SHARED_CHILD: Usually set on the SMT level. Technically could be set further
- *               up, but currently assumed to be set from the base domain
- *               upwards (see update_top_cache_domain()).
  * NEEDS_GROUPS: Load balancing flag.
  */
-SD_FLAG(SD_ASYM_PACKING, SDF_SHARED_CHILD | SDF_NEEDS_GROUPS)
+SD_FLAG(SD_ASYM_PACKING,  SDF_NEEDS_GROUPS)
 
 /*
  * Prefer to place tasks in a sibling domain
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 88B56C636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:25 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230179AbjBGEvX (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:23 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53330 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229535AbjBGEuu (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:50 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 784574236
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:49 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745449; x=1707281449;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=fNzFE8GHMV6lK6aBMJxB809+PnuCf6ZrTheiPPiWiEE=;
  b=Addoqy/WC6wa3n4JwXifYlMPFB/MmaXzJTJtb0yCk84Kj0cRFkcFazm3
   aXO6LUMxUKGY7yARJUDwVOXMFkgfqRPN4cKo7MlJnOqeq2jTnx/xsuBsO
   qMKjo2izp3EyTXVVHOzD3JkVLEK50TjdXaeNmmWZo7hWXD+9wngNjmRpl
   NmCwSPCdpz9zWE6Ee35qVNxJRtPR0auGsa+EBJW3zO5+rF/X2twrH4vgm
   oQ25dcqFhx69CZHi8X2zUumCXs7pjwoZIu0Nqiafi/A3JhXiwrNTx6b01
   EzE4PDD3RUYBMZ5ZUrQWTaRczij6TqkTkWYj1U3Fljc6Me5mGYE6h1Y4S
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415624032"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415624032"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:48 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653799"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653799"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:47 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 07/10] sched/fair: Do not even the number of busy CPUs via asym_packing
Date:   Mon,  6 Feb 2023 20:58:35 -0800
Message-Id: <20230207045838.11243-8-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Now that find_busiest_group() triggers load balancing between a fully_
busy SMT2 core and an idle non-SMT core, it is no longer needed to force
balancing via asym_packing. Use asym_packing only as intended: when there
is high-priority CPU that is idle.

After this change, the same logic apply to SMT and non-SMT local groups.
Simplify asym_smt_can_pull_tasks() accordingly.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * Introduced this patch.

Changes since v1:
 * N/A
---
 kernel/sched/fair.c | 37 +++++--------------------------------
 1 file changed, 5 insertions(+), 32 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index a37ad59f20ea..0ada2d18b934 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -9247,20 +9247,15 @@ group_type group_classify(unsigned int imbalance_pct,
  * @sgs:	Load-balancing statistics of the candidate busiest group
  * @sg:		The candidate busiest group
  *
- * Check the state of the SMT siblings of both @sds::local and @sg and decide
- * if @dst_cpu can pull tasks.
+ * Check the state of the SMT siblings of @sg and decide if @dst_cpu can pull
+ * tasks.
  *
  * This function must be called only if all the SMT siblings of @dst_cpu are
  * idle, if any.
  *
- * If @dst_cpu does not have SMT siblings, it can pull tasks if two or more of
- * the SMT siblings of @sg are busy. If only one CPU in @sg is busy, pull tasks
- * only if @dst_cpu has higher priority.
- *
- * If @dst_cpu has SMT siblings, decide based on the priority of @sg. Do it only
- * if @sg has exactly one busy CPU (i.e., one more than @sds::local). Bigger
- * imbalances in the number of busy CPUs will be dealt with in
- * find_busiest_group().
+ * @dst_cpu can pull tasks if @sg has exactly one busy CPU (i.e., one more than
+ * @sds::local) and has lower group priority than @sds::local. Bigger imbalances
+ * in the number of busy CPUs will be dealt with in find_busiest_group().
  *
  * Return: true if @dst_cpu can pull tasks, false otherwise.
  */
@@ -9269,33 +9264,11 @@ static bool asym_smt_can_pull_tasks(int dst_cpu, struct sd_lb_stats *sds,
 				    struct sched_group *sg)
 {
 #ifdef CONFIG_SCHED_SMT
-	bool local_is_smt;
 	int sg_busy_cpus;
 
-	local_is_smt = sds->local->flags & SD_SHARE_CPUCAPACITY;
 	sg_busy_cpus = sgs->group_weight - sgs->idle_cpus;
 
-	if (!local_is_smt) {
-		/*
-		 * If we are here, @dst_cpu is idle and does not have SMT
-		 * siblings. Pull tasks if candidate group has two or more
-		 * busy CPUs.
-		 */
-		if (sg_busy_cpus >= 2) /* implies sg_is_smt */
-			return true;
-
-		/*
-		 * @dst_cpu does not have SMT siblings. @sg may have SMT
-		 * siblings and only one is busy. In such case, @dst_cpu
-		 * can help if it has higher priority and is idle (i.e.,
-		 * it has no running tasks).
-		 */
-		return sched_asym_prefer(dst_cpu, sg->asym_prefer_cpu);
-	}
-
 	/*
-	 * @dst_cpu has SMT siblings and are also idle.
-	 *
 	 * If the difference in the number of busy CPUs is two or more, let
 	 * find_busiest_group() take care of it. We only care if @sg has
 	 * exactly one busy CPU. This covers SMT and non-SMT sched groups.
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 3EDC4C636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:30 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229743AbjBGEv2 (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:28 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53344 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229850AbjBGEuv (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:51 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D52B8D3
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:49 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745449; x=1707281449;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=7VjPXZk06n0CTxUjfuNsgpOoSCtgvNDjYZVfPD67F1s=;
  b=JocOryHRJNA9O8K9MfgNXuKDETp3g/aV2onT4uf/G9thXm4JLKfGVmbP
   xgVq75Fj8FWjBZclwxPJIs0sAEzxhK3C2egbLdRKFyn49rnaFfyhab/6k
   fpWsLPMAdWBDFiHjS0rfwQSTq2qx8FS9pfy9tTx7f07McvxQZB0MvFtlB
   LfUWEYNv/rRNsN8RlHPrdecL6dexkP248SsMguHgW+7+so3FRnIdn3Uh0
   Z7l6/A0yVXnPQdMsj11Ws6dYfWYpr5VcmF4mV6ue/XsNv6sN3BZ9xAXI1
   xI76NGP8utdazmB1OlZ9yG0sw9D58PVZXs+dLf2+/SPYL064POF1DEHXk
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415624052"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415624052"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:48 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653805"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653805"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:48 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 09/10] x86/sched: Remove SD_ASYM_PACKING from the SMT domain flags
Date:   Mon,  6 Feb 2023 20:58:37 -0800
Message-Id: <20230207045838.11243-10-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

There is no difference between any of the SMT siblings of a physical core.
Do not do asym_packing load balancing at this level.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * None.

Changes since v1:
 * Introduced this patch.
---
 arch/x86/kernel/smpboot.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/x86/kernel/smpboot.c b/arch/x86/kernel/smpboot.c
index 55cad72715d9..0213d066a9a9 100644
--- a/arch/x86/kernel/smpboot.c
+++ b/arch/x86/kernel/smpboot.c
@@ -547,7 +547,7 @@ static int x86_core_flags(void)
 #ifdef CONFIG_SCHED_SMT
 static int x86_smt_flags(void)
 {
-	return cpu_smt_flags() | x86_sched_itmt_flags();
+	return cpu_smt_flags();
 }
 #endif
 #ifdef CONFIG_SCHED_CLUSTER
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 79A08C636CC
	for <linux-kernel@archiver.kernel.org>; Tue,  7 Feb 2023 04:51:33 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229460AbjBGEvc (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 6 Feb 2023 23:51:32 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53356 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229953AbjBGEuv (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 6 Feb 2023 23:50:51 -0500
Received: from mga05.intel.com (mga05.intel.com [192.55.52.43])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id A2B384224
        for <linux-kernel@vger.kernel.org>; Mon,  6 Feb 2023 20:50:50 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675745450; x=1707281450;
  h=from:to:cc:subject:date:message-id:in-reply-to:
   references;
  bh=V6FYmmT4588dHQyb2k4T7y1sGWHIXNL1S/nAV83f7Kc=;
  b=bItoG2aADFROUGdSb2VH4jrC46brvF3ikHNj8OPk60rTl3tqoRZqr/Zr
   /9Dj4KrZpwmDCPPG4jx+l/OHLJoEGLQhC8HmNTRYFEekfFJEeEJtS6xtY
   EIObkfX+FqfjbP3AUrAR8XTSlEX8P95FceKsYlrnAp0lJSblV9gsupVet
   jWz/1aViJVasfUOQPGJKoy17irsWgdfPGgiuF/ZAY4h2hCmQgaj9U5KxQ
   i+JB29OenZssRNAk+prtey3McNTeVtDbKGJcPhtGLI7bm/F7Kx5+YHiRa
   elPdtxUIFvt5qVD0xZwYKswhNe1rpK11rGtFgQ/tLvK1B1HzG/MN9dI7r
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="415624062"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="415624062"
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 06 Feb 2023 20:50:49 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10613"; a="668653808"
X-IronPort-AV: E=Sophos;i="5.97,278,1669104000"; 
   d="scan'208";a="668653808"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga007.fm.intel.com with ESMTP; 06 Feb 2023 20:50:48 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: [PATCH v3 10/10] x86/sched/itmt: Give all SMT siblings of a core the same priority
Date:   Mon,  6 Feb 2023 20:58:38 -0800
Message-Id: <20230207045838.11243-11-ricardo.neri-calderon@linux.intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

X86 does not have the SD_ASYM_PACKING flag in the SMT domain. The scheduler
knows how to handle SMT and non-SMT cores of different priority. There is
no reason for SMT siblings of a core to have different priorities.

Cc: Ben Segall <bsegall@google.com>
Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc: Len Brown <len.brown@intel.com>
Cc: Mel Gorman <mgorman@suse.de>
Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Tim C. Chen <tim.c.chen@intel.com>
Cc: Valentin Schneider <vschneid@redhat.com>
Cc: x86@kernel.org
Cc: linux-kernel@vger.kernel.org
Reviewed-by: Len Brown <len.brown@intel.com>
Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
Changes since v2:
 * None.

Changes since v1:
 * Reworded commit message for clarity.
---
 arch/x86/kernel/itmt.c | 23 +++++------------------
 1 file changed, 5 insertions(+), 18 deletions(-)

diff --git a/arch/x86/kernel/itmt.c b/arch/x86/kernel/itmt.c
index 9ff480e94511..6510883c5e81 100644
--- a/arch/x86/kernel/itmt.c
+++ b/arch/x86/kernel/itmt.c
@@ -174,32 +174,19 @@ int arch_asym_cpu_priority(int cpu)
 
 /**
  * sched_set_itmt_core_prio() - Set CPU priority based on ITMT
- * @prio:	Priority of cpu core
- * @core_cpu:	The cpu number associated with the core
+ * @prio:	Priority of @cpu
+ * @cpu:	The CPU number
  *
  * The pstate driver will find out the max boost frequency
  * and call this function to set a priority proportional
- * to the max boost frequency. CPU with higher boost
+ * to the max boost frequency. CPUs with higher boost
  * frequency will receive higher priority.
  *
  * No need to rebuild sched domain after updating
  * the CPU priorities. The sched domains have no
  * dependency on CPU priorities.
  */
-void sched_set_itmt_core_prio(int prio, int core_cpu)
+void sched_set_itmt_core_prio(int prio, int cpu)
 {
-	int cpu, i = 1;
-
-	for_each_cpu(cpu, topology_sibling_cpumask(core_cpu)) {
-		int smt_prio;
-
-		/*
-		 * Ensure that the siblings are moved to the end
-		 * of the priority chain and only used when
-		 * all other high priority cpus are out of capacity.
-		 */
-		smt_prio = prio * smp_num_siblings / (i * i);
-		per_cpu(sched_core_priority, cpu) = smt_prio;
-		i++;
-	}
+	per_cpu(sched_core_priority, cpu) = prio;
 }
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 2D6C2C636CC
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Feb 2023 07:48:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230352AbjBHHsU (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Feb 2023 02:48:20 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39764 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229500AbjBHHsS (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Feb 2023 02:48:18 -0500
Received: from mail-pj1-x1036.google.com (mail-pj1-x1036.google.com [IPv6:2607:f8b0:4864:20::1036])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 56860CC1B
        for <linux-kernel@vger.kernel.org>; Tue,  7 Feb 2023 23:48:17 -0800 (PST)
Received: by mail-pj1-x1036.google.com with SMTP id o16-20020a17090ad25000b00230759a8c06so1454603pjw.2
        for <linux-kernel@vger.kernel.org>; Tue, 07 Feb 2023 23:48:17 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:from:to:cc:subject:date:message-id:reply-to;
        bh=YDb46wbs7Oglszax+zQd4w6i8ViSPc6VOYFdKzRkn4I=;
        b=q6mv6ckiyC7uZBYepeGxsYYHY35eFge4JvWX7ajc76F79EtwCT70FH171xtZqGxICR
         RRoxkElfhXhStfnBLTet5lStDKk2exsBQ4ucY7i+JCL07RqDneLaf5ZQhmHwxJBQt9eY
         //BcpiVOIIr51T0Ggp2qQCjN09feYP64ROMyJkvcGX5hxBJiuz+QA61TdS7uCyGi1nAh
         g8/2tLNTWgh4f7sPDh2FqUxQD8oHgVyU6TUb47m3IBTM2Ef8vYKzsx6HICRJ0SewRBuH
         WVFAdRIp2Z/KJv+8Qoa0bWD5Gd8Q5gtKmjns2byyH+cjV41g0Q6ZiosACzGOC0D1+63q
         egLA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:x-gm-message-state:from:to:cc:subject:date:message-id
         :reply-to;
        bh=YDb46wbs7Oglszax+zQd4w6i8ViSPc6VOYFdKzRkn4I=;
        b=PBOz+/whQ2nI0u5oeFy/73qy7vP0lkc0NUChj+1M1SlXjySeeegTX1yATb550URUd/
         8cIAPAQbg2smbRp14o9d7LtPwhsOKsWG9BTJroZIxTUAjxly/g1iA+R+4wf1SBm4Kzjh
         08Xb8aqusK7/WD7fCIzEdjte3h5x/DcIa4Lw8b3ctmk1RqKC7HIaNxGEklZjHGlwxPHC
         lshGy8ws9iM1+wjMM4gGWb8ANcbvGyiGIBLzZW/I+yyxstJFtUkzjk3XwvJrlWPV16sB
         q6Z5vF6mPTFcsEbDFOx1I/KXzWEI7/jhvParOehpahQxiM94z+r/4o0fxeLmC7RTFmpb
         yI5g==
X-Gm-Message-State: AO0yUKX90hY8e4aaZGFljLyu5K3jBva3FjyGFiGm03ELvklsZJMWxl68
        T9REcdAVY4ZKftRvlSrJznS2mln4Sgc9i65iVKMo9g==
X-Google-Smtp-Source: AK7set/2+IuJ9Z1nS2sqc8bZXh3HxZ610puL926atkTwcL4wxNrZFAaRLdeBihZ3YI4gZJQ90w08M3qmShm3YZ43Yy8=
X-Received: by 2002:a17:902:c950:b0:196:6c8c:288f with SMTP id
 i16-20020a170902c95000b001966c8c288fmr1623141pla.32.1675842496761; Tue, 07
 Feb 2023 23:48:16 -0800 (PST)
MIME-Version: 1.0
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com> <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
In-Reply-To: <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
From:   Vincent Guittot <vincent.guittot@linaro.org>
Date:   Wed, 8 Feb 2023 08:48:05 +0100
Message-ID: <CAKfTPtAZ8sfDi1GbKSioJkszkRT6f+am5OSjKKKKv2q_4FKQFQ@mail.gmail.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Cc:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Content-Type: text/plain; charset="UTF-8"
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Tue, 7 Feb 2023 at 05:50, Ricardo Neri
<ricardo.neri-calderon@linux.intel.com> wrote:
>
> SD_PREFER_SIBLING is set from the SMT scheduling domain up to the first
> non-NUMA domain (the exception is systems with SD_ASYM_CPUCAPACITY).
>
> Above the SMT sched domain, all domains have a child. The SD_PREFER_
> SIBLING is honored always regardless of the scheduling domain at which the
> load balance takes place.
>
> There are cases, however, in which the busiest CPU's sched domain has
> child but the destination CPU's does not. Consider, for instance a non-SMT
> core (or an SMT core with only one online sibling) doing load balance with
> an SMT core at the MC level. SD_PREFER_SIBLING will not be honored. We are
> left with a fully busy SMT core and an idle non-SMT core.
>
> Avoid inconsistent behavior. Use the prefer_sibling behavior at the current
> scheduling domain, not its child.
>
> The NUMA sched domain does not have the SD_PREFER_SIBLING flag. Thus, we
> will not spread load among NUMA sched groups, as desired.

This is a significant change in the behavior of the numa system. It
would be good to get figures or confirmation that demonstrate that
it's ok to remove prefer_sibling behavior at the 1st numa level.

>
> Cc: Ben Segall <bsegall@google.com>
> Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
> Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
> Cc: Len Brown <len.brown@intel.com>
> Cc: Mel Gorman <mgorman@suse.de>
> Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
> Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
> Cc: Steven Rostedt <rostedt@goodmis.org>
> Cc: Tim C. Chen <tim.c.chen@intel.com>
> Cc: Valentin Schneider <vschneid@redhat.com>
> Cc: x86@kernel.org
> Cc: linux-kernel@vger.kernel.org
> Suggested-by: Valentin Schneider <vschneid@redhat.com>
> Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
> ---
> Changes since v2:
>  * Introduced this patch.
>
> Changes since v1:
>  * N/A
> ---
>  kernel/sched/fair.c | 10 +++++-----
>  1 file changed, 5 insertions(+), 5 deletions(-)
>
> diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
> index df7bcbf634a8..a37ad59f20ea 100644
> --- a/kernel/sched/fair.c
> +++ b/kernel/sched/fair.c
> @@ -10004,7 +10004,6 @@ static void update_idle_cpu_scan(struct lb_env *env,
>
>  static inline void update_sd_lb_stats(struct lb_env *env, struct sd_lb_stats *sds)
>  {
> -       struct sched_domain *child = env->sd->child;
>         struct sched_group *sg = env->sd->groups;
>         struct sg_lb_stats *local = &sds->local_stat;
>         struct sg_lb_stats tmp_sgs;
> @@ -10045,9 +10044,11 @@ static inline void update_sd_lb_stats(struct lb_env *env, struct sd_lb_stats *sd
>                 sg = sg->next;
>         } while (sg != env->sd->groups);
>
> -       /* Tag domain that child domain prefers tasks go to siblings first */
> -       sds->prefer_sibling = child && child->flags & SD_PREFER_SIBLING;
> -
> +       /*
> +        * Tag domain that @env::sd prefers to spread excess tasks among
> +        * sibling sched groups.
> +        */
> +       sds->prefer_sibling = env->sd->flags & SD_PREFER_SIBLING;
>
>         if (env->sd->flags & SD_NUMA)
>                 env->fbq_type = fbq_classify_group(&sds->busiest_stat);
> @@ -10346,7 +10347,6 @@ static struct sched_group *find_busiest_group(struct lb_env *env)
>                         goto out_balanced;
>         }
>
> -       /* Try to move all excess tasks to child's sibling domain */
>         if (sds.prefer_sibling && local->group_type == group_has_spare &&
>             busiest->sum_nr_running > local->sum_nr_running + 1)
>                 goto force_balance;
> --
> 2.25.1
>

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5AE02C05027
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Feb 2023 07:56:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231152AbjBHH4v (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Feb 2023 02:56:51 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43356 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230134AbjBHH4q (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Feb 2023 02:56:46 -0500
Received: from mail-pf1-x42a.google.com (mail-pf1-x42a.google.com [IPv6:2607:f8b0:4864:20::42a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0D9A02B60C
        for <linux-kernel@vger.kernel.org>; Tue,  7 Feb 2023 23:56:44 -0800 (PST)
Received: by mail-pf1-x42a.google.com with SMTP id n2so12534541pfo.3
        for <linux-kernel@vger.kernel.org>; Tue, 07 Feb 2023 23:56:44 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:from:to:cc:subject:date:message-id:reply-to;
        bh=crkO54afLAgsJgdC5GpCChR+pEjtVxO1bJbJ06Q0a9A=;
        b=MUyFTQeKZHQfSOUJdukzCiukH4Ua+tMjRllnEcvbRibBH1Ydn9cPXuiLv0BiErmxKV
         9ttRxFXha1O6tUQVhGfi5kgng19LedssfvarpgXzP84fBV1THPuUa7hx8LF8pHwmj1+E
         OK8fkw/ncfFqqLr7CzmX0uTWCK5ON9JV6WcFiCWAXWUyN6m5R+2iHg+oARbqvdPhno6d
         kU4fd/YAgh8syPB2+VW6inGhiQaG662c3eGklkLxcxNKU6PIFSifY+OEbeBjmqBQKFtU
         BfAAuew90eC4uSi9FRjzv8Drjp28CCqk7YYMUPnWTpcumTFdOs7CgiwiAr5wFkmJrLNl
         WIcA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=cc:to:subject:message-id:date:from:in-reply-to:references
         :mime-version:x-gm-message-state:from:to:cc:subject:date:message-id
         :reply-to;
        bh=crkO54afLAgsJgdC5GpCChR+pEjtVxO1bJbJ06Q0a9A=;
        b=JWgMj63vAeUJs2SNXRtd3HJ31N055pyxaw2Jz3FuC5zdS69myblFfA8YP2MoOhEbzX
         IEvsBEvOv3k8+QBFSR0QdougonFV5vdGUBTBiU52BkzHV6hxdRlGiUIBajhtZa/i75om
         6K/l9rAW7w+X/nNVeTfqVkN0pbpMHAHQ/w8E1jvZrecf3/DwxhSttTFAQ03e+JcuDc1G
         V1CrSexkT9/YIB/RdLFm1V7FFJDVo7KXyX2itEthGTdCxBeLjvdpGvoEmYTrK2vvqGVj
         hGDUUWRKsnuVXl42xiG0DKb4NnEYPkAwiov1oWlvXQnIi/ndnGBh3C4Jl/IepzaIAB0n
         8AGw==
X-Gm-Message-State: AO0yUKVs6TMd/J9s9nRUdNGdbUwa80zt6ioOD9zJ3Ml+9TSkAPFolchh
        ipy+1gKlJoDU/+Oz8TRYJWuARm26VqRQVOoL0rw3sg==
X-Google-Smtp-Source: AK7set8ATv7Jv51fWR/roo/jzNf7bMqH4w+qKf1lOVZ3pghRlN7fsOG+zMrvSvGgTOz2insHe8tHvHVMVJUlp9ff9hY=
X-Received: by 2002:a62:31c6:0:b0:591:4b17:22b5 with SMTP id
 x189-20020a6231c6000000b005914b1722b5mr645704pfx.14.1675843003468; Tue, 07
 Feb 2023 23:56:43 -0800 (PST)
MIME-Version: 1.0
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com> <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
In-Reply-To: <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
From:   Vincent Guittot <vincent.guittot@linaro.org>
Date:   Wed, 8 Feb 2023 08:56:32 +0100
Message-ID: <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Cc:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Content-Type: text/plain; charset="UTF-8"
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Tue, 7 Feb 2023 at 05:50, Ricardo Neri
<ricardo.neri-calderon@linux.intel.com> wrote:
>
> Using asym_packing priorities within an SMT core is straightforward. Just
> follow the priorities that hardware indicates.
>
> When balancing load from an SMT core, also consider the idle of its
> siblings. Priorities do not reflect that an SMT core divides its throughput
> among all its busy siblings. They only makes sense when exactly one sibling
> is busy.
>
> Indicate that active balance is needed if the destination CPU has lower
> priority than the source CPU but the latter has busy SMT siblings.
>
> Make find_busiest_queue() not skip higher-priority SMT cores with more than
> busy sibling.
>
> Cc: Ben Segall <bsegall@google.com>
> Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
> Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
> Cc: Len Brown <len.brown@intel.com>
> Cc: Mel Gorman <mgorman@suse.de>
> Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
> Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
> Cc: Steven Rostedt <rostedt@goodmis.org>
> Cc: Tim C. Chen <tim.c.chen@intel.com>
> Cc: Valentin Schneider <vschneid@redhat.com>
> Cc: x86@kernel.org
> Cc: linux-kernel@vger.kernel.org
> Suggested-by: Valentin Schneider <vschneid@redhat.com>
> Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
> ---
> Changes since v2:
>  * Introduced this patch.
>
> Changes since v1:
>  * N/A
> ---
>  kernel/sched/fair.c | 31 ++++++++++++++++++++++++++-----
>  1 file changed, 26 insertions(+), 5 deletions(-)
>
> diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
> index 80c86462c6f6..c9d0ddfd11f2 100644
> --- a/kernel/sched/fair.c
> +++ b/kernel/sched/fair.c
> @@ -10436,11 +10436,20 @@ static struct rq *find_busiest_queue(struct lb_env *env,
>                     nr_running == 1)
>                         continue;
>
> -               /* Make sure we only pull tasks from a CPU of lower priority */
> +               /*
> +                * Make sure we only pull tasks from a CPU of lower priority
> +                * when balancing between SMT siblings.
> +                *
> +                * If balancing between cores, let lower priority CPUs help
> +                * SMT cores with more than one busy sibling.
> +                */
>                 if ((env->sd->flags & SD_ASYM_PACKING) &&
>                     sched_asym_prefer(i, env->dst_cpu) &&
> -                   nr_running == 1)
> -                       continue;
> +                   nr_running == 1) {
> +                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> +                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))

This 2nd if could be merged with the upper one
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -10518,11 +10518,10 @@ static struct rq *find_busiest_queue(struct
lb_env *env,
                 */
                if ((env->sd->flags & SD_ASYM_PACKING) &&
                    sched_asym_prefer(i, env->dst_cpu) &&
-                   nr_running == 1) {
-                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
-                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY)
&& is_core_idle(i)))
+                   (nr_running == 1) &&
+                   (env->sd->flags & SD_SHARE_CPUCAPACITY ||
+                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY)
&& is_core_idle(i))))
                                continue;
-               }

                switch (env->migration_type) {
                case migrate_load:
---

AFAICT, you can even remove one env->sd->flags & SD_SHARE_CPUCAPACITY
test with the below but this make the condition far less obvious

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index a6021af9de11..7dfa30c45327 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -10518,11 +10518,10 @@ static struct rq *find_busiest_queue(struct
lb_env *env,
                 */
                if ((env->sd->flags & SD_ASYM_PACKING) &&
                    sched_asym_prefer(i, env->dst_cpu) &&
-                   nr_running == 1) {
-                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
-                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY)
&& is_core_idle(i)))
+                   (nr_running == 1) &&
+                   !(!(env->sd->flags & SD_SHARE_CPUCAPACITY) &&
+                       !is_core_idle(i)))
                                continue;
-               }

> +                               continue;
> +               }
>
>                 switch (env->migration_type) {
>                 case migrate_load:
> @@ -10530,8 +10539,20 @@ asym_active_balance(struct lb_env *env)
>          * lower priority CPUs in order to pack all tasks in the
>          * highest priority CPUs.
>          */
> -       return env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING) &&
> -              sched_asym_prefer(env->dst_cpu, env->src_cpu);
> +       if (env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING)) {
> +               /* Always obey priorities between SMT siblings. */
> +               if (env->sd->flags & SD_SHARE_CPUCAPACITY)
> +                       return sched_asym_prefer(env->dst_cpu, env->src_cpu);
> +
> +               /*
> +                * A lower priority CPU can help an SMT core with more than one
> +                * busy sibling.
> +                */
> +               return sched_asym_prefer(env->dst_cpu, env->src_cpu) ||
> +                      !is_core_idle(env->src_cpu);
> +       }
> +
> +       return false;
>  }
>
>  static inline bool
> --
> 2.25.1
>

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 628DDC61DA4
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Feb 2023 08:08:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229576AbjBIIIV (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 03:08:21 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33046 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229563AbjBIIIS (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 03:08:18 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AD5D43669E
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 00:08:17 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675930097; x=1707466097;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-id:content-transfer-encoding:
   mime-version;
  bh=zA1STHI54ioIO3/OdB0mTXnEzzGoMdZ6tCqCsQkFhWQ=;
  b=Sj17J5Eabq0gjzYSX6I6hwhUg6btgTzMDc92VT0qcRqg8iN5rfUAPS+9
   IHMCI2TanG25LD5KQCWtxjBiQt4sUkEcZ0NI3SFaQGMF02UAp/tfAhztZ
   cAhZ8yQkFaelXi0QLnP5F77DB7uE4ym9y6ojczP+/4H4SROd/Mk5cLWt+
   pJBSlzQq717Rp281yIT0wIiadlU84s5uZtTHPwYJRLLjbz0+4Tzl1BMzg
   REDGRv9mCiqpAZdUFnYPCDu5JCoGb6qgl3HjAjCNWkgCkt49YLr60lVWc
   VczRzmTrmZFJI1leI2AxNJlTP+ioiJqy/Anl+sY3m2ZEQk5YWrhYZPiEJ
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10615"; a="328692823"
X-IronPort-AV: E=Sophos;i="5.97,283,1669104000"; 
   d="scan'208";a="328692823"
Received: from fmsmga001.fm.intel.com ([10.253.24.23])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 00:08:03 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10615"; a="810257427"
X-IronPort-AV: E=Sophos;i="5.97,283,1669104000"; 
   d="scan'208";a="810257427"
Received: from orsmsx601.amr.corp.intel.com ([10.22.229.14])
  by fmsmga001.fm.intel.com with ESMTP; 09 Feb 2023 00:07:56 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 00:07:55 -0800
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 00:07:55 -0800
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Thu, 9 Feb 2023 00:07:55 -0800
Received: from NAM11-BN8-obe.outbound.protection.outlook.com (104.47.58.169)
 by edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Thu, 9 Feb 2023 00:07:54 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=TqS3Aq932QmThrnCMTjTzM2PTXqal7CIo7+uJgPxrW4hBGkOP0r2KIcbR8H+CV+0BOGkvIqmzjxHt7rGq5MHMrIP6NW5NLnUL/oqophlgT7NpF5BYYwLkb25GLbPCNqo0rMChZG2ijY0GGy0OutZ2IXvIqTdioO4+VnkzloxM0olym9Yu/x7w2D1RXJlYkOfmnKAK9UwG5pHd/L2ncgILYdB8L1deOdHVuUef7BISC4m3Z4ksf9i/eSHb3i+XuOjRkeO8yN0NtwWHFVwRxT0rI8VtCPyQVZplwdAFXJKFQ6MGOtaFMeow/aR0NnbDQlAHgnri1iID1t2+WicHIoETw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=zA1STHI54ioIO3/OdB0mTXnEzzGoMdZ6tCqCsQkFhWQ=;
 b=PDG+PkF+QI8SUJlJToYDKfCFlIUDVHxA83jt68iAeSy+/kUe0V8qIBJTlEDYSQ26tpl+6Rbp10qCyTC1nSsnoBkquvJ2eBKDNG+ZzSo7EvP6Ur3ymQtdcB0aT4wSgnT/X73SbxkV6Dnh4CD1mHH70wOc/EmZp8wA59gGCT0D97cuX8aO6YTHfnLixQVbke4VbQmXw6B70zs/T+I5AgOsYvgHInr6VGIEKvpVReP0n9+ux1EEzSiUt1lBozntmwmLFkDvQUe3DVQmkTjp+jC5jU6IfpuBfrqAHZGqvSWWcKm5RQFaJYaWhu1n2tcuoHtabuFZ21GMPk5sLSMNVBIJQg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from SJ0PR11MB6622.namprd11.prod.outlook.com (2603:10b6:a03:478::6)
 by DS0PR11MB7682.namprd11.prod.outlook.com (2603:10b6:8:dc::18) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.17; Thu, 9 Feb
 2023 08:07:52 +0000
Received: from SJ0PR11MB6622.namprd11.prod.outlook.com
 ([fe80::5b0e:bf7:d908:2837]) by SJ0PR11MB6622.namprd11.prod.outlook.com
 ([fe80::5b0e:bf7:d908:2837%8]) with mapi id 15.20.6064.034; Thu, 9 Feb 2023
 08:07:52 +0000
From:   "Zhang, Rui" <rui.zhang@intel.com>
To:     "ricardo.neri-calderon@linux.intel.com" 
        <ricardo.neri-calderon@linux.intel.com>,
        "peterz@infradead.org" <peterz@infradead.org>,
        "juri.lelli@redhat.com" <juri.lelli@redhat.com>,
        "vincent.guittot@linaro.org" <vincent.guittot@linaro.org>
CC:     "dietmar.eggemann@arm.com" <dietmar.eggemann@arm.com>,
        "mgorman@suse.de" <mgorman@suse.de>,
        "Wysocki, Rafael J" <rafael.j.wysocki@intel.com>,
        "tim.c.chen@linux.intel.com" <tim.c.chen@linux.intel.com>,
        "srinivas.pandruvada@linux.intel.com" 
        <srinivas.pandruvada@linux.intel.com>,
        "rostedt@goodmis.org" <rostedt@goodmis.org>,
        "Shankar, Ravi V" <ravi.v.shankar@intel.com>,
        "Neri, Ricardo" <ricardo.neri@intel.com>,
        "vschneid@redhat.com" <vschneid@redhat.com>,
        "bristot@redhat.com" <bristot@redhat.com>,
        "ionela.voinescu@arm.com" <ionela.voinescu@arm.com>,
        "Chen, Yu C" <yu.c.chen@intel.com>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>,
        "Brown, Len" <len.brown@intel.com>,
        "bsegall@google.com" <bsegall@google.com>,
        "x86@kernel.org" <x86@kernel.org>
Subject: Re: [PATCH v3 00/10] sched/fair: Avoid unnecessary migrations within
 SMT domains
Thread-Topic: [PATCH v3 00/10] sched/fair: Avoid unnecessary migrations within
 SMT domains
Thread-Index: AQHZPF2bLBJDh1L8+0C719OssYuiJQ==
Date:   Thu, 9 Feb 2023 08:07:51 +0000
Message-ID: <19416ae84ddbab82cb0419716c4c490ef296d08c.camel@intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
In-Reply-To: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
user-agent: Evolution 3.36.5-0ubuntu1 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: SJ0PR11MB6622:EE_|DS0PR11MB7682:EE_
x-ms-office365-filtering-correlation-id: 255674f5-0a1d-4307-56a2-08db0a74bda8
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: 8kGXXDVfWGnZxIhQ8eMcmetZZ+ebqIEvCtpp0F9we6ZUiFA2/AsSHxd8jFVogXKaDXfFc1hP7vn/4WWcZUaz+c6hi9lF970mC1xteeUnDDay1e+vlP9Z1xtKXGkoWtpfTquRwFJxiX5wClR3nmTrRLyhhuVFgeoChk6ONYjF4EhfbJ0GfNnQ3qLKHvwCPDqHYS4XK/Xgn1SucZUAp244VjXHcBMj7PxyLT9aQ2oKhWXfjG4Z1HD49n2FOQ0aJGh0/f1emMzlinBj1X64dG4jG7mGE0M7gJHyxCfhv6c/R42bptzPABXFbKyLymS+Z79gXrXfyw6aLKutDUYgGSJxOefy0/R/IwJSjL81EdZ3z52ekHe5uhi9v5vykU585++jJk3Yi//KdO7yaTUg60nlVJBIeDEoS4CRM2iRoQP9CJ8YRvR0iM1zqvOMlnbsfOeR4tIQ4YCp1jQgKldbGS+iPxFtI6tFNEwQJFzYpFdifYfzQUP2JKUPWwWR08+34XwpzJx/AcMZh5502mCbKHzpq3j+Ep1EKPS8gvdGt0eb8Lto1t7W0H0xfRepUEdts/v/m1ouU758ybXw/3bpto+Olh51m5Fe+9r4uvxrnzn/XQI32rBwGG79s/SRK7Oe/z1tEX/tiTa2BmYFFGcYfXwM9k2h+FOQrz3mM1OAFV/PiJoJtpIbaAbvH3xFJfCI71vDEhIEBnz2dVA3mVOdJ2nnWV+ARS28la1jH8Yp8l2Pr1zyMyfp4InDbxmbGvaVUXvBJirmHySwTDcuseBDcPZvRg==
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SJ0PR11MB6622.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(376002)(396003)(136003)(366004)(346002)(39860400002)(451199018)(83380400001)(2616005)(478600001)(54906003)(2906002)(316002)(76116006)(110136005)(38070700005)(91956017)(6486002)(38100700002)(71200400001)(82960400001)(36756003)(122000001)(966005)(41300700001)(66946007)(4326008)(66556008)(6506007)(8676002)(5660300002)(8936002)(26005)(7416002)(64756008)(86362001)(66446008)(6512007)(186003)(66476007);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?utf-8?B?aDhlQ0RnUEhoRWRUZjhkSjd1VUkraDUyeGpUenM1MzhobUdMU25xOUYrME9z?=
 =?utf-8?B?Z01qR09kaVo3b1IwK0k3VWZ6S29hS1M2ckJMTDVCQ1RobzBUKzBGdng4QWhR?=
 =?utf-8?B?d0Vld0pNdndKbFMvWEkxbXBiQWR1SnRDREU4UzQrbU5PZjNMViswUWVMYmxD?=
 =?utf-8?B?anZtazczQzJWRW5mM2tMSmV1MEFLa0ZNanlWcy9CeUY3c3Z3eG5sMGUzS1JV?=
 =?utf-8?B?V1JKZndsNjdSc25vYUZVNEF2aFhQUXkzemZLV3hvYVFCdldnYVRHbm9HK3A5?=
 =?utf-8?B?N2xTM1dNS0lyR2ExTEJMTUpSVkN5MEh6cXY3b25TQWZ3QkR4SWsweGpxRkFT?=
 =?utf-8?B?ZzFscS9WK3FmdktQYUI2OFV1UUNOZG4rdW5ObXpNNUZMUkVOMmJFMmpOTXdp?=
 =?utf-8?B?eHFlRzhyQkFPNjFQbFZBRWpoMHZ1QU1MSFluZUk3cGpaOFMxRUU3aU1rSlFw?=
 =?utf-8?B?ZHk5S3FwKytKV2wxVHZjRkZWL3k4eGFpNnM3ZDVIaXMvTVNoR3F5YnlRYVVC?=
 =?utf-8?B?Zkp0YkNIcGFhL3BqZ2x6c2lrZ1U4VTJoTUQ4Qy9lOGJPN0lMUW5xSXluUmtW?=
 =?utf-8?B?aUZYbVlhYlFSZlNyNE9WRGR2QTFORFFaS1YvbVVFTDhuZjJreEE1cjR4WEoz?=
 =?utf-8?B?MS9rOCsxcTRrV0s0VEdFUjBHbVdOU1RxcnVBbGx3a05jWXdWYnlkQW5jc29F?=
 =?utf-8?B?UzdHNDdxZGpuU3cvWU9QUzBtQWxOZ1FXUXNyOG8wQndzZ2JvVmdzWUF5bFFm?=
 =?utf-8?B?d1QwdCt1Q1dtSFhaNWIxdlNnR1BieE9YaWtBV0EySGRlR3hqRVU0WGVoMVpm?=
 =?utf-8?B?eXhTTUE1TzFJTGwrTTR6WENtNklJZEorSlJNK05pT3J4emN1NCtaM0poak4x?=
 =?utf-8?B?RkZrcDVYMnJBU1RYM0pJQ0NMdXBEWVhjY25NTVh6SVdvU09GZlNMVEhFcTBa?=
 =?utf-8?B?Ykltc1pqekkzczhCNDdMTzdhOHNQYnNsajh4YkErYlNkckU2d2pUcUFjbjhL?=
 =?utf-8?B?ZFJxWjc2K1VzKzZDUGpjNm9iOXZDVzRoRmZZdTZSVmYveXdwOHFUMTBmK1FX?=
 =?utf-8?B?SVp4dEtFcEozejE1T3FDSTVnUnRqNzA4YXI0NkhBYmlUd1E2VDlGcUpRODNx?=
 =?utf-8?B?K3UrWUNlbEt2czB0M3ZsVFJITEtETWFXTXFubXZSam9sMVdJRWRLUGZuTExz?=
 =?utf-8?B?UVMrTjIyU3JPdUtzZWlSVWpTTU5yekNwN0pUc1ZaUkcxVlQ4c0l0WGwxY3Z2?=
 =?utf-8?B?bUFBVUNYZ0xOV3BuWVBzZkFYNFd6RFNjL2tPVnEzd3NKN0U3YWJnMGRBTEVQ?=
 =?utf-8?B?eUpsWkQ2WGlWWEVoZUpRRkd1SlM3UDhJNTQ3VWZ0U1dOUnhKbUpTVFNRSkVD?=
 =?utf-8?B?dU5FYk92cWRTY0laRUlGcEYyajVGb2VTQjA2YjZYWGNOQlRWZ2NBWnFsOHNN?=
 =?utf-8?B?RzZickk1c1Y2Um0vdk9lcmt1T0htSjU3MDRCWHFJcVhWQUdEbHIrRVNmY0Vi?=
 =?utf-8?B?c0N5Uk03SU9mNFIvY3JwRkMyMDZnTUU5dU4zNE4wcUxXalowODRNbWZxYTZT?=
 =?utf-8?B?My81QjJCMlo5b01ka214L2FzWkxVUVFENDJZUW9QTmpVeGhmWUdDM3Z0bHJU?=
 =?utf-8?B?cUpPSEtBNDNlWWtiTWRjM1Y0S2piVHo1dkNHRy8xN0VnUG5yWkxSZSs2ZTZp?=
 =?utf-8?B?SnhiNnhMbURyMEV6U0k0R1p6RUsxYjhGZzdGQVMremxPSXRWaW1uTW82MXE2?=
 =?utf-8?B?SC9kRXlVWE5qdG9QaTFhQldEYTFjeDBGdk9rRDkyeFp1NjZUakFmejBKbGlj?=
 =?utf-8?B?R25FdGV1RGwxOFdUMkREMEVXU0doZVJhQnQ0RUVERVo1aUMrQ2cwa3B3dWNx?=
 =?utf-8?B?YXVtSjVlOXRiQVNWa21LRjhFanhxQ1U2SHdUemZHdjFqaXhrUElGdlhPdDhG?=
 =?utf-8?B?THM5S2RtSFNWU051MFZienN2andTY2hVQzJoQjhVYW9XbTRiZmZja0FSRTho?=
 =?utf-8?B?Tk9NK1RxTzQyWTJBVTYyWWJoSHFiR2pabDN0ejg2WEw4TXovSEtoN3ZhN2xw?=
 =?utf-8?B?TmhIZ0VER2JyRHc1MFNSZEovREJYaXNLQzIxN21HbVhWZTRJZzRGakd5dUZm?=
 =?utf-8?B?aEtMYjduRFpjNkFGc3RmOFNvK0h5VEZIWGxDUWVDY2lmK3BUWHpDSjZZOGcx?=
 =?utf-8?B?cmc9PQ==?=
Content-Type: text/plain; charset="utf-8"
Content-ID: <D00529BA352D05499FB749B3C2FD37B9@namprd11.prod.outlook.com>
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: SJ0PR11MB6622.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 255674f5-0a1d-4307-56a2-08db0a74bda8
X-MS-Exchange-CrossTenant-originalarrivaltime: 09 Feb 2023 08:07:51.7155
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: gmmc1Bg1SuwcdGE2b09nEhn3CSk5TlltxzL/57/YSJ2mGyKQmJKhaW9O30UJwjhDkJOzxxdzON0yWVOEXmMA7g==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS0PR11MB7682
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

SGksIEFsbCwNCg0KT24gTW9uLCAyMDIzLTAyLTA2IGF0IDIwOjU4IC0wODAwLCBSaWNhcmRvIE5l
cmkgd3JvdGU6DQo+IEhpLA0KPiANCj4gVGhpcyBpcyB2MyBvZiB0aGlzIHNlcmllcy4gUHJldmlv
dXMgdmVyc2lvbnMgY2FuIGJlIGZvdW5kIGhlcmUgWzFdDQo+IGFuZA0KPiBoZXJlIFsyXS4gVG8g
YXZvaWQgZHVwbGljYXRpb24sIEkgZG8gbm90IGluY2x1ZGUgdGhlIGNvdmVyIGxldHRlciBvZg0K
PiB0aGUNCj4gb3JpZ2luYWwgc3VibWlzc2lvbi4gWW91IGNhbiByZWFkIGl0IGluIFsxXS4NCg0K
SSBoYXBwZW5lZCB0byBydW4gaW50byBhIHNpbWlsYXIgaXNzdWUgd2hlbiB0ZXN0aW5nIGFub3Ro
ZXIgcGF0Y2gNCnNlcmllcyB3aGljaCBhbGxvd3MgaWRsZSBpbmplY3Rpb25zIGZvciBwYXJ0aWFs
IGNwdXMgaW5zdGVhZCBvZiBhbGwNCmNwdXMuIA0KaHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvYWxs
L2E2OGE2ZjhjNzZjYjcxOWNkNDg2NWJkNmFhNzI2MzA2NzcyZDRlZTMuY2FtZWxAaW50ZWwuY29t
Lw0KDQpPbiBhbiBBREwtUCBOVUMgc3lzdGVtIHdpdGggNCBQY29yZXMgKGNwdTAtY3B1NyksIGFu
ZCA4IEVjb3JlcyAoY3B1OC0NCmNwdTE1KSwgdGhlIHByb2JsZW0gY2FuIGJlIHJlcHJvZHVjZWQg
YnkNCjEuIHN0YXJ0IDE2IHN0cmVzcyB0aHJlYWRzDQoyLiBmb3JjZSBpZGxlIGluamVjdGlvbiB0
byBhbGwgRWNvcmUgY3B1cw0KMy4gc3RvcCBpZGxlIGluamVjdGlvbiBhZnRlciAxMCBzZWNvbmRz
DQpBZnRlciBzdGVwIDMsIGFsbCB0aGUgUGNvcmUgY3B1cyBhcmUgMTAwJSBidXN5LCBhbmQgYWxs
IHRoZSBFY29yZSBjcHVzDQphcmUgYWxtb3N0IDEwMCUgaWRsZS4gVGhpcyBzaXR1YXRpb24gbGFz
dHMgZm9yIGEgbG9uZyB0aW1lLCB0aWxsIEkga2lsbA0KYWxsIHRoZSBzdHJlc3MgdGhyZWFkcyBh
ZnRlciAyMCBzZWNvbmRzLg0KDQpBZnRlciBzeW5jIHdpdGggQ2hlbiBZdSwgSSBhbHNvIHRyaWVk
DQoJc3RyZXNzIC1jIDE2ICYNCgljaHJ0IC1yIDcwIHRhc2tzZXQgLWMgOC0xNSBzdHJlc3MgLWMg
OCAtdCAxMA0KaW5zdGVhZCBvZiBpZGxlIGluamVjdGlvbiwgYW5kIHRoZSBwcm9ibGVtIGlzIGFs
c28gMTAwJSByZXByb2R1Y2libGUuDQoNCkFuZCBub3RlIHRoYXQsIHRoZSBwcm9ibGVtIGNhbiBi
ZSByZXByb2R1Y2VkIHcvIGFuZCB3L28gSVRNVCBlbmFibGVkLA0KYnkgcG9raW5nIC9wcm9jL3N5
cy9rZXJuZWwvc2NoZWRfaXRtdF9lbmFibGVkDQoNCldpdGggdGhpcyB3aG9sZSBwYXRjaCBzZXJp
ZXMgYXBwbGllZCwgSSBjYW4gY29uZmlybSB0aGUgcHJvYmxlbSBpcyBnb25lDQpib3RoIHcvIGFu
ZCB3L28gSVRNVCBlbmFibGVkLiBTbw0KDQpUZXN0ZWQtYnk6IFpoYW5nIFJ1aSA8cnVpLnpoYW5n
QGludGVsLmNvbT4NCg0KdGhhbmtzLA0KcnVpDQoNCj4gDQo+IENoYW5nZXMgc2luY2UgdjI6DQo+
IA0KPiBWaW5jZW50IGNvcnJlY3RseSBpbmRpY2F0ZWQgdGhhdCBJIHdhcyBhYnVzaW5nIGFzeW1f
cGFja2luZyB0byBmb3JjZQ0KPiBsb2FkDQo+IGJhbGFuY2VzIHVucmVsYXRlZCB0byBDUFUgcHJp
b3JpdHkuIFRoZSB1bmRlcmx5aW5nIGlzc3VlIGlzIHRoYXQgdGhlDQo+IHNjaGVkdWxlciBjYW5u
b3Qgbm90IGhhbmRsZSBsb2FkIGJhbGFuY2VzIGJldHdlZW4gU01UIGFuZCBub24tU01UDQo+IGNv
cmVzDQo+IGNvcnJlY3RseS4gSSBhZGRlZCBzZXZlcmFsIHByZXdvcmsgcGF0Y2hlcyB0byBmaXgg
aXQuLi4gYW5kIEkgcmVtb3ZlZA0KPiB0aGUNCj4gYWJ1c2Ugb2YgYXN5bV9wYWNraW5nLg0KPiAN
Cj4gRGlldG1hciBoZWxwZWQgbWUgdG8gcmVhbGl6ZSB0aGF0IHRoZXJlIGlzIGEgYmV0dGVyIHdh
eSB0byBjaGVjayB0aGUNCj4gaWRsZQ0KPiBzdGF0ZSBvZiBTTVQgY29yZXMuIE5vdyBJIGdpdmUg
dGhlIHRhc2sgdG8gdGhlIHNjaGVkdWxlciBpbnN0ZWFkIG9mDQo+IGFyY2hpdGVjdHVyZS1zcGVj
aWZpYyBvdmVycmlkZXMuIEkgdW5jb25kaXRpb25hbGx5IG9iZXkgQ1BVDQo+IHByaW9yaXRpZXMN
Cj4gYXQgdGhlIFNNVCBsZXZlbC4gVGhpcyBrZWVwcyBQb3dlcjcgaGFwcHkuIEF0IHVwcGVyIGxl
dmVscyAoaS5lLiwNCj4gd2hlbg0KPiBiYWxhbmNpbmcgbG9hZCBiZXR3ZWVuIGNvcmVzKSB0aGUg
c2NoZWR1bGVyIGFsc28gY29uc2lkZXJzIHRoZSBpZGxlDQo+IHN0YXRlDQo+IG9mIHRoZSBjb3Jl
IGluIGFkZGl0aW9uIHRvIENQVSBwcmlvcml0eS4gVGhpcyBzYXRpc2ZpZXMgeDg2Lg0KPiANCj4g
SW9uZWxhIHNwb3R0ZWQgYSB2aW9sYXRpb24gb2YgdGhlIHNjaGVkdWxlciB0b3BvbG9neSBzYW5p
dHkgY2hlY2tzLg0KPiBXZSBkaWQNCj4gbm90IGZpbmQgYSBjaGVjayB0aGF0IHN1aXRzIGJvdGgg
UG93ZXI3IGFuZCB4ODYuIEZvciBub3csIEkgcmVtb3ZlZA0KPiB0aGUNCj4gTkVFRFNfQ0hJTEQg
ZmxhZyBvZiBTRF9BU1lNX1BBQ0tJTkcuDQo+IA0KPiBIb3BlZnVsbHksIHRoZXNlIHBhdGNoZXMg
YXJlIGluIHN1ZmZpY2llbnRseSBnb29kIHNoYXBlIHRvIGJlIG1lcmdlZC4NCj4gDQo+IFRoYW5r
IHlvdSBmb3IgeW91ciBmZWVkYmFjayBhbmQgSSBsb29rIGZvcndhcmQgdG8gZ2V0dGluZyBtb3Jl
IG9mIGl0IQ0KPiANCj4gTmV3IHBhdGNoZXMgMiwgMywgNCwgNSwgNiwgNywgOA0KPiBVcGRhdGVk
IHBhdGNoZXM6IDENCj4gVW5jaGFuZ2VkIHBhdGNoZXM6IDksIDEwDQo+IA0KPiBCUiwNCj4gUmlj
YXJkbw0KPiANCj4gWzFdLiANCj4gaHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGttbC8yMDIyMDgy
NTIyNTUyOS4yNjQ2NS0xLXJpY2FyZG8ubmVyaS1jYWxkZXJvbkBsaW51eC5pbnRlbC5jb20vDQo+
IFsyXS4gDQo+IGh0dHBzOi8vbG9yZS5rZXJuZWwub3JnL2xrbWwvMjAyMjExMjIyMDM1MzIuMTUw
MTMtMS1yaWNhcmRvLm5lcmktY2FsZGVyb25AbGludXguaW50ZWwuY29tLw0KPiANCj4gDQo+IFJp
Y2FyZG8gTmVyaSAoMTApOg0KPiAgIHNjaGVkL2ZhaXI6IEdlbmVyYWxpemUgYXN5bV9wYWNraW5n
IGxvZ2ljIGZvciBTTVQgY29yZXMNCj4gICBzY2hlZC9mYWlyOiBNb3ZlIGlzX2NvcmVfaWRsZSgp
IG91dCBvZiBDT05GSUdfTlVNQQ0KPiAgIHNjaGVkL2ZhaXI6IE9ubHkgZG8gYXN5bV9wYWNraW5n
IGxvYWQgYmFsYW5jaW5nIGZyb20gZnVsbHkgaWRsZSBTTVQNCj4gICAgIGNvcmVzDQo+ICAgc2No
ZWQvZmFpcjogTGV0IGxvdy1wcmlvcml0eSBjb3JlcyBoZWxwIGhpZ2gtcHJpb3JpdHkgYnVzeSBT
TVQNCj4gY29yZXMNCj4gICBzY2hlZC9mYWlyOiBLZWVwIGEgZnVsbHlfYnVzeSBTTVQgc2NoZWQg
Z3JvdXAgYXMgYnVzaWVzdA0KPiAgIHNjaGVkL2ZhaXI6IFVzZSB0aGUgcHJlZmVyX3NpYmxpbmcg
ZmxhZyBvZiB0aGUgY3VycmVudCBzY2hlZCBkb21haW4NCj4gICBzY2hlZC9mYWlyOiBEbyBub3Qg
ZXZlbiB0aGUgbnVtYmVyIG9mIGJ1c3kgQ1BVcyB2aWEgYXN5bV9wYWNraW5nDQo+ICAgc2NoZWQv
dG9wb2xvZ3k6IFJlbW92ZSBTSEFSRURfQ0hJTEQgZnJvbSBBU1lNX1BBQ0tJTkcNCj4gICB4ODYv
c2NoZWQ6IFJlbW92ZSBTRF9BU1lNX1BBQ0tJTkcgZnJvbSB0aGUgU01UIGRvbWFpbiBmbGFncw0K
PiAgIHg4Ni9zY2hlZC9pdG10OiBHaXZlIGFsbCBTTVQgc2libGluZ3Mgb2YgYSBjb3JlIHRoZSBz
YW1lIHByaW9yaXR5DQo+IA0KPiAgYXJjaC94ODYva2VybmVsL2l0bXQuYyAgICAgICAgIHwgIDIz
ICstLS0tDQo+ICBhcmNoL3g4Ni9rZXJuZWwvc21wYm9vdC5jICAgICAgfCAgIDIgKy0NCj4gIGlu
Y2x1ZGUvbGludXgvc2NoZWQvc2RfZmxhZ3MuaCB8ICAgNSArLQ0KPiAga2VybmVsL3NjaGVkL2Zh
aXIuYyAgICAgICAgICAgIHwgMTc1ICsrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tDQo+IC0t
LS0NCj4gIDQgZmlsZXMgY2hhbmdlZCwgOTkgaW5zZXJ0aW9ucygrKSwgMTA2IGRlbGV0aW9ucygt
KQ0KPiANCg==

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id EE242C05027
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Feb 2023 12:04:32 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229650AbjBIMEb (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 07:04:31 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43680 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230416AbjBIMD6 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 07:03:58 -0500
Received: from desiato.infradead.org (desiato.infradead.org [IPv6:2001:8b0:10b:1:d65d:64ff:fe57:4e05])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id BA1D6611F8
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 03:54:14 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=infradead.org; s=desiato.20200630; h=In-Reply-To:Content-Type:MIME-Version:
        References:Message-ID:Subject:Cc:To:From:Date:Sender:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description;
        bh=UCUngvVeDGt6B+YYkhIGibiFb1IGSWjwVwfCNujk4BI=; b=l+//1wYh/rLyduFvss4rVjF0xd
        Tc9sYONZXA9poNwTLuBJsmoyESKNeVOiiVdEdrcX3683AeYgWgdET0/OMjD08aZseaTPPYlbzJkmp
        AuDqifX0QebPRW8oxRhABgMOUwpjyAK/+iSV7sF5er80DZzH/rPBOreZM3MjlX7wsnNI4KnIJwPr2
        C/yDUmcVWKEe+FzRMpmiNvb9aEqlUukLY3ra8QBABKoLJ85je0IrncidNXAlXGmmZP/Q5eQma3OOx
        Ey2bKbt5MXU/HMsTwHvUHH7glW3VdX3e4xHMOh1Ug83W9uxjLjf79jMPIvXJVYOiztZ7Tb+PmD4rT
        s+gesjDQ==;
Received: from j130084.upc-j.chello.nl ([24.132.130.84] helo=noisy.programming.kicks-ass.net)
        by desiato.infradead.org with esmtpsa (Exim 4.96 #2 (Red Hat Linux))
        id 1pQ5U9-007u19-0S;
        Thu, 09 Feb 2023 11:53:05 +0000
Received: from hirez.programming.kicks-ass.net (hirez.programming.kicks-ass.net [192.168.1.225])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature RSA-PSS (4096 bits) server-digest SHA256)
        (Client did not present a certificate)
        by noisy.programming.kicks-ass.net (Postfix) with ESMTPS id 458C4300293;
        Thu,  9 Feb 2023 12:53:42 +0100 (CET)
Received: by hirez.programming.kicks-ass.net (Postfix, from userid 1000)
        id F2853209F7542; Thu,  9 Feb 2023 12:53:41 +0100 (CET)
Date:   Thu, 9 Feb 2023 12:53:41 +0100
From:   Peter Zijlstra <peterz@infradead.org>
To:     Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
Message-ID: <Y+TexehP3140vxBu@hirez.programming.kicks-ass.net>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
 <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Wed, Feb 08, 2023 at 08:56:32AM +0100, Vincent Guittot wrote:

> > +                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> > +                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
> 
> This 2nd if could be merged with the upper one

Wasn't this exact same condition used in the previous patch as well?
Does it wants to be a helper perhaps?

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id ECD3AC61DA4
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Feb 2023 13:17:45 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230036AbjBINRo (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 08:17:44 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:48504 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229501AbjBINRm (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 08:17:42 -0500
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E61E22D7B
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 05:17:40 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675948660; x=1707484660;
  h=date:from:to:cc:subject:message-id:references:
   in-reply-to:mime-version;
  bh=49LA9jDcxsJaF4ieP04JhJZtpaqbAa5/i2jxA9qC3Xo=;
  b=CnkjcPLaQeYsgeBE9BG5s7y01JLjrCTQz9GIlAAT82wBWhePISTGYH0S
   U+mvnGvrAiGLBqDHgDosmZK9/UxlQmzNsXYGOgu6yhmqEO9zDaGqS4t9C
   sRKiFQV78WKT8IwJatxfTr58bKWtvTeE9Omkmcvzo2u0ty50mV0K/J2TL
   XEjdnx9vrp0WI5KPU8z5K9UE5Nuc+dD19UX+hWYonYLmBMlaoQtMs8aTW
   nPMFBNEo+5KLmp+FxDJACgayrChz4fIs4yUMcjcmgJ39aPhIMGLKYFZAx
   /shL6/29/Q86NigHvkVHCk8GxF4H2KFutgtztLbvn2Ps2CS6xLLZvQP5C
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10615"; a="394688479"
X-IronPort-AV: E=Sophos;i="5.97,283,1669104000"; 
   d="scan'208";a="394688479"
Received: from fmsmga003.fm.intel.com ([10.253.24.29])
  by orsmga105.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 05:17:29 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10615"; a="756398887"
X-IronPort-AV: E=Sophos;i="5.97,283,1669104000"; 
   d="scan'208";a="756398887"
Received: from orsmsx602.amr.corp.intel.com ([10.22.229.15])
  by FMSMGA003.fm.intel.com with ESMTP; 09 Feb 2023 05:17:28 -0800
Received: from orsmsx612.amr.corp.intel.com (10.22.229.25) by
 ORSMSX602.amr.corp.intel.com (10.22.229.15) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 05:17:27 -0800
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX612.amr.corp.intel.com (10.22.229.25) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 05:17:27 -0800
Received: from ORSEDG602.ED.cps.intel.com (10.7.248.7) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Thu, 9 Feb 2023 05:17:27 -0800
Received: from NAM10-MW2-obe.outbound.protection.outlook.com (104.47.55.100)
 by edgegateway.intel.com (134.134.137.103) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Thu, 9 Feb 2023 05:17:27 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=NAuF9fSq5tfvOjXoAhuSCruM0VGE7BmyWArs6IuQXoiHC74f5ASEyqjoIdCddIKZUtfnkP6W8qnFZ89PrnqTux5KRtpilIosH2t/lbZm0Ly/JWXy4z/F2/zfawnQ/PW20LXiHTcEb+kdvaMFK191tdK/5TIAvwnviHG2WB/++fKUn1bmXuOHIOmLbOfuNxXe7VMzXQ7WLS8G6yvO3j0S0HwWZP2s2TMJSG+LNbAUlNQP/SaqF73xjDSvoC0goa7IiQ750ZvElm/UQJ0ZNLml9iWfQwchSObt6fj9zKmsIFZdVKkqcmy0UMgOcOc9L4OvHQdjP0GaAVib+L3xAqar3A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=0KZn3uRNIM3anmW0hUk8Fb4YmxlSUt1bWtJztN4ZTec=;
 b=QSxyClzem2poZxd/p9tA9u4IY2V5gOCckYwl2OxMkE3WseYeZO8+RByjM9OYXJoM5d441qduMjb9Qp/oTt8TDGJgRYOUeuJC5dxnjeuAdp5yNv5M5oXB2JdKAzvIwBq13EGOdv+YYUNBMtBbNs2/L1Sgx8zgxyy6cbgtjmLZDrOkSkgEwB4U7dssu9R5/jd69/ElNG3dEETcH37Dn5kEYAYTwR6nFoQPq4bKH/ysfkHOCvIcn2bgdgcKAug0e4OtlfsXcx8ZvKnEpPyVJJHoBR5Cy0sb+HGi0ezDHzlVFLPmc2Sv2C+VOsKoxMbNWtdjMdr7CCLtE4daKGPikK36yQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from MN0PR11MB6206.namprd11.prod.outlook.com (2603:10b6:208:3c6::8)
 by DS7PR11MB6062.namprd11.prod.outlook.com (2603:10b6:8:75::14) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.17; Thu, 9 Feb
 2023 13:17:25 +0000
Received: from MN0PR11MB6206.namprd11.prod.outlook.com
 ([fe80::cd83:248f:1c9b:c9d]) by MN0PR11MB6206.namprd11.prod.outlook.com
 ([fe80::cd83:248f:1c9b:c9d%8]) with mapi id 15.20.6064.034; Thu, 9 Feb 2023
 13:17:25 +0000
Date:   Thu, 9 Feb 2023 21:17:05 +0800
From:   Chen Yu <yu.c.chen@intel.com>
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
CC:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        "Daniel Bristot de Oliveira" <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        "Valentin Schneider" <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, <x86@kernel.org>,
        <linux-kernel@vger.kernel.org>,
        "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Message-ID: <Y+TyUZg86LYhtWeJ@chenyu5-mobl1>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
X-ClientProxiedBy: SG2PR02CA0024.apcprd02.prod.outlook.com
 (2603:1096:3:17::36) To MN0PR11MB6206.namprd11.prod.outlook.com
 (2603:10b6:208:3c6::8)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: MN0PR11MB6206:EE_|DS7PR11MB6062:EE_
X-MS-Office365-Filtering-Correlation-Id: eb5fa6c0-bdad-4c94-d959-08db0a9ffc2a
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: GlFngzALzsr6ZyIWgvFP5At4sjUoK0q/l+st+rcVWGX7FE1YK9KuEZBAa3Eg8JCFZzsDbLiGIRXqdxpGonYwHGChZfMUjZ/uz9G3aVPowxmdD7KuX+2tyA6od/KV0r53tE8TK2Ad3i0aHqf0I67C/AzIUks+jwxRq1RvWn/yC3Ovj41YRr24nLxNge4d8Jt3iec7XPYbOvagNKQGYEKwbmFS1edlJOQl08NVj4lbzxlbGk0rysPsVGKBU2s0Zdy+DLLop6E6MIXgPZEOnPGhoSZXzj5eE4d8vbk1J1pi0YGtizuEUgY5Nl9rtTlOZIY/zW61cYHuHXodHBIi0shfBIK+zsGWFaZN1DU/7EqfgnVdrYmNsJU2ErOntRg0Z/8peYqtUl2oUUBmEYbVFthiY8o1YVxMS0O0KHdtvDueqzQy3hE7Jg5RlHEiIGKwOWmW6K92NPSiHcsKHGWl+pqNz6vqUj+///648WUvMEEOBKvcwsoTSITF5bxlDvae4AiWpQZJ6S988OyWs1a4lu3GTVfvO18jOGfIgjj3wKcH3B7EjCYgfQ/lZQE4oO1I98OYPZVQDD/X/wXsicNeK3tK32MVHiUoIpPhGMtzteW4dJDAQHfjeZtyeXgs+Fjg/epT/L3nanxWT1J+29rBMFXArS30e1vdA1jMwzoq9u5p8CSyC8PKtkcE4OJZamE2SpYn
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN0PR11MB6206.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(7916004)(346002)(136003)(366004)(39860400002)(376002)(396003)(451199018)(316002)(8676002)(33716001)(66476007)(8936002)(66946007)(6916009)(66556008)(186003)(41300700001)(4326008)(54906003)(5660300002)(86362001)(82960400001)(38100700002)(6512007)(9686003)(6666004)(26005)(6506007)(2906002)(53546011)(478600001)(7416002)(6486002)(83380400001)(67856001);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?us-ascii?Q?2c1ginA8ZI8P/wof/ewa8h6SBBWBBgXW4+FZTSc8bXAaIAFH9fVVXAuMXRK/?=
 =?us-ascii?Q?sHc4WucT2weFzCYZ8eYXCr3IBSJUuWKp0fnCgnPnTzn4r4ku0bY39omxdvv5?=
 =?us-ascii?Q?C0rejmrNBpt09Ww7UO49036EtoQEVKMwIhf6wT2LzQOsSh863LMw9jm4Apho?=
 =?us-ascii?Q?dbPUPi11P35Cm1vVcX1kxn7UWkNCsUXKfmPsV3t4Zxqy02t1pWZfHSymddav?=
 =?us-ascii?Q?adNDoVoCSQfkbTpi6LoGLiONd3AKckk6Ya3LJEXTaAeZovIL3UoGxOMCqr9l?=
 =?us-ascii?Q?rESxoeQWPenHo9k3h8iCnL/cChnfTx05wmD/aluFlbgENaP+UtEStfjA1jru?=
 =?us-ascii?Q?gh7DlFqMIg3O0RMcZMmASNq3PS51rXa7gTWGilFLBDEZVa2yD0pECc4tS6wV?=
 =?us-ascii?Q?mZ8tB3kAn9FDLipAaHJL9KP7/YaSAz/z6BpAivCC677ZyN+GM4m9dsYFhsAO?=
 =?us-ascii?Q?hKqVwL2jDHxM+PuL1B/snji6dd2WiDR+7b6LchvrrvFtnoY5jb1LZ2wxslKe?=
 =?us-ascii?Q?ez1DvZJoGyz5OZEiojLYGSJPZA3MqvA/V+QiGFzWTiv++iCbBEjQvx6hUVT5?=
 =?us-ascii?Q?XjnV1HApNuxig7Tkl1VlhP+5GvuR2miBNoa790S+WyNTFhc6bMk/W1rTQnf/?=
 =?us-ascii?Q?me2LziYVhtuom/3A6PLj1G1ZhTOK9FKpruA3udJxBm/eWjWQqPMofXf2ee0O?=
 =?us-ascii?Q?BW+p+ur+qdul39WwswZeEZsosKXN8ZsPdNjHSJjUYc6kiGCU3oNBIjtjEHUB?=
 =?us-ascii?Q?cefMf5SaG916ekTYBTTMZ+L8StPHC8K6JMw+4n4tUd0CXfe/E5IBSR7NbFqM?=
 =?us-ascii?Q?TSxMCh2c36UmciyvqQjj2j0AwSkL3h4iUUS6ZtR6771vjMBubyqoa6bqTNBc?=
 =?us-ascii?Q?ctANIF8t9bCShsJvnmBFxOdBlZ/wwWY5z3J3SpC98IWYT9hpkVfMhsLtls6c?=
 =?us-ascii?Q?XLB8WXgWG3nSD4hKJINIs0+WRlxadP4389QUWm6rCdTc0UI1PEgEHEMtzO77?=
 =?us-ascii?Q?X4ixA9K56b6/vjei4Ckc5PUZVZBMelwdxqcGyzBKGA1rgI7ovmHe3HnP6k93?=
 =?us-ascii?Q?Ezv5j3ysXdAPzdXvMQZIeJRqa2hCjFDmVIxzpjdRzOQgjkHzjfQZOzbXR7tk?=
 =?us-ascii?Q?cjuq13GbrCnydGnEXtgbXw3tsOQZVVtWrmSR1Fg3n+kACsA6wGyc1pC/MWu0?=
 =?us-ascii?Q?6QyikV8jT01coQD1wyXkZJ9dwD9npenm1/TO28KA8C5TCnHb4Si9fMwMsrZ1?=
 =?us-ascii?Q?MfJ8VAnSSdiX+JsLd6ThOFNeuwPzv4jAWGsNkdDEaIAVOdJgCErEnw6g6JCY?=
 =?us-ascii?Q?r1JlwUjGN5L2R/uWbKwk2ScOE3sotGlhmV1ZCvPTtDCUTjMnYHkWBP1iMqKM?=
 =?us-ascii?Q?xB5HbqBmLcUtY1e9tdqwkO21l6+liWp6DBIOKRS5gaBouQmF8ES3A/qQWaI2?=
 =?us-ascii?Q?VovvfAm8w6vYhOJlh6n1kaqiNevagB6FTSeZJoicSj9Pih6yNJre6TNa+Ch7?=
 =?us-ascii?Q?vO3lp9B4h9JpdRZFWSNRwOulrjAxmfaaTVDzGaCTpNYEGRKsapKDS8k8LXw8?=
 =?us-ascii?Q?jORlceAQcd2nZDN0oh2y0G06emYZSW+MNvoAH3nm?=
X-MS-Exchange-CrossTenant-Network-Message-Id: eb5fa6c0-bdad-4c94-d959-08db0a9ffc2a
X-MS-Exchange-CrossTenant-AuthSource: MN0PR11MB6206.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 09 Feb 2023 13:17:25.1988
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: TxD0OuveyPihvrOI6e5FjILbcQ3z8D2+6oI9nUetfMNGm9oSeAVldNOEgUSGswKh0FYL5whCdXKeRoR/sE82rQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DS7PR11MB6062
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 2023-02-06 at 20:58:34 -0800, Ricardo Neri wrote:
> SD_PREFER_SIBLING is set from the SMT scheduling domain up to the first
> non-NUMA domain (the exception is systems with SD_ASYM_CPUCAPACITY).
> 
> Above the SMT sched domain, all domains have a child. The SD_PREFER_
> SIBLING is honored always regardless of the scheduling domain at which the
> load balance takes place.
> 
> There are cases, however, in which the busiest CPU's sched domain has
> child but the destination CPU's does not. Consider, for instance a non-SMT
> core (or an SMT core with only one online sibling) doing load balance with
> an SMT core at the MC level. SD_PREFER_SIBLING will not be honored. We are
> left with a fully busy SMT core and an idle non-SMT core.
> 
> Avoid inconsistent behavior. Use the prefer_sibling behavior at the current
> scheduling domain, not its child.
> 
> The NUMA sched domain does not have the SD_PREFER_SIBLING flag. Thus, we
> will not spread load among NUMA sched groups, as desired.
> 
> Cc: Ben Segall <bsegall@google.com>
> Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
> Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
> Cc: Len Brown <len.brown@intel.com>
> Cc: Mel Gorman <mgorman@suse.de>
> Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
> Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
> Cc: Steven Rostedt <rostedt@goodmis.org>
> Cc: Tim C. Chen <tim.c.chen@intel.com>
> Cc: Valentin Schneider <vschneid@redhat.com>
> Cc: x86@kernel.org
> Cc: linux-kernel@vger.kernel.org
> Suggested-by: Valentin Schneider <vschneid@redhat.com>
> Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
> ---
> Changes since v2:
>  * Introduced this patch.
> 
> Changes since v1:
>  * N/A
> ---
>  kernel/sched/fair.c | 10 +++++-----
>  1 file changed, 5 insertions(+), 5 deletions(-)
> 
> diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
> index df7bcbf634a8..a37ad59f20ea 100644
> --- a/kernel/sched/fair.c
> +++ b/kernel/sched/fair.c
> @@ -10004,7 +10004,6 @@ static void update_idle_cpu_scan(struct lb_env *env,
>  
>  static inline void update_sd_lb_stats(struct lb_env *env, struct sd_lb_stats *sds)
>  {
> -	struct sched_domain *child = env->sd->child;
>  	struct sched_group *sg = env->sd->groups;
>  	struct sg_lb_stats *local = &sds->local_stat;
>  	struct sg_lb_stats tmp_sgs;
> @@ -10045,9 +10044,11 @@ static inline void update_sd_lb_stats(struct lb_env *env, struct sd_lb_stats *sd
>  		sg = sg->next;
>  	} while (sg != env->sd->groups);
>  
> -	/* Tag domain that child domain prefers tasks go to siblings first */
> -	sds->prefer_sibling = child && child->flags & SD_PREFER_SIBLING;
> -
> +	/*
> +	 * Tag domain that @env::sd prefers to spread excess tasks among
> +	 * sibling sched groups.
> +	 */
> +	sds->prefer_sibling = env->sd->flags & SD_PREFER_SIBLING;
>
This does help fix the issue that non-SMT core fails to pull task from busy SMT-cores.
And it also semantically changes the definination of prefer sibling. Do we also
need to change this:
        if ((sd->flags & SD_ASYM_CPUCAPACITY) && sd->child)
                sd->child->flags &= ~SD_PREFER_SIBLING;
might be:
        if ((sd->flags & SD_ASYM_CPUCAPACITY))
                sd->flags &= ~SD_PREFER_SIBLING;

thanks,
Chenyu

> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 3F48BC61DA4
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Feb 2023 20:00:34 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229646AbjBIUAd (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 15:00:33 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43546 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229461AbjBIUAb (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 15:00:31 -0500
Received: from mga03.intel.com (mga03.intel.com [134.134.136.65])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 613785A9F0
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 12:00:29 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675972830; x=1707508830;
  h=from:to:cc:subject:date:message-id:references:
   in-reply-to:content-transfer-encoding:mime-version;
  bh=kn9IENlnqi7Pv01ITVzyt5hElSTJ0FIij6j1rdDZIJQ=;
  b=F+Yu0XtmTDKHJktMaAcGVuC6ZMCKz7z3Ncz/qEZpe7VWoNKeSh5sLHSk
   xQUPp6+lEfcUfwamsVrp8H4ZujRX3kGG89alg+XR8X1DuSFKSxj/F2aZc
   e6mVq61g9TwN7PHNgqRaZJHejTK/d8Fmy5NzH27TSoSGC+YiT8bk2G+xh
   amHP4aFJym5HL3WT6wDkduq+STnDAaU4Joxw8jA4jVm6zghUutStDo8NA
   X7JN8EhwqVlJpArWS84Ib6w8/JBm90DTj36s29aY0XzmkwI04prVNBFy0
   rxWamtn94Tx98TQdFfhUAkpTesHdmhWwwlpEw5tGN62dVAn/mGXm+vKGH
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="332362152"
X-IronPort-AV: E=Sophos;i="5.97,284,1669104000"; 
   d="scan'208";a="332362152"
Received: from orsmga002.jf.intel.com ([10.7.209.21])
  by orsmga103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 12:00:28 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="667802943"
X-IronPort-AV: E=Sophos;i="5.97,284,1669104000"; 
   d="scan'208";a="667802943"
Received: from orsmsx601.amr.corp.intel.com ([10.22.229.14])
  by orsmga002.jf.intel.com with ESMTP; 09 Feb 2023 12:00:28 -0800
Received: from orsmsx610.amr.corp.intel.com (10.22.229.23) by
 ORSMSX601.amr.corp.intel.com (10.22.229.14) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 12:00:28 -0800
Received: from orsedg603.ED.cps.intel.com (10.7.248.4) by
 orsmsx610.amr.corp.intel.com (10.22.229.23) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Thu, 9 Feb 2023 12:00:28 -0800
Received: from NAM10-DM6-obe.outbound.protection.outlook.com (104.47.58.102)
 by edgegateway.intel.com (134.134.137.100) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Thu, 9 Feb 2023 12:00:21 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=m8F/YXuBDTcx7piO1A8CiYla1V5Xut0UQuJdOjfa+1HTBMyQTiRJskB/NfWYdbtpCz+7FQRjjpFAMPWsuH4b59UlCYF4GHeUdGni0IwYpbMi1z7Hqn6wCnb84q8U/dA7m+9p63FBe6TzuWAgswZB376Oz3n3ih68GdOWOTori7CAjh9FN1Lu0eNqLDM+qAt0TQzLzD1Kq/ArGrAjNygUDh2Xwyk8yVfvSWlOtOPbaw2wO1WtLZahQp8Q/tlu3GBrPUdrEnXXG0VS5dhtjCCWrp9/NjaBFbGOo5ZY1p6nHbqe4mpZ7iakQKZf+OFiO4y37sP0oGhGoxQxiu+XtuogBw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=pFRFj74CCU6yoXy7tOUcAvClfoL+JY0H3/mqnPVfqJ0=;
 b=fKpTUSvcTNG+7KKOXi9VTVdlG4/9J+qP1Ku++HNoynV5pva1486CWvtqtFnyO2B4mWvRYJK8XDEVWTZpiQjwgkLnXIfRpBgpzn5NrCWSVfWBWRuXFa3msFHYZJ8+dpLtflQoeMH2AYacHd3SHFOtSs+LW6dAsIEniU+c10gzD4517oms8EadAm0u3+JCBEi0FqW+PtSFZsqT3+58JkF1uQUISQb1KcmfZjHkq8zG5YifJeBvLmTC0v6VdwsEDP9rZXNz0z02SkWIqxhRafpvCNljnKBu4bm24beNVGq84yCDjPmo8u7qurB+z5CVkAgFDZ0dE+L0pxoswfwRJblnxA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Received: from DM6PR11MB4107.namprd11.prod.outlook.com (2603:10b6:5:198::24)
 by PH7PR11MB6651.namprd11.prod.outlook.com (2603:10b6:510:1a9::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.19; Thu, 9 Feb
 2023 20:00:20 +0000
Received: from DM6PR11MB4107.namprd11.prod.outlook.com
 ([fe80::b04d:cf89:581f:2dd2]) by DM6PR11MB4107.namprd11.prod.outlook.com
 ([fe80::b04d:cf89:581f:2dd2%7]) with mapi id 15.20.6086.017; Thu, 9 Feb 2023
 20:00:20 +0000
From:   "Chen, Tim C" <tim.c.chen@intel.com>
To:     "Chen, Yu C" <yu.c.chen@intel.com>,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
CC:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        "Neri, Ricardo" <ricardo.neri@intel.com>,
        "Shankar, Ravi V" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        "Daniel Bristot de Oliveira" <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        "Brown, Len" <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Wysocki, Rafael J" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        "Valentin Schneider" <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>,
        "x86@kernel.org" <x86@kernel.org>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>
Subject: RE: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Thread-Topic: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Thread-Index: AQHZOq/DtsWPHSzMLEmo6OdAAD06ha7GnDyAgABmInA=
Date:   Thu, 9 Feb 2023 20:00:19 +0000
Message-ID: <DM6PR11MB4107F95164772B40B92F66A6DCD99@DM6PR11MB4107.namprd11.prod.outlook.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+TyUZg86LYhtWeJ@chenyu5-mobl1>
In-Reply-To: <Y+TyUZg86LYhtWeJ@chenyu5-mobl1>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
authentication-results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
x-ms-publictraffictype: Email
x-ms-traffictypediagnostic: DM6PR11MB4107:EE_|PH7PR11MB6651:EE_
x-ms-office365-filtering-correlation-id: c8cf5345-a0a1-4414-1069-08db0ad8456f
x-ms-exchange-senderadcheck: 1
x-ms-exchange-antispam-relay: 0
x-microsoft-antispam: BCL:0;
x-microsoft-antispam-message-info: Bd1tyhUUfaO+LRg6pyUOsskeJww3d2HHTt8Lf1PH7PgOhilaidK7u5lcSvePU93jd0CEkdh72DkbQoTqzn78ImziG1Sr8y1MVrJiIGHnEUcisg/QgGAEoqQEXwZUm7eOiRIljY89OWx+BtkozxyXTCz9Zyhy89PIHQFfTDfQ6fVQ8VI0H2zczGaRf4mGLpA5JpgbLh9ZdCc14cPfHPm6t9XPhJshs8MmAUFYQcdNaAG8nCxPKipUVwlAckXVrwVltmROnlra+atJyHiX+FlPmMMywGFSLjjGRVQtWuYyQRqLSAzGEVs6mo5xzd8ghWEwj/HphsPDI9dIHutsDDdXEztyrNCp9XATk2/2dSw+EwZXwTJUenVb4cN4DGcIp1/3O4lklI+a+9zYhdS4oPhXP4sEeQJnw5nuN1SCQK+L/3wnoUIJzDf1SlpGw6YQyjMEc1V2zsGxY9LujWiDK0vIllVI0TnQSN+xZp7d+Fo4clsBjgaVTDMia4IWdDzWneaRLXz6DKDJXpYrba8oPW41ILaFUNEa/qaXEPczVuM5FyawMf9kFhLOs+y/kgs9HDpaoytH1JDamGAJjH5waFeWOlAeG3h6/Ol5ffXe33SStysauZyutDztJl9twNDzNs6HCC27PLwop8w4Ajub9nnBWTHxEfhSRG2iS4qoVxYaMZVZNy7SZfZlX+ofdSsS4gNJVep0mtchN8wdl1/Kl+lVUw==
x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR11MB4107.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(346002)(39860400002)(376002)(366004)(396003)(136003)(451199018)(2906002)(33656002)(7696005)(71200400001)(83380400001)(6506007)(9686003)(186003)(26005)(478600001)(8676002)(66556008)(64756008)(66446008)(8936002)(55016003)(76116006)(66476007)(66946007)(86362001)(122000001)(5660300002)(7416002)(316002)(82960400001)(41300700001)(4326008)(38100700002)(52536014)(110136005)(38070700005)(54906003);DIR:OUT;SFP:1102;
x-ms-exchange-antispam-messagedata-chunkcount: 1
x-ms-exchange-antispam-messagedata-0: =?us-ascii?Q?XS6q0Bo/IcCWuXuPCkaaK9hLj/GaaGhoGJj0fSQ5YNKibpM2JgskfKL/CUtX?=
 =?us-ascii?Q?MzlcL/Szb089oiUZtrX7VwH1V+NlG41zzAWYE05zmg9qoq7gC9/+GLENZnPl?=
 =?us-ascii?Q?k0XXkmg1wDU0HVhj7+LVE3rEHP6NKOZCXcsfxzenRKIaYxvTuA/1geuIBkqi?=
 =?us-ascii?Q?Y4IMCytZlfDlhCpRC4frYnfNKa7e5D1caiqsvxaslEpVlJt6N+ifSZRnsxps?=
 =?us-ascii?Q?QobGHiGBbVG0Cka0p/17YTmH0dZenf8nH1M9n5qyew/V+NoCjgMYdeQ7i0Cf?=
 =?us-ascii?Q?4fm1qo8LaOCn7lRMwaVymKIaFRIV08aWj5VZCUDdjnSc4LXiMvEbqNBDPOox?=
 =?us-ascii?Q?KYb9jRw8CS6YYTpSxnUjHRhgJD8asXfkQM13fPMjmQ62APuU9o3kVcKzfVTZ?=
 =?us-ascii?Q?PBRmvH05KNm/FqQm3nenJ1cdvvlIwrKCxfSRH2zyiYnUpJ4lUKRSoZ+ODSEc?=
 =?us-ascii?Q?D0tb6rQZpJ4IAIxwSxVdIy/3TaoftiLsDdjSljhPo72Mu2Nph22hVPLtNt/S?=
 =?us-ascii?Q?IXXDliVPFZKV9oQ383AN63/RgUImV8bkJ/MllSKWhveinLbw+88iFfP58mkD?=
 =?us-ascii?Q?cHkEumHg6v4NRfweQCt1w7XQScyG6tkG7Ur/TPMTmR/fhbEzRmgxDNnepIKa?=
 =?us-ascii?Q?PlMPqaOaFOUYAtolz540xxlGAv0Ay+snbs+t0vF3WQFt0uI2NKxUgxhjJ1dP?=
 =?us-ascii?Q?Qt7ixInyNY0R4pcCPefgoWGBltMga7spXw/y93OVKCzl3bOIMckDUyOL/t2s?=
 =?us-ascii?Q?bkP9wfkTxzGRVqtgJlRjcVFNyMzKQUhJLkhYVaNMepYb8QAuz2VjZ+V+kPG3?=
 =?us-ascii?Q?1jAkX2fPSiqh0a0YOjX0S/naLwtWUx67Vv0ElvqJ4+l+37UH0sS0xb4Uptt1?=
 =?us-ascii?Q?EgqwKM6C1f7egEcxVc+HtCnLInB724067vukXcmtvssrSP1cvBwyKAQU9iFk?=
 =?us-ascii?Q?2lxYyDxkhobkv4SWroQk3LKzNDzrJSKrs0OS8GSWqDAEQNtE5e1pGKP8JK3t?=
 =?us-ascii?Q?MGdnnxFWJPWNpbwHDQwfWU2Zde+rNpeKelhrfYS9vxmAU9eJvMltoLkJBrQ1?=
 =?us-ascii?Q?PwfdJbXsyjtSmcWMD/opWoUj8dGapaoeJsdAqWx3T60JdvR1cUvU6JVuBLqo?=
 =?us-ascii?Q?K/FvxwtpRx41NnHHUceE97ZqiZhWRlMF4KovtMKpSTaFwlu2ytgpJnnstPab?=
 =?us-ascii?Q?fZXQv6wD+2TAH0fpTWWjruuQrPK0yINHaR0QKX94u5LwHak/t+4Zx5pKWqHz?=
 =?us-ascii?Q?vuAQgWV9AuRS0I0ztDyXBjBjr3dXz3m6Tw5iP0KmafTJtyaAikwrrT0S2I9i?=
 =?us-ascii?Q?9mT9GedahP5ITBQnQfLzOlkaUtcOsGW9KN7DqcaL1VHNZ4erhHhnEgfIaFuT?=
 =?us-ascii?Q?+YNMl/PHUKgFnu98FYe+glbWssXZIFRynFdWWzk+Enber8upSlmcQi6Cvdpq?=
 =?us-ascii?Q?EjW8uHjV6S3lcVtQ4D8dxQ4C/eY9B5yPfdGsE71Trh46+dOZ2VY2lTUXb6nc?=
 =?us-ascii?Q?r5JuO6eHXnP/dnwaIRNvv1+mmw3MVjq1yvYOpkTti4Z6YuVM1waWaef0NbQE?=
 =?us-ascii?Q?ZsJ8SR/usNepDPrlCu1mhYPxvMdJlSSrdr/u1L6K?=
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-AuthSource: DM6PR11MB4107.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-Network-Message-Id: c8cf5345-a0a1-4414-1069-08db0ad8456f
X-MS-Exchange-CrossTenant-originalarrivaltime: 09 Feb 2023 20:00:19.6864
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: FYUvfhuZ1+SlmTq+XPTCBg2vJJFPVI5Hp1IRO3Izeq/YoxK7PEv+RmoGvlpJPT6nVkKGBZIPDxoB57hMCdW4tw==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: PH7PR11MB6651
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

>>  static inline void update_sd_lb_stats(struct lb_env *env, struct
>> sd_lb_stats *sds)  {
>> -	struct sched_domain *child =3D env->sd->child;
>>  	struct sched_group *sg =3D env->sd->groups;
>>  	struct sg_lb_stats *local =3D &sds->local_stat;
>>  	struct sg_lb_stats tmp_sgs;
>> @@ -10045,9 +10044,11 @@ static inline void update_sd_lb_stats(struct
>lb_env *env, struct sd_lb_stats *sd
>>  		sg =3D sg->next;
>>  	} while (sg !=3D env->sd->groups);
>>
>> -	/* Tag domain that child domain prefers tasks go to siblings first */
>> -	sds->prefer_sibling =3D child && child->flags & SD_PREFER_SIBLING;
>> -
>> +	/*
>> +	 * Tag domain that @env::sd prefers to spread excess tasks among
>> +	 * sibling sched groups.
>> +	 */
>> +	sds->prefer_sibling =3D env->sd->flags & SD_PREFER_SIBLING;
>>
>This does help fix the issue that non-SMT core fails to pull task from bus=
y SMT-
>cores.
>And it also semantically changes the definination of prefer sibling. Do we=
 also
>need to change this:
>        if ((sd->flags & SD_ASYM_CPUCAPACITY) && sd->child)
>                sd->child->flags &=3D ~SD_PREFER_SIBLING; might be:
>        if ((sd->flags & SD_ASYM_CPUCAPACITY))
>                sd->flags &=3D ~SD_PREFER_SIBLING;
>

Yu,

I think you are talking about the code in sd_init()=20
where SD_PREFER_SIBLING is first set
to "ON" and updated depending on SD_ASYM_CPUCAPACITY.  The intention of the=
 code
is if there are cpus in the scheduler domain that have differing cpu capaci=
ties,
we do not want to do spreading among the child groups in the sched domain.
So the flag is turned off in the child group level and not the parent level=
. But with your above
change, the parent's flag is turned off, leaving the child level flag on.=20
This moves the level where spreading happens (SD_PREFER_SIBLING on)=20
up one level which is undesired (see table below).

							SD_PREFER_SIBLING after init            =20
							original code	proposed
SD Level		 SD_ASYM_CPUCAPACITY	=20
root			ON				ON		OFF      	(note: SD_PREFER_SIBLING unused at this level)		=
	=09
first level                           ON				OFF		OFF
second level                     OFF				OFF		ON
third level                         OFF				ON		ON

Tim

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 07F82C05027
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Feb 2023 23:05:23 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229944AbjBIXFV (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 18:05:21 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:56648 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230198AbjBIXFT (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 18:05:19 -0500
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 050D55EBD8
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 15:05:17 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675983918; x=1707519918;
  h=message-id:subject:from:to:cc:date:in-reply-to:
   references:content-transfer-encoding:mime-version;
  bh=ZnpWvhrsnOHWT2J4PDCH2JyXOHu3BBAJ/Ce+aCda5ww=;
  b=WJNkAjSUegaw3ucyrxuIgOTwji0wggP4jOAS5O6nBkeq34f9drZSXA5X
   MEj+u+Wm2oPUdkNSFYfya384vVx2sl5WYwAf1L/5RPLxhtpUgzPSW3Y+n
   9hhTe21oBy/kPiEwGavY82cSnH0PtI8zcWJ7Dyrs447iPcr6KcjX+GUej
   jAaF1Ry5Z4B4Qsqlu+k78pNtwNLkxmAwJz2cFECmi2rta2XLShYUTDW7b
   HCLbjY3k86kxRKTpTnQSakq7uXUG5sc3KWR54EoZkBrQorpBhxRf4Nzp5
   0ArOAA+cJrXQv/arVDGgcO8cR6chyq4GiViHyLI2EdTXbZEVX/awy9To7
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="394871512"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="394871512"
Received: from fmsmga008.fm.intel.com ([10.253.24.58])
  by orsmga105.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 15:05:17 -0800
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="731512191"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="731512191"
Received: from bccrane-mobl.amr.corp.intel.com (HELO [10.209.107.113]) ([10.209.107.113])
  by fmsmga008-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 15:05:16 -0800
Message-ID: <fb63369b2fc686730adefb6800eae4877e62e3b6.camel@linux.intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
From:   Tim Chen <tim.c.chen@linux.intel.com>
To:     "Chen, Tim C" <tim.c.chen@intel.com>,
        "Chen, Yu C" <yu.c.chen@intel.com>,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Cc:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        "Neri, Ricardo" <ricardo.neri@intel.com>,
        "Shankar, Ravi V" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        "Brown, Len" <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Wysocki, Rafael J" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>,
        "x86@kernel.org" <x86@kernel.org>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>
Date:   Thu, 09 Feb 2023 15:05:03 -0800
In-Reply-To: <DM6PR11MB4107F95164772B40B92F66A6DCD99@DM6PR11MB4107.namprd11.prod.outlook.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
         <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
         <Y+TyUZg86LYhtWeJ@chenyu5-mobl1>
         <DM6PR11MB4107F95164772B40B92F66A6DCD99@DM6PR11MB4107.namprd11.prod.outlook.com>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable
User-Agent: Evolution 3.44.4 (3.44.4-2.fc36) 
MIME-Version: 1.0
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, 2023-02-09 at 20:00 +0000, Chen, Tim C wrote:
> > > =C2=A0static inline void update_sd_lb_stats(struct lb_env *env, struc=
t
> > > sd_lb_stats *sds)=C2=A0 {
> > > -=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0struct sched_domain *child=
 =3D env->sd->child;
> > > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0struct sched_group *s=
g =3D env->sd->groups;
> > > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0struct sg_lb_stats *l=
ocal =3D &sds->local_stat;
> > > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0struct sg_lb_stats tm=
p_sgs;
> > > @@ -10045,9 +10044,11 @@ static inline void
> > > update_sd_lb_stats(struct
> > lb_env *env, struct sd_lb_stats *sd
> > > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=
=A0=C2=A0=C2=A0=C2=A0=C2=A0sg =3D sg->next;
> > > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0} while (sg !=3D env-=
>sd->groups);
> > >=20
> > > -=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0/* Tag domain that child d=
omain prefers tasks go to
> > > siblings first */
> > > -=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0sds->prefer_sibling =3D ch=
ild && child->flags &
> > > SD_PREFER_SIBLING;
> > > -
> > > +=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0/*
> > > +=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0 * Tag domain that @env::s=
d prefers to spread excess
> > > tasks among
> > > +=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0 * sibling sched groups.
> > > +=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0 */
> > > +=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0sds->prefer_sibling =3D en=
v->sd->flags & SD_PREFER_SIBLING;
> > >=20
> > This does help fix the issue that non-SMT core fails to pull task
> > from busy SMT-
> > cores.
> > And it also semantically changes the definination of prefer
> > sibling. Do we also
> > need to change this:
> > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0 if ((sd->flags & SD_ASYM_CPUCAPACI=
TY) && sd->child)
> > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=
=A0=C2=A0=C2=A0 sd->child->flags &=3D ~SD_PREFER_SIBLING; might be:
> > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0 if ((sd->flags & SD_ASYM_CPUCAPACI=
TY))
> > =C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=
=A0=C2=A0=C2=A0 sd->flags &=3D ~SD_PREFER_SIBLING;
> >=20
>=20
> Yu,
>=20
> I think you are talking about the code in sd_init()=20
> where SD_PREFER_SIBLING is first set
> to "ON" and updated depending on SD_ASYM_CPUCAPACITY.=C2=A0 The intention
> of the code
> is if there are cpus in the scheduler domain that have differing cpu
> capacities,
> we do not want to do spreading among the child groups in the sched
> domain.
> So the flag is turned off in the child group level and not the parent
> level. But with your above
> change, the parent's flag is turned off, leaving the child level flag
> on.=20
> This moves the level where spreading happens (SD_PREFER_SIBLING on)=20
> up one level which is undesired (see table below).
>=20
>=20
Sorry got a bad mail client messing up the table format.  Updated below

			SD_ASYM_CPUCAPACITY	SD_PREFER_SIBLING after init            =20
						original code 	proposed
SD Level		 	=20
root			ON			ON		OFF      (note: SD_PREFER_SIBLING unused at this level)			=
=09
first level             ON			OFF		OFF
second level		OFF			OFF		ON
third level             OFF			ON		ON

Tim						=09

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 53DE2C61DA4
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 00:37:41 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229987AbjBJAhj (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 19:37:39 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:53782 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231221AbjBJAhM (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 19:37:12 -0500
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E2E377095E
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 16:36:41 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675989401; x=1707525401;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=GBLao6NE/SGSwkVRdGz+EqF+VC4oUdgalsbEcOSG9sM=;
  b=RujB3omMHyN6h00KRwsuBoQwZ/FNlqadQW5gV91AO5ammcn+eHFzxUvR
   eq+IQtnImvDiliIieT/lVIT7BsmkXpjXLam1PovGPdGgrnUzSpQiAcUmX
   aQ7XrannDl2ocFATXpvXPWOjCaJkvnoasG4t8F5LoL1ccER18mk6M9RB4
   LCwCt4mSLgOlAdhhgp37QyNVS0DRWYYrh8Z2jEaskqqQBWuutQSkKNcUV
   UGpXA/MKEgdLicaCykdfBBqQkLcdNaH+AQSG0pwwK6NTDbgwMYx6iAsmX
   hSxqM3xi2oKTmlH502Mu0eDvAPjQMpsHV/7fz0hiw9OG5kNooqx78RLd2
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="310656321"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="310656321"
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
  by fmsmga107.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 16:33:50 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="736556385"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="736556385"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga004.fm.intel.com with ESMTP; 09 Feb 2023 16:33:49 -0800
Date:   Thu, 9 Feb 2023 16:43:33 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Peter Zijlstra <peterz@infradead.org>
Cc:     Vincent Guittot <vincent.guittot@linaro.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
Message-ID: <20230210004333.GA6166@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
 <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
 <Y+TexehP3140vxBu@hirez.programming.kicks-ass.net>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Y+TexehP3140vxBu@hirez.programming.kicks-ass.net>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Feb 09, 2023 at 12:53:41PM +0100, Peter Zijlstra wrote:
> On Wed, Feb 08, 2023 at 08:56:32AM +0100, Vincent Guittot wrote:
> 
> > > +                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> > > +                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
> > 
> > This 2nd if could be merged with the upper one
> 
> Wasn't this exact same condition used in the previous patch as well?
> Does it wants to be a helper perhaps?

Patch 3 focuses on the destination CPU: make sure that it and its SMT
siblings are idle before attempting to do asym_packing balance.

This patch focuses on the busiest group: if the busiest group is an SMT
core with more than one busy sibling, help it even if it has higher
priority.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 10F13C61DA4
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 01:42:42 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229861AbjBJBmk (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 20:42:40 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:39432 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229587AbjBJBmi (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 20:42:38 -0500
Received: from mga06.intel.com (mga06b.intel.com [134.134.136.31])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 254BD5EF8B
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 17:42:37 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675993357; x=1707529357;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=0vWdaRA3I6pRFfk58mBMWBVnNs42iOinDcDzB200ag4=;
  b=MKHbVJZnrZJd4IoIkM4Qno09IdW3teDdnezDZC5n4hAjKprHGAgbVSCp
   VnTLuatr9MOjh4t1Nh7uUR6RqVH1gcQYZf2vSPmgTu9VFeKoWO03sX2z2
   nFB1Kw4j8I3c7yxWAaOO8FOxLKHgOWfIB2+41sBxBX5MJoEKQTlNio553
   IoDr0QuUjgsjBCZptW55oY3N8ZDxwEs9yvhDOCpqC732Dq8Yi+TGrhjWR
   ZoPeXqutKIsDlT1WJjmXRSBzd8FZXMiFFtz8YIFYK7Xc7gt5uSWUlK/Sb
   xzQLiek849PKKlpgm8VVoAk8xfPEr4tLEtrqQmu01VZMGXlR6Q7T3umO/
   w==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="392706243"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="392706243"
Received: from orsmga004.jf.intel.com ([10.7.209.38])
  by orsmga104.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 17:42:36 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="791805779"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="791805779"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by orsmga004.jf.intel.com with ESMTP; 09 Feb 2023 17:42:35 -0800
Date:   Thu, 9 Feb 2023 17:52:18 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Vincent Guittot <vincent.guittot@linaro.org>
Cc:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
Message-ID: <20230210015218.GB6166@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
 <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Wed, Feb 08, 2023 at 08:56:32AM +0100, Vincent Guittot wrote:
> On Tue, 7 Feb 2023 at 05:50, Ricardo Neri
> <ricardo.neri-calderon@linux.intel.com> wrote:
> >
> > Using asym_packing priorities within an SMT core is straightforward. Just
> > follow the priorities that hardware indicates.
> >
> > When balancing load from an SMT core, also consider the idle of its
> > siblings. Priorities do not reflect that an SMT core divides its throughput
> > among all its busy siblings. They only makes sense when exactly one sibling
> > is busy.
> >
> > Indicate that active balance is needed if the destination CPU has lower
> > priority than the source CPU but the latter has busy SMT siblings.
> >
> > Make find_busiest_queue() not skip higher-priority SMT cores with more than
> > busy sibling.
> >
> > Cc: Ben Segall <bsegall@google.com>
> > Cc: Daniel Bristot de Oliveira <bristot@redhat.com>
> > Cc: Dietmar Eggemann <dietmar.eggemann@arm.com>
> > Cc: Len Brown <len.brown@intel.com>
> > Cc: Mel Gorman <mgorman@suse.de>
> > Cc: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
> > Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
> > Cc: Steven Rostedt <rostedt@goodmis.org>
> > Cc: Tim C. Chen <tim.c.chen@intel.com>
> > Cc: Valentin Schneider <vschneid@redhat.com>
> > Cc: x86@kernel.org
> > Cc: linux-kernel@vger.kernel.org
> > Suggested-by: Valentin Schneider <vschneid@redhat.com>
> > Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
> > ---
> > Changes since v2:
> >  * Introduced this patch.
> >
> > Changes since v1:
> >  * N/A
> > ---
> >  kernel/sched/fair.c | 31 ++++++++++++++++++++++++++-----
> >  1 file changed, 26 insertions(+), 5 deletions(-)
> >
> > diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
> > index 80c86462c6f6..c9d0ddfd11f2 100644
> > --- a/kernel/sched/fair.c
> > +++ b/kernel/sched/fair.c
> > @@ -10436,11 +10436,20 @@ static struct rq *find_busiest_queue(struct lb_env *env,
> >                     nr_running == 1)
> >                         continue;
> >
> > -               /* Make sure we only pull tasks from a CPU of lower priority */
> > +               /*
> > +                * Make sure we only pull tasks from a CPU of lower priority
> > +                * when balancing between SMT siblings.
> > +                *
> > +                * If balancing between cores, let lower priority CPUs help
> > +                * SMT cores with more than one busy sibling.
> > +                */
> >                 if ((env->sd->flags & SD_ASYM_PACKING) &&
> >                     sched_asym_prefer(i, env->dst_cpu) &&
> > -                   nr_running == 1)
> > -                       continue;
> > +                   nr_running == 1) {
> > +                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> > +                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
> 
> This 2nd if could be merged with the upper one
> --- a/kernel/sched/fair.c
> +++ b/kernel/sched/fair.c
> @@ -10518,11 +10518,10 @@ static struct rq *find_busiest_queue(struct
> lb_env *env,
>                  */
>                 if ((env->sd->flags & SD_ASYM_PACKING) &&
>                     sched_asym_prefer(i, env->dst_cpu) &&
> -                   nr_running == 1) {
> -                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> -                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY)
> && is_core_idle(i)))
> +                   (nr_running == 1) &&
> +                   (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> +                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY)
> && is_core_idle(i))))
>                                 continue;
> -               }
> 
>                 switch (env->migration_type) {
>                 case migrate_load:
> ---
> 
> AFAICT, you can even remove one env->sd->flags & SD_SHARE_CPUCAPACITY
> test with the below but this make the condition far less obvious
> 
> diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
> index a6021af9de11..7dfa30c45327 100644
> --- a/kernel/sched/fair.c
> +++ b/kernel/sched/fair.c
> @@ -10518,11 +10518,10 @@ static struct rq *find_busiest_queue(struct
> lb_env *env,
>                  */
>                 if ((env->sd->flags & SD_ASYM_PACKING) &&
>                     sched_asym_prefer(i, env->dst_cpu) &&
> -                   nr_running == 1) {
> -                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> -                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY)
> && is_core_idle(i)))
> +                   (nr_running == 1) &&
> +                   !(!(env->sd->flags & SD_SHARE_CPUCAPACITY) &&
> +                       !is_core_idle(i)))
>                                 continue;

I agree. This expression is equivalent to what I proposed. It is less
obvious but the comment above clarifies what is going on. I will take
your suggestion.

Thanks and BR,
Ricardo

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 53514C05027
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 03:06:59 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230087AbjBJDGz (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Feb 2023 22:06:55 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:51970 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229933AbjBJDGt (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Feb 2023 22:06:49 -0500
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3BCE95B83
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 19:06:46 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1675998407; x=1707534407;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:content-transfer-encoding:in-reply-to;
  bh=CJkMTgzIddNgRRg5mVzE1/GqVRRbH37QlNxA7GWPhDM=;
  b=Qt+TlrpPsUR1o5Bp6CDv9153TcOsui1iAy4fPTzeSXTRsYCa92pmwvtR
   RMB4jaoKI0bKz6Yq/xEoFzXuztisrnwGOETnZO1GlxJ3h41HZ0TAgAdb6
   RFHDwnCor9+v9/DifcQ37tP0ON/uRLy6ev7FNVzSaAAIKK5q2LCUyscZz
   yYOfhiTRNsczxWAElS66/Z7qBNRmJnB5SOESj3iJRl/enXl1Xw+QYx3p1
   AcgER8e7n8kBryctadoNTG2gDcGkeZZibme/+VZ+9uWjQBgs8J8QQee1L
   4RuJ55sZkmQVyqlUfghosmpGTkDq1ymABxqTRlatLKoKykKiM6lfv0Nw4
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="310687392"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="310687392"
Received: from fmsmga004.fm.intel.com ([10.253.24.48])
  by fmsmga107.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 19:06:46 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="736587573"
X-IronPort-AV: E=Sophos;i="5.97,285,1669104000"; 
   d="scan'208";a="736587573"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga004.fm.intel.com with ESMTP; 09 Feb 2023 19:06:45 -0800
Date:   Thu, 9 Feb 2023 19:16:29 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Tim Chen <tim.c.chen@linux.intel.com>
Cc:     "Chen, Tim C" <tim.c.chen@intel.com>,
        "Chen, Yu C" <yu.c.chen@intel.com>,
        "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        "Neri, Ricardo" <ricardo.neri@intel.com>,
        "Shankar, Ravi V" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        "Brown, Len" <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Wysocki, Rafael J" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>,
        "x86@kernel.org" <x86@kernel.org>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Message-ID: <20230210031629.GC6166@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+TyUZg86LYhtWeJ@chenyu5-mobl1>
 <DM6PR11MB4107F95164772B40B92F66A6DCD99@DM6PR11MB4107.namprd11.prod.outlook.com>
 <fb63369b2fc686730adefb6800eae4877e62e3b6.camel@linux.intel.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <fb63369b2fc686730adefb6800eae4877e62e3b6.camel@linux.intel.com>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Feb 09, 2023 at 03:05:03PM -0800, Tim Chen wrote:
> On Thu, 2023-02-09 at 20:00 +0000, Chen, Tim C wrote:
> > > > static inline void update_sd_lb_stats(struct lb_env *env, struct
> > > > sd_lb_stats *sds) {
> > > > -struct sched_domain *child = env->sd->child;
> > > > struct sched_group *sg = env->sd->groups;
> > > > struct sg_lb_stats *local = &sds->local_stat;
> > > > struct sg_lb_stats tmp_sgs;
> > > > @@ -10045,9 +10044,11 @@ static inline void
> > > > update_sd_lb_stats(struct
> > > lb_env *env, struct sd_lb_stats *sd
> > > > sg = sg->next;
> > > > } while (sg != env->sd->groups);
> > > > 
> > > > -/* Tag domain that child domain prefers tasks go to
> > > > siblings first */
> > > > -sds->prefer_sibling = child && child->flags &
> > > > SD_PREFER_SIBLING;
> > > > -
> > > > +/*
> > > > + * Tag domain that @env::sd prefers to spread excess
> > > > tasks among
> > > > + * sibling sched groups.
> > > > + */
> > > > +sds->prefer_sibling = env->sd->flags & SD_PREFER_SIBLING;
> > > > 
> > > This does help fix the issue that non-SMT core fails to pull task
> > > from busy SMT-
> > > cores.
> > > And it also semantically changes the definination of prefer
> > > sibling. Do we also
> > > need to change this:
> > >  if ((sd->flags & SD_ASYM_CPUCAPACITY) && sd->child)
> > >  sd->child->flags &= ~SD_PREFER_SIBLING; might be:
> > >  if ((sd->flags & SD_ASYM_CPUCAPACITY))
> > >  sd->flags &= ~SD_PREFER_SIBLING;
> > > 
> > 
> > Yu,
> > 
> > I think you are talking about the code in sd_init() 
> > where SD_PREFER_SIBLING is first set
> > to "ON" and updated depending on SD_ASYM_CPUCAPACITY. The intention
> > of the code
> > is if there are cpus in the scheduler domain that have differing cpu
> > capacities,
> > we do not want to do spreading among the child groups in the sched
> > domain.
> > So the flag is turned off in the child group level and not the parent
> > level. But with your above
> > change, the parent's flag is turned off, leaving the child level flag
> > on. 
> > This moves the level where spreading happens (SD_PREFER_SIBLING on) 
> > up one level which is undesired (see table below).

But my patch moves the level at which we act on prefer_sibling: it now
checks the SD_PREFER_SIBLING flag at the current level, not its child.
Thus, removing SD_PREFER_SIBLING from a level with SD_ASYM_CPUCAPACITY
prevents spreading among CPUs of different CPU capacity, no?

Thanks and BR,
Ricardo

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 7D4ABC636D6
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 06:56:39 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231393AbjBJG4i (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 01:56:38 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40736 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231364AbjBJG43 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 01:56:29 -0500
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B07EF392BC
        for <linux-kernel@vger.kernel.org>; Thu,  9 Feb 2023 22:56:27 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676012187; x=1707548187;
  h=date:from:to:cc:subject:message-id:references:
   content-transfer-encoding:in-reply-to:mime-version;
  bh=5XQISiDBpLKNH4SfF5+kqhJN+3zjJNotdEb0zpfTkDQ=;
  b=GQJE2e0PbikC6ZAe8at5mqhqE3GuAfAVpC3lGuSR+jgJRo6H88ElXoC0
   SAPi2o53jPLSPqAORpu8rfN5OayL79X52khuuw8A25gDQt9ZFrpUdcLEl
   bewVspHcywRAijUonvPYwzgJ0x5R7dGUVg3Yzg8zC8u6aOO9uLpNP/DNB
   O6aoWoz6o7IojvV2jjzpzSGtCQ0TF108doi5CJQli8JguXk4iQsxWMxZk
   qkCpB5R5GCLyJpSmW/9kAP1r241Lav7uRhi8dQ9IWw3jYdT3/QJynZ80B
   i7g/DXc0pA7H8v5BJXG4OQXCtyGpWapPZDBPjWjdSALZisiFJQeCzDZse
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="309984069"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="309984069"
Received: from orsmga003.jf.intel.com ([10.7.209.27])
  by fmsmga106.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 09 Feb 2023 22:56:27 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="617793716"
X-IronPort-AV: E=Sophos;i="5.97,286,1669104000"; 
   d="scan'208";a="617793716"
Received: from orsmsx603.amr.corp.intel.com ([10.22.229.16])
  by orsmga003.jf.intel.com with ESMTP; 09 Feb 2023 22:56:26 -0800
Received: from fmsmsx603.amr.corp.intel.com (10.18.126.83) by
 ORSMSX603.amr.corp.intel.com (10.22.229.16) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 22:56:26 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx603.amr.corp.intel.com (10.18.126.83) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 22:56:22 -0800
Received: from fmsmsx610.amr.corp.intel.com (10.18.126.90) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16; Thu, 9 Feb 2023 22:56:20 -0800
Received: from fmsedg602.ED.cps.intel.com (10.1.192.136) by
 fmsmsx610.amr.corp.intel.com (10.18.126.90) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2507.16 via Frontend Transport; Thu, 9 Feb 2023 22:56:20 -0800
Received: from NAM02-SN1-obe.outbound.protection.outlook.com (104.47.57.43) by
 edgegateway.intel.com (192.55.55.71) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.1.2507.16; Thu, 9 Feb 2023 22:56:20 -0800
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=bN31Vn7bMoZL0bxyIRdr9/z9lsWthP8zrJ8vqdy8gVqf10183627KV25kfrYruGT1eG87c4K8bKC5VkhTYLIkO6c2IeMA8bqGiZMLiDfrvFEr8yjD8CInigrXlbr2hADXDZoPXP6vA4BsX8QJCxCUVJrXejdRWLK+wXIJRzITAZ98HxwQSR6Bqk+rSrHTrx/ppNUbsTVaMqwY/sk273aerwloW4qeDhodRCga+eP/l7hQW/ZhzfQP0tAQ1P4FzDGiis0anY2CT66JNW+Lm5qZBKICvEKjcs6Jt200UJxd8fZW+wHvvuKjkQUfJGuzrdmt6p46bx96Fmo4u1TZkrtSA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-AntiSpam-MessageData-ChunkCount:X-MS-Exchange-AntiSpam-MessageData-0:X-MS-Exchange-AntiSpam-MessageData-1;
 bh=nPooCpK3jUzeVqSXMwmtwQOSms4i4abZ/VqXg9CqBVc=;
 b=A+qHaqVJuxUjl49u1OT8L+GxoMfiWXSvg0yYiYr/dbw5HmYQk6lUIJo8owcXH1ayvdc922hK+7ZQqQUBNb7nI34UFy3sDhKoW29zDpdoD3zBgdFbrG9NGSM01S6+bTPqZ6QyQyO1OqqtLnhxfVluKGQupT98ctjwtQD6HromKR90x+7J2ualVkQT8WZNE6S/rdxhNicw/H9GV1kv6pqZVA1WHcPki6hOK8i7tlaDPisqCf7ftrJiIVi69czNC5lAoxzjt81a1inF+4/+pBd7tCJjgs7Nag+205RnX6XMedjOlkUt8CZCF52bVD0RMdf0dkuyl7SD8d/yEO2rzmx5lw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=intel.com; dmarc=pass action=none header.from=intel.com;
 dkim=pass header.d=intel.com; arc=none
Authentication-Results: dkim=none (message not signed)
 header.d=none;dmarc=none action=none header.from=intel.com;
Received: from MN0PR11MB6206.namprd11.prod.outlook.com (2603:10b6:208:3c6::8)
 by CY8PR11MB7688.namprd11.prod.outlook.com (2603:10b6:930:75::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.6086.21; Fri, 10 Feb
 2023 06:56:18 +0000
Received: from MN0PR11MB6206.namprd11.prod.outlook.com
 ([fe80::cd83:248f:1c9b:c9d]) by MN0PR11MB6206.namprd11.prod.outlook.com
 ([fe80::cd83:248f:1c9b:c9d%7]) with mapi id 15.20.6086.019; Fri, 10 Feb 2023
 06:56:18 +0000
Date:   Fri, 10 Feb 2023 14:55:57 +0800
From:   Chen Yu <yu.c.chen@intel.com>
To:     Tim Chen <tim.c.chen@linux.intel.com>
CC:     "Chen, Tim C" <tim.c.chen@intel.com>,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        "Neri, Ricardo" <ricardo.neri@intel.com>,
        "Shankar, Ravi V" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        "Brown, Len" <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Wysocki, Rafael J" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>,
        "x86@kernel.org" <x86@kernel.org>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Message-ID: <Y+XqfXVHyqrv1/Ae@chenyu5-mobl1>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+TyUZg86LYhtWeJ@chenyu5-mobl1>
 <DM6PR11MB4107F95164772B40B92F66A6DCD99@DM6PR11MB4107.namprd11.prod.outlook.com>
 <fb63369b2fc686730adefb6800eae4877e62e3b6.camel@linux.intel.com>
Content-Type: text/plain; charset="iso-8859-1"
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <fb63369b2fc686730adefb6800eae4877e62e3b6.camel@linux.intel.com>
X-ClientProxiedBy: SG2P153CA0011.APCP153.PROD.OUTLOOK.COM (2603:1096::21) To
 MN0PR11MB6206.namprd11.prod.outlook.com (2603:10b6:208:3c6::8)
MIME-Version: 1.0
X-MS-PublicTrafficType: Email
X-MS-TrafficTypeDiagnostic: MN0PR11MB6206:EE_|CY8PR11MB7688:EE_
X-MS-Office365-Filtering-Correlation-Id: 6f80d89c-4b5a-4036-568c-08db0b33e865
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: k9DC0QeOGsNz0K54KKm5krDQK3KTIqK6X1+ymcZJLC51qFeSnNyMTCutFvoOC3M3vkgwfc74qpbGzmMyXgMpg/N6P5nB4L+4GeqEjptXIQ+lXiWr94cb5UrfpvU1jGhmh6MMi17qXccOR2a6Yjj7GzumtaZce8qx3+9Ds+0ujBTF/t8N3POYHj3rZKuaJCVbvYm/wBBxmMkA+shi4F5SMAurgYK1TXs1MmZJ2c6GABXE6I+wdPaPO+6VAAUkeFEfq+ZzdW3c+rpcm6SKwIl+BmTxHSYxIG8PV6ip9NH/F7Vtqb9bEKXR6zPBsc4EroKF+wuJF5/NcL92HTs7vxf7Hyny7+YdRdFlsHNHvI08sMwhvWJg00ciBsldvPZBvEXTIbtl4ZiYrmAxrVqHGhuplMmWQ73pnF2tOo5mcRjt3d56mWutS4Zuo2ne//2jTFSlOdTUbRqd6pC7Tp6OdpayPYbvz4FiqX9iiiLlQds4K17Kn4WMoDh0VvsYpVt/3d3t9FvkCWqZrf58EDGk5yQYbdAutca8LE9itf3SZ0g/2xGF6BotwxTzj6EXVy4BajIKEsqrzSMgpNvIOovuLdNs+Q7XBtw1Rlrk5lUHzaaHqzvywBzYEHNaqTQRTVeiXgdG7HduxRbNas0hfxroTq8Y1w==
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:MN0PR11MB6206.namprd11.prod.outlook.com;PTR:;CAT:NONE;SFS:(13230025)(7916004)(39860400002)(346002)(136003)(366004)(376002)(396003)(451199018)(6486002)(478600001)(54906003)(316002)(2906002)(4326008)(66476007)(8676002)(66556008)(6916009)(66946007)(41300700001)(6666004)(6506007)(8936002)(186003)(6512007)(9686003)(7416002)(26005)(5660300002)(53546011)(38100700002)(83380400001)(82960400001)(33716001)(86362001);DIR:OUT;SFP:1102;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?iso-8859-1?Q?3L5tdx467ADPTfw0zotRMCfN3lmw5lrDgn/XflgvhT5vIxYbPpioHi+n7X?=
 =?iso-8859-1?Q?qFAVICzsmie3504GLYjPkOCbWQFWn7/YbdBLfHdVr5Iphsar/CtTZZtT26?=
 =?iso-8859-1?Q?SdnIM0YmhQtleHNSM7ueYN+g3WqyQ+TfTRFpc3tmZYha2Kr06sk2/cyjRG?=
 =?iso-8859-1?Q?1eD3igBCARlFDpcUmG2ffyzd1/h5u5IfcrlIn/1qvejKtvwMrnx71w2yYx?=
 =?iso-8859-1?Q?hiU7sX1jXbSPHjvgSVEimbRva3grmnccF6EfZa51cpvS9szv1x8GlRRt6A?=
 =?iso-8859-1?Q?XHULWDJWFrBlMTmNf1Rv049B1yjMgN+M8LP7d5KYvKzoVdroFFbkuS3cB8?=
 =?iso-8859-1?Q?W1rFivr9Q8fArz1p6yw4NJpzHdiMOelxU3En1gBuHW+O7vT3WZPd7QwQt4?=
 =?iso-8859-1?Q?KTAmYjqOLh/CqcVQKNKdNYrvpQIupjT7T+3GM/87OT0oKowX32XTfgT3Nq?=
 =?iso-8859-1?Q?xpI54OeUJs9cWDAZKBlEb0EHjqc0lAsj5+UWAjsZ9kQjvR84KNVjqKsvar?=
 =?iso-8859-1?Q?HnoybV8kPJHX8MaKtHKYKBep5Sby5YZt31UNx7W9REI03eARS7RKBfsIrv?=
 =?iso-8859-1?Q?PBf2/FXgcYFqsnjA0AAGLPK3Hzbod/SyhqKr1AGh7y0utHkYLMO9HBPSHc?=
 =?iso-8859-1?Q?9GHC8WvLXdQIS8t4yCeCc3Yil3g2F+8OL2PBUtjnT3u1YpSAL7tsIop7gD?=
 =?iso-8859-1?Q?VAoloDx+YjqocQt3hWGjwRB8GXtqlD682crviJ8Kj4OCZLg8x2JYyxd1Kj?=
 =?iso-8859-1?Q?rmOC9uj1MHF7QW7F2otkvBekdMDa+xr6D8TdbE3pycp77TUBC9HlVOHwRI?=
 =?iso-8859-1?Q?Lbv1et1/z/eUY4d6a8pMUF+4JKMv/Om5V74m4r2PhHUQdCTi8VlCbvh8em?=
 =?iso-8859-1?Q?7h2qkD8lWTMjuYFcJmvwXgdfzB4S3Y74xDgu/gjAk6uBcVZSHZ9HjHGmsd?=
 =?iso-8859-1?Q?6hfkrRyTWABKEeBQYaITGcALbg4FCNEZTdhKZy2vrxMtuV1f0FqdMt/0jH?=
 =?iso-8859-1?Q?txZO7YrwKehfFPIXfvaqM3EN99GQKzKgMKtmlGMBXOObSFjd3+XNOERd/D?=
 =?iso-8859-1?Q?fCEmUipu1cyE7F6phRfYH9iXIumaS/w7aMiCiWKJ5zv2/gpc4keDbB9SUZ?=
 =?iso-8859-1?Q?Hz7xz6g+umLXONHsGoHkKwXnRnxHth8XBW9kBDazPNZKiejOEhaVuFWhST?=
 =?iso-8859-1?Q?Jj58IHSgxNjWs4XAvPUiug1Iv/GJGEvMLL53qem4jpoV4hbfiI5NsOGZQL?=
 =?iso-8859-1?Q?9MTgxTGrfGFo0nIsPh2Vi3kCQ/OgaMT4MZhX8VA0UMwm1584B/8CYQ3uB1?=
 =?iso-8859-1?Q?VB5JKa34Zf4Y6CkwDpTZ3bN7TO5dB80jsowJnwnzHG66lq9nTecVMs6B2r?=
 =?iso-8859-1?Q?1az61ninG2ZBkWnhEmC6ohfN1HU2Z/mFUbH0+1F6TBomm+R6lth1xf2UHw?=
 =?iso-8859-1?Q?gzQajkWNV6UTo1c0qQMLHyP6thTx6YwOfNX8NaZjS/q3YALXEazQnqanAL?=
 =?iso-8859-1?Q?+ONBKfU+cqHeP/rb/ZidF9JFnwoUqNBT2G4a3cQwtUT8wxY3NZrRWrUfRm?=
 =?iso-8859-1?Q?3vnMb/4HWHo9s7nhWZQUMRN78XR3+2gOYcq/mFFeJB7Y53uQ+ythc+x/ok?=
 =?iso-8859-1?Q?UHDGaxl8h9XBnT15UdB9OhIUY/dXf86nj6?=
X-MS-Exchange-CrossTenant-Network-Message-Id: 6f80d89c-4b5a-4036-568c-08db0b33e865
X-MS-Exchange-CrossTenant-AuthSource: MN0PR11MB6206.namprd11.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 10 Feb 2023 06:56:17.5124
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 46c98d88-e344-4ed4-8496-4ed7712e255d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: odIdToYfBeILZlVd95IKZAvnfGIsrMEWG+G+8wAsYdjksCia6ZXAGV/X5Bj7GqyeCCSVXeKfkQGJ4n7PeANXAQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CY8PR11MB7688
X-OriginatorOrg: intel.com
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 2023-02-09 at 15:05:03 -0800, Tim Chen wrote:
> On Thu, 2023-02-09 at 20:00 +0000, Chen, Tim C wrote:
> > > > static inline void update_sd_lb_stats(struct lb_env *env, struct
> > > > sd_lb_stats *sds) {
> > > > -struct sched_domain *child = env->sd->child;
> > > > struct sched_group *sg = env->sd->groups;
> > > > struct sg_lb_stats *local = &sds->local_stat;
> > > > struct sg_lb_stats tmp_sgs;
> > > > @@ -10045,9 +10044,11 @@ static inline void
> > > > update_sd_lb_stats(struct
> > > lb_env *env, struct sd_lb_stats *sd
> > > > sg = sg->next;
> > > > } while (sg != env->sd->groups);
> > > > 
> > > > -/* Tag domain that child domain prefers tasks go to
> > > > siblings first */
> > > > -sds->prefer_sibling = child && child->flags &
> > > > SD_PREFER_SIBLING;
> > > > -
> > > > +/*
> > > > + * Tag domain that @env::sd prefers to spread excess
> > > > tasks among
> > > > + * sibling sched groups.
> > > > + */
> > > > +sds->prefer_sibling = env->sd->flags & SD_PREFER_SIBLING;
> > > > 
> > > This does help fix the issue that non-SMT core fails to pull task
> > > from busy SMT-
> > > cores.
> > > And it also semantically changes the definination of prefer
> > > sibling. Do we also
> > > need to change this:
> > >  if ((sd->flags & SD_ASYM_CPUCAPACITY) && sd->child)
> > >  sd->child->flags &= ~SD_PREFER_SIBLING; might be:
> > >  if ((sd->flags & SD_ASYM_CPUCAPACITY))
> > >  sd->flags &= ~SD_PREFER_SIBLING;
> > > 
> > 
> > Yu,
> > 
> > I think you are talking about the code in sd_init() 
> > where SD_PREFER_SIBLING is first set
> > to "ON" and updated depending on SD_ASYM_CPUCAPACITY. The intention
> > of the code
> > is if there are cpus in the scheduler domain that have differing cpu
> > capacities,
> > we do not want to do spreading among the child groups in the sched
> > domain.
> > So the flag is turned off in the child group level and not the parent
> > level. But with your above
> > change, the parent's flag is turned off, leaving the child level flag
> > on. 
> > This moves the level where spreading happens (SD_PREFER_SIBLING on) 
> > up one level which is undesired (see table below).
> >
Yes, it moves the flag 1 level up. And if I understand correctly, with Ricardo's patch
applied, we have changed the original meaning of SD_PREFER_SIBLING:
Original: Tasks in this sched domain want to be migrated to another sched domain.
After init change: Tasks in the sched group under this sched domain want to
                   be migrated to a sibling group.
> > 
> Sorry got a bad mail client messing up the table format.  Updated below
> 
> 			SD_ASYM_CPUCAPACITY	SD_PREFER_SIBLING after init             
> 						original code 	proposed
> SD Level		 	 
> root			ON			ON		OFF      (note: SD_PREFER_SIBLING unused at this level)
SD_PREFER_SIBLING is hornored in root level after the init proposal.
> first level             ON			OFF		OFF
Before the init proposed, tasks in first level sd do not want
to be spreaded to a sibling sd. After the init proposeal, tasks
in all sched groups under root sd, do not want to be spreaded
to a sibling sched group(AKA first level sd)

thanks,
Chenyu
> second level		OFF			OFF		ON
> third level             OFF			ON		ON
> 
> Tim							

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 38275C636CD
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 08:41:49 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231538AbjBJIls (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 03:41:48 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43596 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231515AbjBJIlq (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 03:41:46 -0500
Received: from casper.infradead.org (casper.infradead.org [IPv6:2001:8b0:10b:1236::1])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 75C255D3EA
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 00:41:44 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=infradead.org; s=casper.20170209; h=In-Reply-To:Content-Type:MIME-Version:
        References:Message-ID:Subject:Cc:To:From:Date:Sender:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description;
        bh=khMnYDc7UOKzbX3CCDSAj+Wo4i4NAPcutmfg9CiymIE=; b=nLCfmHjeWTrPVt5mxMrFljm35K
        C1CfDOlR2U0qnY3a6JZLa8Liyq9JwItNQPVtUJE5neYZD4nU9UuY/vXlIXRQmgZi0e5bANWUeVQ7V
        QadqHXt7MImOlOwlCrpGZDB9Is0KXerOLbsVsxDPJCNvoQjTRcoyq5ikZbBMt+bweLl1wFlzKXYu0
        87kIqtOkoOenevkTJek4xufxQQnlUZePT+PSlFsjPHRNndOiXcVxxni10BICC40pawlw4mJHuMnL2
        Lnp3P/YtriqTcxfJHnuFDoTFAvPR/i5ShywQr7KNlH6eotNsB71mEA50mQWnwzHm7+OSA+UDKZPeX
        QvnQXcfw==;
Received: from j130084.upc-j.chello.nl ([24.132.130.84] helo=noisy.programming.kicks-ass.net)
        by casper.infradead.org with esmtpsa (Exim 4.94.2 #2 (Red Hat Linux))
        id 1pQOy7-002xRd-7y; Fri, 10 Feb 2023 08:41:19 +0000
Received: from hirez.programming.kicks-ass.net (hirez.programming.kicks-ass.net [192.168.1.225])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature RSA-PSS (4096 bits) server-digest SHA256)
        (Client did not present a certificate)
        by noisy.programming.kicks-ass.net (Postfix) with ESMTPS id 598043003E1;
        Fri, 10 Feb 2023 09:41:15 +0100 (CET)
Received: by hirez.programming.kicks-ass.net (Postfix, from userid 1000)
        id 0859B2061BB0F; Fri, 10 Feb 2023 09:41:15 +0100 (CET)
Date:   Fri, 10 Feb 2023 09:41:14 +0100
From:   Peter Zijlstra <peterz@infradead.org>
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Cc:     Vincent Guittot <vincent.guittot@linaro.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
Message-ID: <Y+YDKpHLDkYOTVWL@hirez.programming.kicks-ass.net>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
 <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
 <Y+TexehP3140vxBu@hirez.programming.kicks-ass.net>
 <20230210004333.GA6166@ranerica-svr.sc.intel.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20230210004333.GA6166@ranerica-svr.sc.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Feb 09, 2023 at 04:43:33PM -0800, Ricardo Neri wrote:
> On Thu, Feb 09, 2023 at 12:53:41PM +0100, Peter Zijlstra wrote:
> > On Wed, Feb 08, 2023 at 08:56:32AM +0100, Vincent Guittot wrote:
> > 
> > > > +                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> > > > +                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
> > > 
> > > This 2nd if could be merged with the upper one
> > 
> > Wasn't this exact same condition used in the previous patch as well?
> > Does it wants to be a helper perhaps?
> 
> Patch 3 focuses on the destination CPU: make sure that it and its SMT
> siblings are idle before attempting to do asym_packing balance.
> 
> This patch focuses on the busiest group: if the busiest group is an SMT
> core with more than one busy sibling, help it even if it has higher
> priority.

Yeah, so? If its a recurring expression a helper never hurts.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 49420C05027
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 10:09:13 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231821AbjBJKJL (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 05:09:11 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:57934 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231584AbjBJKJJ (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 05:09:09 -0500
Received: from casper.infradead.org (casper.infradead.org [IPv6:2001:8b0:10b:1236::1])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8BAA134F68
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 02:09:08 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=infradead.org; s=casper.20170209; h=In-Reply-To:Content-Type:MIME-Version:
        References:Message-ID:Subject:Cc:To:From:Date:Sender:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description;
        bh=17gnpumNvDg1uLOrdDtUU76XG/ciCpkL2co9kCLrSms=; b=cAmFY7/yTSDJxkKFKu4sBUS4NR
        N9CYH0kJddJPl7UIEkeR1dBiEZg6PQ455M7fQ1+G4zYwsgS3GGSBGIx9vqanGuiqSnWPqWAcdnq5i
        fpFoSK9Hz0nmgXCJJDIJIRf81ZSmqT0JuQqfSCti/4DQQsfwlgHIuCBekm9D+QSyKgdeTJG/gpkoc
        8zbO6q18Ox7+uwivej9956Ym2X9NO0JaRaUIv5xbNx6Dg5h1mY6XOdXmNKP5zWkg3XkJuSZ7JFwKC
        +5XrmZkn3nG3MiCTWB43Z7/VMzhy8tnloyXNt65ZCPXXGliXKFbEe196Mio0UNxW5gs4exteYjdQQ
        krz6oXKA==;
Received: from j130084.upc-j.chello.nl ([24.132.130.84] helo=noisy.programming.kicks-ass.net)
        by casper.infradead.org with esmtpsa (Exim 4.94.2 #2 (Red Hat Linux))
        id 1pQQKl-0030lO-U5; Fri, 10 Feb 2023 10:08:48 +0000
Received: from hirez.programming.kicks-ass.net (hirez.programming.kicks-ass.net [192.168.1.225])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature RSA-PSS (4096 bits))
        (Client did not present a certificate)
        by noisy.programming.kicks-ass.net (Postfix) with ESMTPS id 0376030012F;
        Fri, 10 Feb 2023 11:08:46 +0100 (CET)
Received: by hirez.programming.kicks-ass.net (Postfix, from userid 1000)
        id B5F5520A1CFBA; Fri, 10 Feb 2023 11:08:46 +0100 (CET)
Date:   Fri, 10 Feb 2023 11:08:46 +0100
From:   Peter Zijlstra <peterz@infradead.org>
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Cc:     Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Message-ID: <Y+YXrk5NRuWaSOGR@hirez.programming.kicks-ass.net>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Mon, Feb 06, 2023 at 08:58:34PM -0800, Ricardo Neri wrote:
> SD_PREFER_SIBLING is set from the SMT scheduling domain up to the first
> non-NUMA domain (the exception is systems with SD_ASYM_CPUCAPACITY).
> 
> Above the SMT sched domain, all domains have a child. The SD_PREFER_
> SIBLING is honored always regardless of the scheduling domain at which the
> load balance takes place.
> 
> There are cases, however, in which the busiest CPU's sched domain has
> child but the destination CPU's does not. Consider, for instance a non-SMT
> core (or an SMT core with only one online sibling) doing load balance with
> an SMT core at the MC level. SD_PREFER_SIBLING will not be honored. We are
> left with a fully busy SMT core and an idle non-SMT core.
> 
> Avoid inconsistent behavior. Use the prefer_sibling behavior at the current
> scheduling domain, not its child.
> 
> The NUMA sched domain does not have the SD_PREFER_SIBLING flag. Thus, we
> will not spread load among NUMA sched groups, as desired.
> 

Like many of the others; I don't much like this.

Why not simply detect this asymmetric having of SMT and kill the
PREFER_SIBLING flag on the SMT leafs in that case?

Specifically, I'm thinking something in the degenerate area where it
looks if a given domain has equal depth children or so.

Note that this should not be tied to having special hardware, you can
create the very same weirdness by just offlining a few SMT siblings and
leaving a few on.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 147C3C05027
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 12:56:17 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231961AbjBJM4P (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 07:56:15 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:34470 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231727AbjBJM4N (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 07:56:13 -0500
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6C3946BD17
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 04:56:12 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676033772; x=1707569772;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=Y8zxgGCwhMDmV7vaqtoKzlagEvVdPgNTwWyjOM6v9qo=;
  b=UyoQIRsWYM/b2Rxjuw33GNcKJPzsz4X4npvmRVgvAGMHDjAq1VXNbYJe
   5YM8ytKZh5Puma/UY/fohfn1+Zpd/2rNjiSke5FvnzfaUo13quPE3c8hj
   Nac51WlTXhIVQV/AhxeiEVooorVyeQn2UPkoW3y93um9zi9FS2crn7RW5
   EvfAEgdWP2UX8wOrPzmut78mxm/cpmU8+jH8HHmOnQ3tuq3NTuUZbXAPx
   mIKxaz36Glz+n16G+Pl08PrfqgfIlDGtfGnGOHd97V6ClBU4V/AkmuHQ2
   3mobb+AxhRywyK19DIWyT/3kNkef1yHLTyPUVK79plsFFj2u5ZfcU15G6
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="329043683"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="329043683"
Received: from fmsmga002.fm.intel.com ([10.253.24.26])
  by fmsmga104.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 04:56:12 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="776913014"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="776913014"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga002.fm.intel.com with ESMTP; 10 Feb 2023 04:56:11 -0800
Date:   Fri, 10 Feb 2023 05:05:56 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Peter Zijlstra <peterz@infradead.org>
Cc:     Vincent Guittot <vincent.guittot@linaro.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
Message-ID: <20230210130556.GA8447@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
 <CAKfTPtB_YR8e6fcx3Un0vTeJR4EJS9sOXG=wLb8rZeM5Ub4yyA@mail.gmail.com>
 <Y+TexehP3140vxBu@hirez.programming.kicks-ass.net>
 <20230210004333.GA6166@ranerica-svr.sc.intel.com>
 <Y+YDKpHLDkYOTVWL@hirez.programming.kicks-ass.net>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <Y+YDKpHLDkYOTVWL@hirez.programming.kicks-ass.net>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Fri, Feb 10, 2023 at 09:41:14AM +0100, Peter Zijlstra wrote:
> On Thu, Feb 09, 2023 at 04:43:33PM -0800, Ricardo Neri wrote:
> > On Thu, Feb 09, 2023 at 12:53:41PM +0100, Peter Zijlstra wrote:
> > > On Wed, Feb 08, 2023 at 08:56:32AM +0100, Vincent Guittot wrote:
> > > 
> > > > > +                       if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> > > > > +                           (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
> > > > 
> > > > This 2nd if could be merged with the upper one
> > > 
> > > Wasn't this exact same condition used in the previous patch as well?
> > > Does it wants to be a helper perhaps?
> > 
> > Patch 3 focuses on the destination CPU: make sure that it and its SMT
> > siblings are idle before attempting to do asym_packing balance.
> > 
> > This patch focuses on the busiest group: if the busiest group is an SMT
> > core with more than one busy sibling, help it even if it has higher
> > priority.
> 
> Yeah, so? If its a recurring expression a helper never hurts.

Ah! I get your point now. You meant a helper function. Thank you for the
clarification.

Sure! I can add this helper function.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DCF33C636CD
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 13:14:24 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232098AbjBJNOX (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 08:14:23 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43946 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231540AbjBJNOV (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 08:14:21 -0500
Received: from mga09.intel.com (mga09.intel.com [134.134.136.24])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 69464DBD0
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 05:14:20 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676034860; x=1707570860;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=S1u5cEUA0nsv74LxPw292hCootzDxlWOkqMDRRkLa2o=;
  b=eF2AB07JtlRqgLpFNA8s7lkhai5pxzpEFBeIpi8UbY6P9SioHmOEmpHT
   tk1TsCY2AEKDIAiQDym+c54G5pb+xp65I9f6r5B5TvRYe/O+1VapuwLai
   A0yEUc1cDvZbgRHkoe1KJP+a77yiFzaSiZmuYAYdDhJjpnIeQ8qSdIIkt
   1yjftuDk4o9z2JPQFGsVq9tVbuHt1u915U1EvxXiYc1Eb8DNCV0cP+PzM
   q4+4zy/g+PgenUguKO76fE6Uq07b2PMiQOTEu1yWdNvnfEKPo0AoxTWIr
   Hb2zNUdF40NX5ZKhWzM0L1yNxhytueziWpP9oEj5biFZ5ihSPUL7NMSyL
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="331722280"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="331722280"
Received: from fmsmga005.fm.intel.com ([10.253.24.32])
  by orsmga102.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 05:14:19 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10616"; a="996955218"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="996955218"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga005.fm.intel.com with ESMTP; 10 Feb 2023 05:14:19 -0800
Date:   Fri, 10 Feb 2023 05:24:04 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Vincent Guittot <vincent.guittot@linaro.org>
Cc:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Message-ID: <20230210132404.GB8447@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <CAKfTPtAZ8sfDi1GbKSioJkszkRT6f+am5OSjKKKKv2q_4FKQFQ@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAKfTPtAZ8sfDi1GbKSioJkszkRT6f+am5OSjKKKKv2q_4FKQFQ@mail.gmail.com>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Wed, Feb 08, 2023 at 08:48:05AM +0100, Vincent Guittot wrote:
> On Tue, 7 Feb 2023 at 05:50, Ricardo Neri
> <ricardo.neri-calderon@linux.intel.com> wrote:
> >
> > SD_PREFER_SIBLING is set from the SMT scheduling domain up to the first
> > non-NUMA domain (the exception is systems with SD_ASYM_CPUCAPACITY).
> >
> > Above the SMT sched domain, all domains have a child. The SD_PREFER_
> > SIBLING is honored always regardless of the scheduling domain at which the
> > load balance takes place.
> >
> > There are cases, however, in which the busiest CPU's sched domain has
> > child but the destination CPU's does not. Consider, for instance a non-SMT
> > core (or an SMT core with only one online sibling) doing load balance with
> > an SMT core at the MC level. SD_PREFER_SIBLING will not be honored. We are
> > left with a fully busy SMT core and an idle non-SMT core.
> >
> > Avoid inconsistent behavior. Use the prefer_sibling behavior at the current
> > scheduling domain, not its child.
> >
> > The NUMA sched domain does not have the SD_PREFER_SIBLING flag. Thus, we
> > will not spread load among NUMA sched groups, as desired.
> 
> This is a significant change in the behavior of the numa system. It
> would be good to get figures or confirmation that demonstrate that
> it's ok to remove prefer_sibling behavior at the 1st numa level.
> 
Thank you very much for your feedback Vincent!

You are right. It does change the behavior at the first numa level. Peter
did not like this change either. It also made things confusing for
SD_ASYM_CPUCAPACITY vs SD_PREFER_SIBLING.

I'll work in a different approach.

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 95F75C636CD
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 14:55:51 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232427AbjBJOzu (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 09:55:50 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:47976 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231882AbjBJOzs (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 09:55:48 -0500
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.133.124])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AD3B26C7C1
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 06:55:03 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1676040902;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=8Ckzaa96MQzkpgEFh6wXwi8nzrk686ctY0YwJBmPzA4=;
        b=efUn5mKkSuaG3sgdaajQ7MjQR9+ltdxlqsuJrs8CcA+YOx9949/4nEdH62k6PUrEzdx8Sn
        bQBaz7Ov+3NPIn8DbdTUofXVobWaxNFjB+jHjbNtIBHC1WMXUZhPbha9JT5oJUAANxZY2M
        EndlYjRbLYmW1/RcnVc9d8q8UizM+hI=
Received: from mail-qv1-f69.google.com (mail-qv1-f69.google.com
 [209.85.219.69]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_128_GCM_SHA256) id
 us-mta-460-usrfqotgPuK7k7CAxxhteg-1; Fri, 10 Feb 2023 09:55:00 -0500
X-MC-Unique: usrfqotgPuK7k7CAxxhteg-1
Received: by mail-qv1-f69.google.com with SMTP id ib5-20020a0562141c8500b0053c23b938a0so3246341qvb.17
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 06:55:00 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=mime-version:message-id:date:references:in-reply-to:subject:cc:to
         :from:x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=8Ckzaa96MQzkpgEFh6wXwi8nzrk686ctY0YwJBmPzA4=;
        b=fypqwPWjhxfo3Ewln44HH0eG5K9yr5/oInnA7UaTam0JYNtqnrgDX+g3JUJhGjJvyq
         vvUtqG9L0WuqUqip5zQZD3OEUjTIFLfJfPnTgPh18V8ZEVkLvZzhmzoFEaSl0rWQnbor
         OXWr3Xs0ZlXqlHpuQ5yM+VQkqJHM5JVC+2GpB/x+ryvT8Bm35zs8pFj0MkEE7NXiPuya
         RxfXoABTB11zZFCOk/bVjl6HWbpYKgk4iCxFpYueRMUsWNy9IyxYO6ad4CmrF7F7sBoh
         JWaalGN+iFcmLG6vQ11fRzms2IVxXoGV+APN4Gr4MCN9tYGD+Q9UWqw4KRiIlv0lhNol
         dZnw==
X-Gm-Message-State: AO0yUKVBfPUekgB+c7UYhRp5PsEFX0V5xJLRJk3qZbsx9ddUX0mHfteZ
        id57CmJ74e8g4Yp8L2UA3hb5zLs5MgxjhbLyTy/dYPqn3r54bPTjd/Olt9W5cwKfhTEreM5iHkh
        w7i89wNUGZf+bUXiFyudorj8W
X-Received: by 2002:a05:622a:146:b0:3b9:b43e:5733 with SMTP id v6-20020a05622a014600b003b9b43e5733mr26222596qtw.61.1676040900184;
        Fri, 10 Feb 2023 06:55:00 -0800 (PST)
X-Google-Smtp-Source: AK7set9kjy0cA8dQn5RLtBgGL/jLZtONQgPcJhBhstbwfh2fA3ZsfqffcBvZc4QRFyIQwQ9LV9FQRQ==
X-Received: by 2002:a05:622a:146:b0:3b9:b43e:5733 with SMTP id v6-20020a05622a014600b003b9b43e5733mr26222570qtw.61.1676040899952;
        Fri, 10 Feb 2023 06:54:59 -0800 (PST)
Received: from vschneid.remote.csb ([154.57.232.159])
        by smtp.gmail.com with ESMTPSA id u63-20020a379242000000b00731c30ac2e8sm3673397qkd.74.2023.02.10.06.54.57
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Fri, 10 Feb 2023 06:54:59 -0800 (PST)
From:   Valentin Schneider <vschneid@redhat.com>
To:     Peter Zijlstra <peterz@infradead.org>,
        Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Cc:     Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
In-Reply-To: <Y+YXrk5NRuWaSOGR@hirez.programming.kicks-ass.net>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+YXrk5NRuWaSOGR@hirez.programming.kicks-ass.net>
Date:   Fri, 10 Feb 2023 14:54:56 +0000
Message-ID: <xhsmhmt5lr2nz.mognet@vschneid.remote.csb>
MIME-Version: 1.0
Content-Type: text/plain
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 10/02/23 11:08, Peter Zijlstra wrote:
> On Mon, Feb 06, 2023 at 08:58:34PM -0800, Ricardo Neri wrote:
>> SD_PREFER_SIBLING is set from the SMT scheduling domain up to the first
>> non-NUMA domain (the exception is systems with SD_ASYM_CPUCAPACITY).
>>
>> Above the SMT sched domain, all domains have a child. The SD_PREFER_
>> SIBLING is honored always regardless of the scheduling domain at which the
>> load balance takes place.
>>
>> There are cases, however, in which the busiest CPU's sched domain has
>> child but the destination CPU's does not. Consider, for instance a non-SMT
>> core (or an SMT core with only one online sibling) doing load balance with
>> an SMT core at the MC level. SD_PREFER_SIBLING will not be honored. We are
>> left with a fully busy SMT core and an idle non-SMT core.
>>
>> Avoid inconsistent behavior. Use the prefer_sibling behavior at the current
>> scheduling domain, not its child.
>>
>> The NUMA sched domain does not have the SD_PREFER_SIBLING flag. Thus, we
>> will not spread load among NUMA sched groups, as desired.
>>
>
> Like many of the others; I don't much like this.
>
> Why not simply detect this asymmetric having of SMT and kill the
> PREFER_SIBLING flag on the SMT leafs in that case?
>
> Specifically, I'm thinking something in the degenerate area where it
> looks if a given domain has equal depth children or so.
>
> Note that this should not be tied to having special hardware, you can
> create the very same weirdness by just offlining a few SMT siblings and
> leaving a few on.

So something like have SD_PREFER_SIBLING affect the SD it's on (and not
its parent), but remove it from the lowest non-degenerated topology level?
(+ add it to the first NUMA level to keep things as they are, even if TBF I
find relying on it for NUMA balancing a bit odd).


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 77840C636CD
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 16:53:32 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232887AbjBJQxb (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 11:53:31 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33950 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232229AbjBJQx3 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 11:53:29 -0500
Received: from casper.infradead.org (casper.infradead.org [IPv6:2001:8b0:10b:1236::1])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 98BC03D08B
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 08:53:27 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=infradead.org; s=casper.20170209; h=In-Reply-To:Content-Type:MIME-Version:
        References:Message-ID:Subject:Cc:To:From:Date:Sender:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description;
        bh=5N8u3zp9JP7/GZvcqq1Y75dqon3aYejvtXyCnTSCHrw=; b=hiMbvg2evcfj0kEFtdL5vQuznp
        6xgeaiU5SvVLJfk4Qq2fEXUgYh2RcPFbFYAWfBTbDi+kN6fzDueUZfucJUJRRnaZ1A3dWkg7grZYh
        Y9cIQk7POoakQWpudpktuaQeRhPDSVaqFpCqkxvI1d14NgcAzIIxnjLRZwkEudlBLud32U6/lb5xM
        OCWzVUjUA7aLxIINJR5eBIYMrFRDk/GuaxyyoL0jcbrTK+49cC/sADhGk0S7D1LxdlYWBop1eT3Jq
        nYcr7bZ7cgI1y+KAaNzbcbFyLDhc2Dp0dR2atH9cQTQvGoj05wEzeuBi3x6VDrXn2Dum66CH58Aud
        3dhWlamQ==;
Received: from j130084.upc-j.chello.nl ([24.132.130.84] helo=noisy.programming.kicks-ass.net)
        by casper.infradead.org with esmtpsa (Exim 4.94.2 #2 (Red Hat Linux))
        id 1pQWe0-003HDc-Sb; Fri, 10 Feb 2023 16:53:05 +0000
Received: from hirez.programming.kicks-ass.net (hirez.programming.kicks-ass.net [192.168.1.225])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature RSA-PSS (4096 bits) server-digest SHA256)
        (Client did not present a certificate)
        by noisy.programming.kicks-ass.net (Postfix) with ESMTPS id DB2BB3001CE;
        Fri, 10 Feb 2023 17:53:03 +0100 (CET)
Received: by hirez.programming.kicks-ass.net (Postfix, from userid 1000)
        id B73A42042B9C1; Fri, 10 Feb 2023 17:53:03 +0100 (CET)
Date:   Fri, 10 Feb 2023 17:53:03 +0100
From:   Peter Zijlstra <peterz@infradead.org>
To:     Valentin Schneider <vschneid@redhat.com>
Cc:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Message-ID: <Y+Z2b/OtZDk9cT53@hirez.programming.kicks-ass.net>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+YXrk5NRuWaSOGR@hirez.programming.kicks-ass.net>
 <xhsmhmt5lr2nz.mognet@vschneid.remote.csb>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <xhsmhmt5lr2nz.mognet@vschneid.remote.csb>
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Fri, Feb 10, 2023 at 02:54:56PM +0000, Valentin Schneider wrote:

> So something like have SD_PREFER_SIBLING affect the SD it's on (and not
> its parent), but remove it from the lowest non-degenerated topology level?

So I was rather confused about the whole moving it between levels things
this morning -- conceptually, prefer siblings says you want to try
sibling domains before filling up your current domain. Now, balancing
between siblings happens one level up, hence looking at child->flags
makes perfect sense.

But looking at the current domain and still calling it prefer sibling
makes absolutely no sense what so ever.

In that confusion I think I also got the polarity wrong, I thought you
wanted to kill prefer_sibling for the assymetric SMT cases, instead you
want to force enable it as long as there is one SMT child around.

Whichever way around it we do it, I'm thinking perhaps some renaming
might be in order to clarify things.

How about adding a flag SD_SPREAD_TASKS, which is the effective toggle
of the behaviour, but have it be set by children with SD_PREFER_SIBLING
or something.

OTOH, there's also

  if (busiest->group_weight == 1 || sds->prefer_sibling) {

which explicitly also takes the group-of-one (the !child case) into
account, but that's not consistently done.

	sds->prefer_sibling = !child || child->flags & SD_PREFER_SIBLING;

seems an interesting option, except perhaps ASYM_CPUCAPACITY -- I
forget, can CPUs of different capacity be in the same leaf domain? With
big.LITTLE I think not, they had their own cache domains and so you get
at least MC domains per capacity, but DynamiQ might have totally wrecked
that party.

> (+ add it to the first NUMA level to keep things as they are, even if TBF I
> find relying on it for NUMA balancing a bit odd).

Arguably it ought to perhaps be one of those node_reclaim_distance
things. The thing is that NUMA-1 is often fairly quick, esp. these days
where it's basically on die numa.


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 46DCAC05027
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 17:14:29 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232900AbjBJRO1 (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 12:14:27 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:57060 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232942AbjBJROU (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 12:14:20 -0500
Received: from us-smtp-delivery-124.mimecast.com (us-smtp-delivery-124.mimecast.com [170.10.133.124])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 0878F7A7D5
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 09:13:06 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1676049158;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=u7luEvPkWujB4zxIctqB6JQjV0VaIW6RHVMIPA6fiA0=;
        b=K0twe8UhqrtThlfyGAD8IqGPPpv9nZb92aXSAs6SZCTC2Cz2GagEcZrTc0OLPJrR7BnSxG
        Ea4e022pioO3XaOy8q9daHeAg/c38YhZcc5saigQKsAUOw6YIlbFi0kdluhzMHyq+QElyM
        OTMpgbNRJQ+nEXEtw898z2wuswqGNJw=
Received: from mail-qv1-f70.google.com (mail-qv1-f70.google.com
 [209.85.219.70]) by relay.mimecast.com with ESMTP with STARTTLS
 (version=TLSv1.3, cipher=TLS_AES_128_GCM_SHA256) id
 us-mta-546-4_r_uK7POF-xaOcQuBQwLw-1; Fri, 10 Feb 2023 12:12:35 -0500
X-MC-Unique: 4_r_uK7POF-xaOcQuBQwLw-1
Received: by mail-qv1-f70.google.com with SMTP id k15-20020a0cd68f000000b00535261af1b1so3514829qvi.13
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 09:12:35 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=mime-version:message-id:date:references:in-reply-to:subject:cc:to
         :from:x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=u7luEvPkWujB4zxIctqB6JQjV0VaIW6RHVMIPA6fiA0=;
        b=AUKGRZ4xx+0Cjk03Z18nPiklmSXpuI+TgmwjizuevTs9egy+TJrlibvvJbL85C8g47
         he4T1MIY7IftqrMoytCe4ngzKCmb9uyr5+cwu8E117eTtEA/IyXoc7Oyd2dGop2aNVmg
         mAimzYp8r3zAIPFhVkdTntCyNXCEy6PCQ2HW1z1DetkZSIvH1U9L2+QEi3sLE1HGoTI8
         o6ADFerpCYoqlErn9bKfAp3PpQII5Vc65VWYY9SojUdCP5691MpG0OFWiEYNrEGsaHOa
         bJvFnUYuXBsssyELl6JpDuxbkCe2Lmjs9dNGLtkKKmsT/zZCYvpiK8PK7JfyNQqu2Mov
         d9YQ==
X-Gm-Message-State: AO0yUKV2tTr8Q0GaaDQBKbyR3sn0aGEm7IkoJf9hjwsIoAhJeZDhDEhJ
        ZjO7e7LFiIDQUY6oYjqMnWjIvCaERJ/IjqgenyKqZpgq3T7KBCbo/Psr+n7wtX0s+2yZ1m7KC6m
        U+0VkT8FcsslvRppMf7TVCEH+
X-Received: by 2002:ac8:57cf:0:b0:3b8:6d70:9fe2 with SMTP id w15-20020ac857cf000000b003b86d709fe2mr26088247qta.59.1676049155020;
        Fri, 10 Feb 2023 09:12:35 -0800 (PST)
X-Google-Smtp-Source: AK7set/hGJjfilDSZ6ODVxm0G+j3wuLje3k02Br3xakiSXYhkJnMSdauBcAOS4vSSs3xZWyEsWvqxg==
X-Received: by 2002:ac8:57cf:0:b0:3b8:6d70:9fe2 with SMTP id w15-20020ac857cf000000b003b86d709fe2mr26088213qta.59.1676049154756;
        Fri, 10 Feb 2023 09:12:34 -0800 (PST)
Received: from vschneid.remote.csb ([154.57.232.159])
        by smtp.gmail.com with ESMTPSA id x12-20020ac8700c000000b003b0766cd169sm3769157qtm.2.2023.02.10.09.12.31
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Fri, 10 Feb 2023 09:12:33 -0800 (PST)
From:   Valentin Schneider <vschneid@redhat.com>
To:     Peter Zijlstra <peterz@infradead.org>
Cc:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
In-Reply-To: <Y+Z2b/OtZDk9cT53@hirez.programming.kicks-ass.net>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+YXrk5NRuWaSOGR@hirez.programming.kicks-ass.net>
 <xhsmhmt5lr2nz.mognet@vschneid.remote.csb>
 <Y+Z2b/OtZDk9cT53@hirez.programming.kicks-ass.net>
Date:   Fri, 10 Feb 2023 17:12:30 +0000
Message-ID: <xhsmhk00pqwap.mognet@vschneid.remote.csb>
MIME-Version: 1.0
Content-Type: text/plain
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 10/02/23 17:53, Peter Zijlstra wrote:
> On Fri, Feb 10, 2023 at 02:54:56PM +0000, Valentin Schneider wrote:
>
>> So something like have SD_PREFER_SIBLING affect the SD it's on (and not
>> its parent), but remove it from the lowest non-degenerated topology level?
>
> So I was rather confused about the whole moving it between levels things
> this morning -- conceptually, prefer siblings says you want to try
> sibling domains before filling up your current domain. Now, balancing
> between siblings happens one level up, hence looking at child->flags
> makes perfect sense.
>
> But looking at the current domain and still calling it prefer sibling
> makes absolutely no sense what so ever.
>

True :-)

> In that confusion I think I also got the polarity wrong, I thought you
> wanted to kill prefer_sibling for the assymetric SMT cases, instead you
> want to force enable it as long as there is one SMT child around.
>
> Whichever way around it we do it, I'm thinking perhaps some renaming
> might be in order to clarify things.
>
> How about adding a flag SD_SPREAD_TASKS, which is the effective toggle
> of the behaviour, but have it be set by children with SD_PREFER_SIBLING
> or something.
>

Or entirely bin SD_PREFER_SIBLING and stick with SD_SPREAD_TASKS, but yeah
something along those lines.

> OTOH, there's also
>
>   if (busiest->group_weight == 1 || sds->prefer_sibling) {
>
> which explicitly also takes the group-of-one (the !child case) into
> account, but that's not consistently done.
>
>       sds->prefer_sibling = !child || child->flags & SD_PREFER_SIBLING;
>
> seems an interesting option,

> except perhaps ASYM_CPUCAPACITY -- I
> forget, can CPUs of different capacity be in the same leaf domain? With
> big.LITTLE I think not, they had their own cache domains and so you get
> at least MC domains per capacity, but DynamiQ might have totally wrecked
> that party.

Yeah, newer systems can have different capacities in one MC domain, cf:

  b7a331615d25 ("sched/fair: Add asymmetric CPU capacity wakeup scan")

>
>> (+ add it to the first NUMA level to keep things as they are, even if TBF I
>> find relying on it for NUMA balancing a bit odd).
>
> Arguably it ought to perhaps be one of those node_reclaim_distance
> things. The thing is that NUMA-1 is often fairly quick, esp. these days
> where it's basically on die numa.

Right, makes sense, thanks.


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 40A08C05027
	for <linux-kernel@archiver.kernel.org>; Fri, 10 Feb 2023 18:22:15 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232936AbjBJSWO (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Fri, 10 Feb 2023 13:22:14 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:47858 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232697AbjBJSWM (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 Feb 2023 13:22:12 -0500
Received: from mga06.intel.com (mga06b.intel.com [134.134.136.31])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4B66B61D15
        for <linux-kernel@vger.kernel.org>; Fri, 10 Feb 2023 10:22:11 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676053331; x=1707589331;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=JnABS4bzuUOo3oZdGDN/S3N14HFWtHaPR9HjHLG9mC4=;
  b=RNF29cgDewxOJb5l9emiaB4BUlTbrWNfgzhWaC1JnG1k+3vbK9cHBOwk
   t2m0cfgvFrwDFRUXAOlJgm+b/5TIqIki98Mg5dpwXEEttqHIQw0+pQqH7
   v2VOD+WsJYwAdYMUjal+Ulmn3D0Mz/Bts2Ue7PbAumKQnn6gtjkS/z2PB
   ekPiAsU9Fh1njZOszOJoSiPtJvWJSw4kThyVeJ/jP21jBhorQMDYGKPVL
   I9/F16q7P6T3QgmC/mM1JNc4o6xpSO5d8CvbwS7kMdEPP9WLdwvt4H1Sn
   dXrQFyu237eDgsmQjPP24Z2NmB8TcFc3cIobWmDOEGfQZC3jFOQrTAvUi
   g==;
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="392895704"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="392895704"
Received: from fmsmga001.fm.intel.com ([10.253.24.23])
  by orsmga104.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 10 Feb 2023 10:22:10 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10617"; a="810906179"
X-IronPort-AV: E=Sophos;i="5.97,287,1669104000"; 
   d="scan'208";a="810906179"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga001.fm.intel.com with ESMTP; 10 Feb 2023 10:22:09 -0800
Date:   Fri, 10 Feb 2023 10:31:55 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Valentin Schneider <vschneid@redhat.com>
Cc:     Peter Zijlstra <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Dietmar Eggemann <dietmar.eggemann@arm.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Message-ID: <20230210183155.GA11997@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+YXrk5NRuWaSOGR@hirez.programming.kicks-ass.net>
 <xhsmhmt5lr2nz.mognet@vschneid.remote.csb>
 <Y+Z2b/OtZDk9cT53@hirez.programming.kicks-ass.net>
 <xhsmhk00pqwap.mognet@vschneid.remote.csb>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <xhsmhk00pqwap.mognet@vschneid.remote.csb>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Fri, Feb 10, 2023 at 05:12:30PM +0000, Valentin Schneider wrote:
> On 10/02/23 17:53, Peter Zijlstra wrote:
> > On Fri, Feb 10, 2023 at 02:54:56PM +0000, Valentin Schneider wrote:
> >
> >> So something like have SD_PREFER_SIBLING affect the SD it's on (and not
> >> its parent), but remove it from the lowest non-degenerated topology level?
> >
> > So I was rather confused about the whole moving it between levels things
> > this morning -- conceptually, prefer siblings says you want to try
> > sibling domains before filling up your current domain. Now, balancing
> > between siblings happens one level up, hence looking at child->flags
> > makes perfect sense.
> >
> > But looking at the current domain and still calling it prefer sibling
> > makes absolutely no sense what so ever.
> >
> 
> True :-)
> 
> > In that confusion I think I also got the polarity wrong, I thought you
> > wanted to kill prefer_sibling for the assymetric SMT cases, instead you
> > want to force enable it as long as there is one SMT child around.

Exactly.

> >
> > Whichever way around it we do it, I'm thinking perhaps some renaming
> > might be in order to clarify things.
> >
> > How about adding a flag SD_SPREAD_TASKS, which is the effective toggle
> > of the behaviour, but have it be set by children with SD_PREFER_SIBLING
> > or something.
> >
> 
> Or entirely bin SD_PREFER_SIBLING and stick with SD_SPREAD_TASKS, but yeah
> something along those lines.

I sense a consesus towards SD_SPREAD_TASKS.

> 
> > OTOH, there's also
> >
> >   if (busiest->group_weight == 1 || sds->prefer_sibling) {
> >
> > which explicitly also takes the group-of-one (the !child case) into
> > account, but that's not consistently done.
> >
> >       sds->prefer_sibling = !child || child->flags & SD_PREFER_SIBLING;

This would need a special provision for SD_ASYM_CPUCAPACITY.

> >
> > seems an interesting option,
> 
> > except perhaps ASYM_CPUCAPACITY -- I
> > forget, can CPUs of different capacity be in the same leaf domain? With
> > big.LITTLE I think not, they had their own cache domains and so you get
> > at least MC domains per capacity, but DynamiQ might have totally wrecked
> > that party.
> 
> Yeah, newer systems can have different capacities in one MC domain, cf:
> 
>   b7a331615d25 ("sched/fair: Add asymmetric CPU capacity wakeup scan")
> 
> >
> >> (+ add it to the first NUMA level to keep things as they are, even if TBF I
> >> find relying on it for NUMA balancing a bit odd).
> >
> > Arguably it ought to perhaps be one of those node_reclaim_distance
> > things. The thing is that NUMA-1 is often fairly quick, esp. these days
> > where it's basically on die numa.

To conserve the current behavior the NUMA level would need to have
SD_SPREAD_TASKS. It will be cleared along with SD_BALANCE_{EXEC, FORK} and
SD_WAKE_AFFINE if the numa distance is larger than node_reclaim_distance,
yes?

Thanks and BR,
Ricardo

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A6B7AC636D4
	for <linux-kernel@archiver.kernel.org>; Mon, 13 Feb 2023 12:17:40 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230130AbjBMMRj (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 13 Feb 2023 07:17:39 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33518 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229747AbjBMMRg (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 13 Feb 2023 07:17:36 -0500
Received: from foss.arm.com (foss.arm.com [217.140.110.172])
        by lindbergh.monkeyblade.net (Postfix) with ESMTP id 8687244B7
        for <linux-kernel@vger.kernel.org>; Mon, 13 Feb 2023 04:17:23 -0800 (PST)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
        by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id CFFDB4B3;
        Mon, 13 Feb 2023 04:18:05 -0800 (PST)
Received: from [192.168.178.6] (unknown [172.31.20.19])
        by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id 724193F703;
        Mon, 13 Feb 2023 04:17:19 -0800 (PST)
Message-ID: <8300f288-7157-5e2d-3bb3-badcffd15d34@arm.com>
Date:   Mon, 13 Feb 2023 13:17:09 +0100
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Thunderbird/102.4.2
Subject: Re: [PATCH v3 06/10] sched/fair: Use the prefer_sibling flag of the
 current sched domain
Content-Language: en-US
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>
Cc:     Peter Zijlstra <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-7-ricardo.neri-calderon@linux.intel.com>
 <Y+YXrk5NRuWaSOGR@hirez.programming.kicks-ass.net>
 <xhsmhmt5lr2nz.mognet@vschneid.remote.csb>
 <Y+Z2b/OtZDk9cT53@hirez.programming.kicks-ass.net>
 <xhsmhk00pqwap.mognet@vschneid.remote.csb>
 <20230210183155.GA11997@ranerica-svr.sc.intel.com>
From:   Dietmar Eggemann <dietmar.eggemann@arm.com>
In-Reply-To: <20230210183155.GA11997@ranerica-svr.sc.intel.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 10/02/2023 19:31, Ricardo Neri wrote:
> On Fri, Feb 10, 2023 at 05:12:30PM +0000, Valentin Schneider wrote:
>> On 10/02/23 17:53, Peter Zijlstra wrote:
>>> On Fri, Feb 10, 2023 at 02:54:56PM +0000, Valentin Schneider wrote:
>>>
>>>> So something like have SD_PREFER_SIBLING affect the SD it's on (and not
>>>> its parent), but remove it from the lowest non-degenerated topology level?
>>>
>>> So I was rather confused about the whole moving it between levels things
>>> this morning -- conceptually, prefer siblings says you want to try
>>> sibling domains before filling up your current domain. Now, balancing
>>> between siblings happens one level up, hence looking at child->flags
>>> makes perfect sense.
>>>
>>> But looking at the current domain and still calling it prefer sibling
>>> makes absolutely no sense what so ever.
>>>
>>
>> True :-)
>>
>>> In that confusion I think I also got the polarity wrong, I thought you
>>> wanted to kill prefer_sibling for the assymetric SMT cases, instead you
>>> want to force enable it as long as there is one SMT child around.
> 
> Exactly.
> 
>>>
>>> Whichever way around it we do it, I'm thinking perhaps some renaming
>>> might be in order to clarify things.
>>>
>>> How about adding a flag SD_SPREAD_TASKS, which is the effective toggle
>>> of the behaviour, but have it be set by children with SD_PREFER_SIBLING
>>> or something.
>>>
>>
>> Or entirely bin SD_PREFER_SIBLING and stick with SD_SPREAD_TASKS, but yeah
>> something along those lines.
> 
> I sense a consesus towards SD_SPREAD_TASKS.

Can you not detect the E-core dst_cpu case on MC with:

+       if (child)
+               sds->prefer_sibling = child->flags & SD_PREFER_SIBLING;
+       else if (sds->busiest)
+               sds->prefer_sibling = sds->busiest->group_weight > 1;
+

[...]

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8541AC636D4
	for <linux-kernel@archiver.kernel.org>; Mon, 13 Feb 2023 12:44:38 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230362AbjBMMoh (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 13 Feb 2023 07:44:37 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:57324 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230050AbjBMMof (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 13 Feb 2023 07:44:35 -0500
Received: from foss.arm.com (foss.arm.com [217.140.110.172])
        by lindbergh.monkeyblade.net (Postfix) with ESMTP id 790BD5FE6
        for <linux-kernel@vger.kernel.org>; Mon, 13 Feb 2023 04:44:34 -0800 (PST)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
        by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id C703C4B3;
        Mon, 13 Feb 2023 04:45:16 -0800 (PST)
Received: from [192.168.178.6] (unknown [172.31.20.19])
        by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id BBAE83F703;
        Mon, 13 Feb 2023 04:44:29 -0800 (PST)
Message-ID: <f8a75f47-0f7e-14cc-adf4-2854e235b26e@arm.com>
Date:   Mon, 13 Feb 2023 13:44:20 +0100
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Thunderbird/102.4.2
Subject: Re: [PATCH v3 07/10] sched/fair: Do not even the number of busy CPUs
 via asym_packing
Content-Language: en-US
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-8-ricardo.neri-calderon@linux.intel.com>
From:   Dietmar Eggemann <dietmar.eggemann@arm.com>
In-Reply-To: <20230207045838.11243-8-ricardo.neri-calderon@linux.intel.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 07/02/2023 05:58, Ricardo Neri wrote:

[...]

> @@ -9269,33 +9264,11 @@ static bool asym_smt_can_pull_tasks(int dst_cpu, struct sd_lb_stats *sds,
>  				    struct sched_group *sg)
>  {
>  #ifdef CONFIG_SCHED_SMT
> -	bool local_is_smt;
>  	int sg_busy_cpus;
>  
> -	local_is_smt = sds->local->flags & SD_SHARE_CPUCAPACITY;
>  	sg_busy_cpus = sgs->group_weight - sgs->idle_cpus;
>  
> -	if (!local_is_smt) {
> -		/*
> -		 * If we are here, @dst_cpu is idle and does not have SMT
> -		 * siblings. Pull tasks if candidate group has two or more
> -		 * busy CPUs.
> -		 */
> -		if (sg_busy_cpus >= 2) /* implies sg_is_smt */
> -			return true;
> -
> -		/*
> -		 * @dst_cpu does not have SMT siblings. @sg may have SMT
> -		 * siblings and only one is busy. In such case, @dst_cpu
> -		 * can help if it has higher priority and is idle (i.e.,
> -		 * it has no running tasks).
> -		 */
> -		return sched_asym_prefer(dst_cpu, sg->asym_prefer_cpu);
> -	}
> -
>  	/*
> -	 * @dst_cpu has SMT siblings and are also idle.
> -	 *
>  	 * If the difference in the number of busy CPUs is two or more, let
>  	 * find_busiest_group() take care of it. We only care if @sg has
>  	 * exactly one busy CPU. This covers SMT and non-SMT sched groups.

Can't this be made lighter by removing asym_smt_can_pull_tasks() and
putting the logic to exclude the call to sched_asym_prefer() into
sched_asym() directly?
Not sure if we need the CONFIG_SCHED_SMT since it's all guarded by
`flags & SD_SHARE_CPUCAPACITY` already, which is only set under.
CONFIG_SCHED_SMT.

static inline bool
sched_asym(struct lb_env *env, struct sd_lb_stats *sds,
           struct sg_lb_stats *sgs, struct sched_group *group)
{
        bool local_is_smt = sds->local->flags & SD_SHARE_CPUCAPACITY;

        if (local_is_smt && !is_core_idle(env->dst_cpu))
                return false;

        if ((local_is_smt || group->flags & SD_SHARE_CPUCAPACITY)) {
                int sg_busy_cpus = sgs->group_weight - sgs->idle_cpus;

                if (sg_busy_cpus != 1)
                        return false;
        }

        return sched_asym_prefer(env->dst_cpu, group->asym_prefer_cpu);
}

[...]




















From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1DA3BC636CC
	for <linux-kernel@archiver.kernel.org>; Mon, 13 Feb 2023 13:40:45 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230281AbjBMNko (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 13 Feb 2023 08:40:44 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:45444 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229715AbjBMNkl (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 13 Feb 2023 08:40:41 -0500
Received: from foss.arm.com (foss.arm.com [217.140.110.172])
        by lindbergh.monkeyblade.net (Postfix) with ESMTP id 5D84E7EDE
        for <linux-kernel@vger.kernel.org>; Mon, 13 Feb 2023 05:40:40 -0800 (PST)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
        by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 80D494B3;
        Mon, 13 Feb 2023 05:41:22 -0800 (PST)
Received: from [192.168.178.6] (unknown [172.31.20.19])
        by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id 7A2C93F881;
        Mon, 13 Feb 2023 05:40:36 -0800 (PST)
Message-ID: <3a41995b-c39c-7346-e04b-7f13433b51c2@arm.com>
Date:   Mon, 13 Feb 2023 14:40:24 +0100
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101
 Thunderbird/102.4.2
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
Content-Language: en-US
To:     Ricardo Neri <ricardo.neri-calderon@linux.intel.com>,
        "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>
Cc:     Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
From:   Dietmar Eggemann <dietmar.eggemann@arm.com>
In-Reply-To: <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 07/02/2023 05:58, Ricardo Neri wrote:

[...]

> diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
> index 80c86462c6f6..c9d0ddfd11f2 100644
> --- a/kernel/sched/fair.c
> +++ b/kernel/sched/fair.c
> @@ -10436,11 +10436,20 @@ static struct rq *find_busiest_queue(struct lb_env *env,
>  		    nr_running == 1)
>  			continue;
>  
> -		/* Make sure we only pull tasks from a CPU of lower priority */
> +		/*
> +		 * Make sure we only pull tasks from a CPU of lower priority
> +		 * when balancing between SMT siblings.
> +		 *
> +		 * If balancing between cores, let lower priority CPUs help
> +		 * SMT cores with more than one busy sibling.
> +		 */
>  		if ((env->sd->flags & SD_ASYM_PACKING) &&
>  		    sched_asym_prefer(i, env->dst_cpu) &&
> -		    nr_running == 1)
> -			continue;
> +		    nr_running == 1) {
> +			if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> +			    (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
> +				continue;

is_core_idle(i) returns true for !CONFIG_SCHED_SMP. So far it was always
guarded by `flags & SD_SHARE_CPUCAPACITY` which is only set for
CONFIG_SCHED_SMP.

Here it's different but still depends on `flags & SD_ASYM_PACKING`.

Can we have SD_ASYM_PACKING w/o CONFIG_SCHED_SMP? The comment just says
`If balancing between cores (MC), let lower priority CPUs help SMT cores
with more than one busy sibling.`

So this only mentions your specific asymmetric e-cores w/o SMT and
p-cores w/ SMT case.

I'm asking since numa_idle_core(), the only user of is_core_idle() so
far has an extra `!static_branch_likely(&sched_smt_present)` condition
before calling it.

> +		}
>  
>  		switch (env->migration_type) {
>  		case migrate_load:
> @@ -10530,8 +10539,20 @@ asym_active_balance(struct lb_env *env)
>  	 * lower priority CPUs in order to pack all tasks in the
>  	 * highest priority CPUs.
>  	 */
> -	return env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING) &&
> -	       sched_asym_prefer(env->dst_cpu, env->src_cpu);
> +	if (env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING)) {
> +		/* Always obey priorities between SMT siblings. */
> +		if (env->sd->flags & SD_SHARE_CPUCAPACITY)
> +			return sched_asym_prefer(env->dst_cpu, env->src_cpu);
> +
> +		/*
> +		 * A lower priority CPU can help an SMT core with more than one
> +		 * busy sibling.
> +		 */
> +		return sched_asym_prefer(env->dst_cpu, env->src_cpu) ||
> +		       !is_core_idle(env->src_cpu);

Here it is similar.

> +	}
> +
> +	return false;


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8D457C636CC
	for <linux-kernel@archiver.kernel.org>; Mon, 13 Feb 2023 19:37:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230179AbjBMThx (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 13 Feb 2023 14:37:53 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38604 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230209AbjBMThu (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 13 Feb 2023 14:37:50 -0500
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 46CBD2722
        for <linux-kernel@vger.kernel.org>; Mon, 13 Feb 2023 11:37:49 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676317069; x=1707853069;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=4yuMrxSozOviRS8funTjR25MXp+HMcPbifIVi7/PCyI=;
  b=ibeme3fS4jK8lIrVMnFG4i2pLfjbpUJR0+Hh8wxZabLvmifI8qtRcYyQ
   KeX9Wp4cH+LiUk53+ZxO3FuF/dnCnLI/7DXDjsWSA9fr0c/TDtbFAMLaP
   oSf47mlcaC5csuHXxhxJpR6G98xsTg44fFvCHZ1dFjTsgTfHlXRdXe8Dv
   oGDXYXmw2fQvBGdfmWrGyxETGQSnfcGXlveEiKMDkXsrl8jDCzWxX0ArK
   pSBue0IaOkRfOMxfPcR8QxBknKaR0yGf3vBMLct/uWKj7JZ8bYSaPY74X
   wMTmk/9oRNU5CfJYrYtmVajw/8C61yKvQQMJWtmS4AEbSTdKtYe2XnW53
   A==;
X-IronPort-AV: E=McAfee;i="6500,9779,10620"; a="319005700"
X-IronPort-AV: E=Sophos;i="5.97,294,1669104000"; 
   d="scan'208";a="319005700"
Received: from fmsmga008.fm.intel.com ([10.253.24.58])
  by orsmga101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 13 Feb 2023 11:37:48 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10620"; a="732608348"
X-IronPort-AV: E=Sophos;i="5.97,294,1669104000"; 
   d="scan'208";a="732608348"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by fmsmga008.fm.intel.com with ESMTP; 13 Feb 2023 11:37:48 -0800
Date:   Mon, 13 Feb 2023 11:47:40 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 07/10] sched/fair: Do not even the number of busy CPUs
 via asym_packing
Message-ID: <20230213194740.GA6164@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-8-ricardo.neri-calderon@linux.intel.com>
 <f8a75f47-0f7e-14cc-adf4-2854e235b26e@arm.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <f8a75f47-0f7e-14cc-adf4-2854e235b26e@arm.com>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Mon, Feb 13, 2023 at 01:44:20PM +0100, Dietmar Eggemann wrote:
> On 07/02/2023 05:58, Ricardo Neri wrote:
> 
> [...]
> 
> > @@ -9269,33 +9264,11 @@ static bool asym_smt_can_pull_tasks(int dst_cpu, struct sd_lb_stats *sds,
> >  				    struct sched_group *sg)
> >  {
> >  #ifdef CONFIG_SCHED_SMT
> > -	bool local_is_smt;
> >  	int sg_busy_cpus;
> >  
> > -	local_is_smt = sds->local->flags & SD_SHARE_CPUCAPACITY;
> >  	sg_busy_cpus = sgs->group_weight - sgs->idle_cpus;
> >  
> > -	if (!local_is_smt) {
> > -		/*
> > -		 * If we are here, @dst_cpu is idle and does not have SMT
> > -		 * siblings. Pull tasks if candidate group has two or more
> > -		 * busy CPUs.
> > -		 */
> > -		if (sg_busy_cpus >= 2) /* implies sg_is_smt */
> > -			return true;
> > -
> > -		/*
> > -		 * @dst_cpu does not have SMT siblings. @sg may have SMT
> > -		 * siblings and only one is busy. In such case, @dst_cpu
> > -		 * can help if it has higher priority and is idle (i.e.,
> > -		 * it has no running tasks).
> > -		 */
> > -		return sched_asym_prefer(dst_cpu, sg->asym_prefer_cpu);
> > -	}
> > -
> >  	/*
> > -	 * @dst_cpu has SMT siblings and are also idle.
> > -	 *
> >  	 * If the difference in the number of busy CPUs is two or more, let
> >  	 * find_busiest_group() take care of it. We only care if @sg has
> >  	 * exactly one busy CPU. This covers SMT and non-SMT sched groups.
> 
> Can't this be made lighter by removing asym_smt_can_pull_tasks() and
> putting the logic to exclude the call to sched_asym_prefer() into
> sched_asym() directly?

Yes, you are right. asym_smt_can_pull_tasks() was simplified significantly.
I'll take your suggestion.

> Not sure if we need the CONFIG_SCHED_SMT since it's all guarded by
> `flags & SD_SHARE_CPUCAPACITY` already, which is only set under.
> CONFIG_SCHED_SMT.

Yes, asym_smt_can_pull_tasks() now cares for a very specific case, which
only happens with CONFIG_SCHED_SMT. I'll remove the !CONFIG_SCHED_SMT part.
> 
> static inline bool
> sched_asym(struct lb_env *env, struct sd_lb_stats *sds,
>            struct sg_lb_stats *sgs, struct sched_group *group)
> {
>         bool local_is_smt = sds->local->flags & SD_SHARE_CPUCAPACITY;
> 
>         if (local_is_smt && !is_core_idle(env->dst_cpu))
>                 return false;
> 
>         if ((local_is_smt || group->flags & SD_SHARE_CPUCAPACITY)) {
>                 int sg_busy_cpus = sgs->group_weight - sgs->idle_cpus;
> 
>                 if (sg_busy_cpus != 1)
>                         return false;
>         }
> 
>         return sched_asym_prefer(env->dst_cpu, group->asym_prefer_cpu);

I'll take your suggestion. Thanks!

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0DBDEC636D4
	for <linux-kernel@archiver.kernel.org>; Mon, 13 Feb 2023 23:13:40 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230070AbjBMXNi (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Mon, 13 Feb 2023 18:13:38 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:58046 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229545AbjBMXNf (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 13 Feb 2023 18:13:35 -0500
Received: from mga01.intel.com (mga01.intel.com [192.55.52.88])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id F169C1EFEF
        for <linux-kernel@vger.kernel.org>; Mon, 13 Feb 2023 15:13:32 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
  d=intel.com; i=@intel.com; q=dns/txt; s=Intel;
  t=1676330012; x=1707866012;
  h=date:from:to:cc:subject:message-id:references:
   mime-version:in-reply-to;
  bh=6tvq+BOuk38zeNN0hmdoPLf3V+BGZZvkpvGaQlGVS0I=;
  b=TCO37ct3v6IJA+u3c+XwTYZc8knuueT9vD8ckJE0hNqNLAUh3fuZcyzQ
   Auz+t7F4SFwjU4Hya0rExT+Fn5o5YvML6Xj0PKUNFm8C4K+JQRr7F1r3e
   rLarj7ZJEM0F726CuPUQ14AilonMiuDyZtoDBprXcA9i6YdKcPOWboEnS
   dAxv7RWr9rqyI1g3HD4bGJrO/Qxa/CwU7Y2Mzq4iX2nAPfTkMn3a+RSyC
   /Z3i78agG9MHx3O4br3iU2mlSdPHKx7yAv2h+Fn9ga1qFXWzsN9f3pt4H
   h+iq/WmRzPELDYPmikZJ30ka2O0CjBYu5qH12WyISAIPKmye7s4mPBBJ2
   Q==;
X-IronPort-AV: E=McAfee;i="6500,9779,10620"; a="358429440"
X-IronPort-AV: E=Sophos;i="5.97,294,1669104000"; 
   d="scan'208";a="358429440"
Received: from orsmga002.jf.intel.com ([10.7.209.21])
  by fmsmga101.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 13 Feb 2023 15:13:32 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=McAfee;i="6500,9779,10620"; a="668956882"
X-IronPort-AV: E=Sophos;i="5.97,294,1669104000"; 
   d="scan'208";a="668956882"
Received: from ranerica-svr.sc.intel.com ([172.25.110.23])
  by orsmga002.jf.intel.com with ESMTP; 13 Feb 2023 15:13:31 -0800
Date:   Mon, 13 Feb 2023 15:23:24 -0800
From:   Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
To:     Dietmar Eggemann <dietmar.eggemann@arm.com>
Cc:     "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Vincent Guittot <vincent.guittot@linaro.org>,
        Ricardo Neri <ricardo.neri@intel.com>,
        "Ravi V. Shankar" <ravi.v.shankar@intel.com>,
        Ben Segall <bsegall@google.com>,
        Daniel Bristot de Oliveira <bristot@redhat.com>,
        Len Brown <len.brown@intel.com>, Mel Gorman <mgorman@suse.de>,
        "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>,
        Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>,
        Steven Rostedt <rostedt@goodmis.org>,
        Tim Chen <tim.c.chen@linux.intel.com>,
        Valentin Schneider <vschneid@redhat.com>,
        Ionela Voinescu <ionela.voinescu@arm.com>, x86@kernel.org,
        linux-kernel@vger.kernel.org, "Tim C . Chen" <tim.c.chen@intel.com>
Subject: Re: [PATCH v3 04/10] sched/fair: Let low-priority cores help
 high-priority busy SMT cores
Message-ID: <20230213232324.GB6164@ranerica-svr.sc.intel.com>
References: <20230207045838.11243-1-ricardo.neri-calderon@linux.intel.com>
 <20230207045838.11243-5-ricardo.neri-calderon@linux.intel.com>
 <3a41995b-c39c-7346-e04b-7f13433b51c2@arm.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <3a41995b-c39c-7346-e04b-7f13433b51c2@arm.com>
User-Agent: Mutt/1.9.4 (2018-02-28)
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Mon, Feb 13, 2023 at 02:40:24PM +0100, Dietmar Eggemann wrote:
> On 07/02/2023 05:58, Ricardo Neri wrote:
> 
> [...]
> 
> > diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
> > index 80c86462c6f6..c9d0ddfd11f2 100644
> > --- a/kernel/sched/fair.c
> > +++ b/kernel/sched/fair.c
> > @@ -10436,11 +10436,20 @@ static struct rq *find_busiest_queue(struct lb_env *env,
> >  		    nr_running == 1)
> >  			continue;
> >  
> > -		/* Make sure we only pull tasks from a CPU of lower priority */
> > +		/*
> > +		 * Make sure we only pull tasks from a CPU of lower priority
> > +		 * when balancing between SMT siblings.
> > +		 *
> > +		 * If balancing between cores, let lower priority CPUs help
> > +		 * SMT cores with more than one busy sibling.
> > +		 */
> >  		if ((env->sd->flags & SD_ASYM_PACKING) &&
> >  		    sched_asym_prefer(i, env->dst_cpu) &&
> > -		    nr_running == 1)
> > -			continue;
> > +		    nr_running == 1) {
> > +			if (env->sd->flags & SD_SHARE_CPUCAPACITY ||
> > +			    (!(env->sd->flags & SD_SHARE_CPUCAPACITY) && is_core_idle(i)))
> > +				continue;
> 
> is_core_idle(i) returns true for !CONFIG_SCHED_SMP. So far it was always
> guarded by `flags & SD_SHARE_CPUCAPACITY` which is only set for
> CONFIG_SCHED_SMP.
> 
> Here it's different but still depends on `flags & SD_ASYM_PACKING`.
> 
> Can we have SD_ASYM_PACKING w/o CONFIG_SCHED_SMP? The comment just says
> `If balancing between cores (MC), let lower priority CPUs help SMT cores
> with more than one busy sibling.`

We cannot have SD_ASYM_PACKING w/o CONFIG_SCHED_SMP. We may have it without
CONFIG_SCHED_SMT. In the latter case we want is_core_idle() to return true
as there are no SMT siblings competing for core throughput and CPU priority 
is meaningful. I can add an extra comment clarifying the !CONFIG_SCHED_SMT /

> 
> So this only mentions your specific asymmetric e-cores w/o SMT and
> p-cores w/ SMT case.
> 
> I'm asking since numa_idle_core(), the only user of is_core_idle() so
> far has an extra `!static_branch_likely(&sched_smt_present)` condition
> before calling it.

That is a good point. Calling is_core_idle() is pointless if
!static_branch_likely(&sched_smt_present).

As per feedback from Vincent and Peter, I have put this logic in a helper
function. I'll add an extra check for this static key.

> 
> > +		}
> >  
> >  		switch (env->migration_type) {
> >  		case migrate_load:
> > @@ -10530,8 +10539,20 @@ asym_active_balance(struct lb_env *env)
> >  	 * lower priority CPUs in order to pack all tasks in the
> >  	 * highest priority CPUs.
> >  	 */
> > -	return env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING) &&
> > -	       sched_asym_prefer(env->dst_cpu, env->src_cpu);
> > +	if (env->idle != CPU_NOT_IDLE && (env->sd->flags & SD_ASYM_PACKING)) {
> > +		/* Always obey priorities between SMT siblings. */
> > +		if (env->sd->flags & SD_SHARE_CPUCAPACITY)
> > +			return sched_asym_prefer(env->dst_cpu, env->src_cpu);
> > +
> > +		/*
> > +		 * A lower priority CPU can help an SMT core with more than one
> > +		 * busy sibling.
> > +		 */
> > +		return sched_asym_prefer(env->dst_cpu, env->src_cpu) ||
> > +		       !is_core_idle(env->src_cpu);
> 
> Here it is similar.

I will use my helper function here as well.

Thanks and BR,
Ricardo

